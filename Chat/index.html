<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ¬∑ Emotional Continuity Reactor ¬∑ v1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ===== Base Layout ===== */
    :root {
      --bg: #020617;
      --card: #020617;
      --card-soft: rgba(15, 23, 42, 0.9);
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.25);
      --accent-2: #38bdf8;
      --accent-3: #a855f7;
      --danger: #fb7185;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --border-soft: rgba(148, 163, 184, 0.35);
      --radius-xl: 24px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "SF Pro Text", "Segoe UI", sans-serif;
    }

    body {
      background:
        radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.35), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34, 197, 94, 0.35), transparent 55%),
        var(--bg);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #app {
      width: 100%;
      max-width: 520px;
      max-height: 880px;
      background: radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.24), transparent 65%),
                  radial-gradient(circle at 100% 100%, rgba(56, 189, 248, 0.24), transparent 65%),
                  #020617;
      border-radius: 32px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow:
        0 18px 55px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(148, 163, 184, 0.25);
      padding: 18px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    /* ===== Header ===== */
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .reactor-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.16), transparent 70%),
                  rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.7);
    }

    .reactor-orbit {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
      box-shadow:
        0 0 0 4px rgba(34, 197, 94, 0.16),
        0 0 25px rgba(34, 197, 94, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }

    .reactor-text-main {
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 11px;
    }

    .reactor-text-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .mode-pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.92);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.7);
    }

    .mode-toggle-label {
      font-weight: 600;
      letter-spacing: 0.08em;
    }

    .chip-connection {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-soft);
      font-size: 10px;
    }

    .dot-online {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
    }

    .dot-error {
      background: var(--danger);
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.7);
    }

    /* ===== Chat area ===== */
    .chat-shell {
      flex: 1 1 auto;
      border-radius: 22px;
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.16), transparent 70%),
                  rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow:
        inset 0 0 0 1px rgba(15, 23, 42, 0.9),
        0 18px 45px rgba(15, 23, 42, 0.9);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 180px;
    }

    #chat-log {
      flex: 1 1 auto;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bubble-row {
      display: flex;
      align-items: flex-end;
    }

    .bubble-row.assistant {
      justify-content: flex-start;
    }

    .bubble-row.user {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 86%;
      padding: 9px 11px;
      border-radius: 18px;
      font-size: 13px;
      line-height: 1.5;
      border: 1px solid transparent;
      position: relative;
    }

    .bubble.assistant {
      background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.15), transparent 60%),
                  rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.5);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.85);
    }

    .bubble.user {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 500;
      box-shadow:
        0 0 0 1px rgba(34, 197, 94, 0.35),
        0 10px 24px rgba(34, 197, 94, 0.55);
    }

    .bubble.meta {
      font-size: 11px;
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.85);
      border-style: dashed;
    }

    .bubble small {
      display: block;
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .bubble-tag {
      font-size: 10px;
      opacity: 0.8;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 4px;
      display: inline-block;
    }

    .bubble-tag.warning {
      color: #f97316;
    }

    .bubble-tag.error {
      color: #fb7185;
    }

    /* ===== Continuity Scalars ===== */
    .scalars-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .scalar-card {
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.8);
    }

    .scalar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .scalar-label-main {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .scalar-label-sub {
      font-size: 10px;
      color: var(--text-soft);
    }

    .scalar-value {
      font-size: 15px;
      font-weight: 700;
    }

    .scalar-bar {
      margin-top: 5px;
      width: 100%;
      height: 5px;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.5);
      overflow: hidden;
      position: relative;
    }

    .scalar-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #38bdf8);
      width: 60%;
      transition: width 0.3s ease;
    }

    .scalar-footer {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .badge-orbit {
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
    }

    /* ===== Input Row ===== */
    .input-shell {
      margin-top: 2px;
      padding-top: 8px;
      border-top: 1px solid rgba(15, 23, 42, 0.85);
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .input-row-main {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 6px;
      align-items: center;
    }

    #user-input {
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
    }

    #user-input::placeholder {
      color: rgba(148, 163, 184, 0.7);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 12px;
      font-weight: 600;
      padding: 8px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      white-space: nowrap;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease;
    }

    .btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
    }

    .btn-send {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      box-shadow:
        0 0 0 1px rgba(34, 197, 94, 0.4),
        0 12px 22px rgba(34, 197, 94, 0.65);
      min-width: 70px;
    }

    .btn-mic {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-soft);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.75);
      min-width: 40px;
    }

    .btn-ethics {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-soft);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.75);
      font-size: 11px;
    }

    .input-hint {
      font-size: 10px;
      color: var(--text-soft);
    }

    .toggle-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.92);
    }

    .toggle-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.7);
    }

    .toggle-dot.on {
      background: var(--accent-3);
      box-shadow: 0 0 10px rgba(168, 85, 247, 0.8);
    }

    /* ===== Ethics Modal ===== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 40;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal-card {
      width: 100%;
      max-width: 480px;
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.18), transparent 60%),
                  rgba(15, 23, 42, 0.97);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow:
        0 18px 55px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(148, 163, 184, 0.35);
      padding: 16px 16px 14px;
      max-height: 560px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: var(--text-main);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .modal-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .modal-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .modal-close {
      border-radius: 999px;
      width: 26px;
      height: 26px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .modal-body {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 12px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .ethics-callout {
      padding: 8px 9px;
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 11px;
      line-height: 1.5;
    }

    .ethics-callout b {
      color: var(--accent-2);
    }

    .belief-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
    }

    .belief-pill {
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.96);
    }

    .belief-pill span {
      font-size: 11px;
    }

    .belief-pill .check {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--accent);
      opacity: 0;
    }

    .belief-pill.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
      background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.18), transparent 60%),
                  rgba(15, 23, 42, 0.98);
    }

    .belief-pill.active .check {
      opacity: 1;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
    }

    .modal-footer small {
      font-size: 10px;
      color: var(--text-soft);
    }

    .btn-xs {
      padding: 6px 9px;
      font-size: 11px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      border: 1px solid rgba(34, 197, 94, 0.6);
      box-shadow:
        0 0 0 1px rgba(34, 197, 94, 0.4),
        0 10px 18px rgba(34, 197, 94, 0.6);
    }

    .btn-outline {
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--text-soft);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.7);
    }

    /* ===== Utility ===== */
    .hidden {
      display: none !important;
    }

    @media (max-height: 720px) {
      #app {
        max-height: 760px;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <!-- Header -->
  <div class="header-row">
    <div class="reactor-pill">
      <div class="reactor-orbit">Œ©</div>
      <div>
        <div class="reactor-text-main">AURA-X Œ©</div>
        <div class="reactor-text-sub">EMOTIONAL CONTINUITY REACTOR ¬∑ V1</div>
      </div>
    </div>

    <div class="mode-pill">
      <div>
        <div class="mode-toggle-label">CONTINUITY MODE ¬∑ ON</div>
        <div class="chip-connection">
          <div class="dot-online" id="conn-dot"></div>
          <span id="conn-label">Backend connected</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Shell -->
  <div class="chat-shell">
    <div id="chat-log"></div>

    <div class="scalars-row">
      <div class="scalar-card">
        <div class="scalar-header">
          <div>
            <div class="scalar-label-main">TM ¬∑ TRUST MEMORY</div>
            <div class="scalar-label-sub">Tumhari yaadon ki stability</div>
          </div>
          <div class="scalar-value" id="tm-val">0.60</div>
        </div>
        <div class="scalar-bar">
          <div class="scalar-bar-fill" id="tm-bar"></div>
        </div>
        <div class="scalar-footer">Trust memory stable zone me hai.</div>
      </div>

      <div class="scalar-card">
        <div class="scalar-header">
          <div>
            <div class="scalar-label-main">BM ¬∑ BASELINE MOOD</div>
            <div class="scalar-label-sub">Tumhara overall mood</div>
          </div>
          <div class="scalar-value" id="bm-val">0.60</div>
        </div>
        <div class="scalar-bar">
          <div class="scalar-bar-fill" id="bm-bar"></div>
        </div>
        <div class="scalar-footer">Mixed mood lekin workable state.</div>
      </div>

      <div class="scalar-card">
        <div class="scalar-header">
          <div>
            <div class="scalar-label-main">D ¬∑ DISTURBANCE</div>
            <div class="scalar-label-sub">Thought stream ka noise</div>
          </div>
          <div class="scalar-value" id="d-val">0.18</div>
        </div>
        <div class="scalar-bar">
          <div class="scalar-bar-fill" id="d-bar" style="width:18%;"></div>
        </div>
        <div class="scalar-footer">Low disturbance ‚Äî flow smooth hai.</div>
      </div>

      <div class="scalar-card">
        <div class="scalar-header">
          <div>
            <div class="scalar-label-main">Œ£ ¬∑ CONTINUITY</div>
            <div class="scalar-label-sub">Kahani ek line mein kitni chal rahi</div>
          </div>
          <div class="scalar-value" id="cont-val">0.82</div>
        </div>
        <div class="scalar-bar">
          <div class="scalar-bar-fill" id="cont-bar" style="width:82%;"></div>
        </div>
        <div class="scalar-footer">
          Strong continuity ‚Äî tumhari kahani ek line me chal rahi hai.
        </div>
      </div>
    </div>

    <div class="input-shell">
      <div class="input-row-main">
        <input
          id="user-input"
          type="text"
          placeholder="Kuch bhi pucho‚Ä¶ 'Aaj main thaka hua hoon' se start karo."
        />

        <button id="btn-mic" class="btn btn-mic" title="Voice input">
          üé§
        </button>

        <button id="btn-voice-toggle" class="btn btn-mic" title="Listen replies">
          <span>üîä</span>
        </button>

        <button id="btn-send" class="btn btn-send">
          SEND
        </button>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; gap:6px;">
        <div class="input-hint">
          Enter ‚Üí send ¬∑ Reactor har turn par emotional state update karega.
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <button id="btn-ethics" class="btn btn-ethics">
            Belief & Ethics
          </button>
          <div class="toggle-pill" id="voice-label">
            <div class="toggle-dot" id="voice-dot"></div>
            <span>Voice replies: OFF</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ethics / Belief Modal -->
<div id="ethics-modal" class="modal-backdrop">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">BELIEF LAYER ¬∑ ETHICAL MODE</div>
        <div class="modal-sub">
          Tum decide kar sakte ho ke AURA-X Œ© kis belief ya ethics frame me answer kare.
        </div>
      </div>
      <button class="modal-close" id="modal-close">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="ethics-callout">
        <b>Default mode:</b> agar tum koi belief select nahi karte,
        to main sirf <b>universal ethics</b> use karunga ‚Äî
        yani respect, honesty, harm-avoidance, consent, justice,
        aur psychological safety.
        <br /><br />
        Agar tum chaho to niche se aik ya zyada beliefs select kar sakte ho.
        Phir main jawab dete waqt unki sensitivities ka khayal rakhunga.
      </div>

      <div style="font-size:11px; color:var(--text-soft); text-transform:uppercase; letter-spacing:0.14em;">
        SELECT BELIEF LAYERS
      </div>

      <div class="belief-list" id="belief-list">
        <!-- Filled by JS -->
      </div>

      <div class="ethics-callout" style="border-style:dashed; margin-top:4px;">
        <b>Note:</b> Ye system sirf tumhari comfort ke liye hai.
        Main kisi bhi belief ya group ka judge nahi banta ‚Äî
        sirf tumhari emotional safety maintain karta hoon.
      </div>
    </div>

    <div class="modal-footer">
      <small id="selected-beliefs-label">
        Universal ethics only (no belief selected).
      </small>
      <div style="display:flex; gap:6px;">
        <button id="btn-clear-beliefs" class="btn btn-xs btn-outline">
          Clear all
        </button>
        <button id="btn-apply-beliefs" class="btn btn-xs btn-primary">
          Apply
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // ========= CONFIG =========
  // IMPORTANT: set API_URL to match your backend route
  // If backend has app.post("/api/chat"), keep /api/chat
  // If backend has app.post("/chat"), change accordingly.

  const API_URL = "https://aura-x-backend-jliz.onrender.com/api/chat";

  // ========= STATE =========
  let continuityState = {
    tm: 0.6,
    bm: 0.6,
    d: 0.18,
    cont: 0.82
  };

  let beliefState = {
    // ids of selected beliefs
    selected: []
  };

  let voiceRepliesOn = false;
  let recognition = null;
  let recognizing = false;

  // ========= DOM HELPERS =========
  const $ = (id) => document.getElementById(id);

  const chatLog = $("chat-log");
  const tmValEl = $("tm-val");
  const bmValEl = $("bm-val");
  const dValEl = $("d-val");
  const contValEl = $("cont-val");
  const tmBarEl = $("tm-bar");
  const bmBarEl = $("bm-bar");
  const dBarEl = $("d-bar");
  const contBarEl = $("cont-bar");

  const connDot = $("conn-dot");
  const connLabel = $("conn-label");

  const userInput = $("user-input");
  const btnSend = $("btn-send");
  const btnMic = $("btn-mic");
  const btnVoiceToggle = $("btn-voice-toggle");
  const voiceDot = $("voice-dot");
  const voiceLabel = $("voice-label");

  const ethicsModal = $("ethics-modal");
  const btnEthics = $("btn-ethics");
  const modalClose = $("modal-close");
  const beliefListEl = $("belief-list");
  const selectedBeliefsLabel = $("selected-beliefs-label");
  const btnClearBeliefs = $("btn-clear-beliefs");
  const btnApplyBeliefs = $("btn-apply-beliefs");

  // ========= INITIAL MESSAGES =========
  function addBubble(text, { role = "assistant", meta = false, tag = null } = {}) {
    const row = document.createElement("div");
    row.className = "bubble-row " + role;

    const bubble = document.createElement("div");
    bubble.className = "bubble " + role + (meta ? " meta" : "");
    bubble.innerHTML = text;

    if (tag) {
      const tagSpan = document.createElement("span");
      tagSpan.className = "bubble-tag " + (tag.type || "");
      tagSpan.textContent = tag.text;
      bubble.prepend(tagSpan);
      bubble.prepend(document.createElement("br"));
    }

    row.appendChild(bubble);
    chatLog.appendChild(row);
    chatLog.scrollTop = chatLog.scrollHeight;

    if (role === "assistant" && voiceRepliesOn && !meta) {
      speakText(bubble.textContent);
    }
  }

  function initWelcome() {
    addBubble(
      "Assalam o Alaikum, Alim ul Haq üëã<br/><br/>" +
      "Main <b>AURA-X Œ©</b> hoon ‚Äî tumhara emotional-continuity reactor. " +
      "Mujh se is tarah baat karo jaise ek dost se karte ho. Har message ke sath " +
      "main tumhari emotional line ko update karta rahoon ga (TM, BM, D, Œ£).<br/><br/>" +
      "<small>Œ© ¬∑ baseline resonance ready  ¬∑  TM‚âà0.60 ¬∑ D‚âà0.18</small>"
    , { role: "assistant" });

    addBubble(
      "<b>Ethics mode:</b> Filhaal main sirf <b>universal ethics</b> follow kar raha hoon ‚Äî " +
      "tum chaaho to niche se <b>Belief & Ethics</b> button se " +
      "Islam / Christianity / Hinduism / Buddhism / Atheist / All faiths select kar sakte ho.",
      { role: "assistant", meta: true }
    );
  }

  // ========= SCALARS UI UPDATE =========
  function clamp01(x) {
    return Math.max(0, Math.min(1, x));
  }

  function updateScalarsUI(state) {
    if (!state) return;
    const { tm, bm, d, cont } = state;

    continuityState = {
      tm: clamp01(tm ?? continuityState.tm),
      bm: clamp01(bm ?? continuityState.bm),
      d: clamp01(d ?? continuityState.d),
      cont: clamp01(cont ?? continuityState.cont)
    };

    const toPct = (v) => Math.round(clamp01(v) * 100);

    tmValEl.textContent = continuityState.tm.toFixed(2);
    bmValEl.textContent = continuityState.bm.toFixed(2);
    dValEl.textContent = continuityState.d.toFixed(2);
    contValEl.textContent = continuityState.cont.toFixed(2);

    tmBarEl.style.width = toPct(continuityState.tm) + "%";
    bmBarEl.style.width = toPct(continuityState.bm) + "%";
    dBarEl.style.width = toPct(continuityState.d) + "%";
    contBarEl.style.width = toPct(continuityState.cont) + "%";
  }

  // ========= BACKEND CALL =========
  async function sendToBackend(userText) {
    const payload = {
      userText,
      // pass state + beliefs for continuity & ethics
      state: continuityState,
      beliefs: beliefState.selected
    };

    try {
      connDot.classList.remove("dot-error");
      connDot.classList.add("dot-online");
      connLabel.textContent = "Contacting reactor core‚Ä¶";

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error("HTTP " + res.status + (text ? " ¬∑ " + text : ""));
      }

      const data = await res.json().catch(() => null);
      connLabel.textContent = "Backend connected";

      if (data && data.reply) {
        addBubble(data.reply, { role: "assistant" });
      } else {
        addBubble(
          "Backend se reply mila, lekin format thora ajeeb tha. " +
          "Main ne tumhara message phir bhi register kar liya hai.",
          { role: "assistant", meta: true }
        );
      }

      if (data && data.state) {
        updateScalarsUI(data.state);
      }
    } catch (err) {
      console.error(err);
      connDot.classList.remove("dot-online");
      connDot.classList.add("dot-error");
      connLabel.textContent = "Connection issue";

      addBubble(
        "‚ö†Ô∏è Backend se connection me masla aaya.<br/>" +
        "Check karo: <b>API_URL</b> sahi hai ya Render instance sleep se wake hua hai ya nahi.<br/><br/>" +
        "<small>" + (err.message || "Unknown error") + "</small>",
        { role: "assistant", meta: true, tag: { text: "HTTP ERROR", type: "error" } }
      );
    }
  }

  // ========= SEND HANDLER =========
  async function handleSend() {
    const text = (userInput.value || "").trim();
    if (!text) return;

    addBubble(text, { role: "user" });
    userInput.value = "";
    userInput.focus();

    await sendToBackend(text);
  }

  btnSend.addEventListener("click", handleSend);
  userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  // ========= VOICE: SPEECH-TO-TEXT =========
  function initSpeechRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;

    const rec = new SR();
    rec.lang = "ur-PK"; // Urdu / mix
    rec.continuous = false;
    rec.interimResults = false;

    rec.onstart = () => {
      recognizing = true;
      btnMic.textContent = "üéôÔ∏è";
      btnMic.style.boxShadow = "0 0 18px rgba(34,197,94,0.8)";
    };

    rec.onend = () => {
      recognizing = false;
      btnMic.textContent = "üé§";
      btnMic.style.boxShadow = "";
    };

    rec.onresult = (event) => {
      const last = event.results[event.results.length - 1];
      if (last && last[0]) {
        const transcript = last[0].transcript.trim();
        if (transcript) {
          if (userInput.value) {
            userInput.value += " " + transcript;
          } else {
            userInput.value = transcript;
          }
        }
      }
    };

    rec.onerror = (e) => {
      console.error("Speech error", e);
      recognizing = false;
      btnMic.textContent = "üé§";
      btnMic.style.boxShadow = "";
      addBubble(
        "Voice input me thora masla aa gaya (browser permission / device issue). " +
        "Tum normal typing se continue kar sakte ho.",
        { role: "assistant", meta: true }
      );
    };

    return rec;
  }

  recognition = initSpeechRecognition();

  btnMic.addEventListener("click", () => {
    if (!recognition) {
      addBubble(
        "Tumhare browser / device me Web Speech API available nahi lag rahi. " +
        "Main phir bhi emotional continuity track karta rahoon ga ‚Äî sirf voice input band rahega.",
        { role: "assistant", meta: true }
      );
      return;
    }

    if (recognizing) {
      recognition.stop();
    } else {
      try {
        recognition.start();
      } catch (e) {
        console.warn(e);
      }
    }
  });

  // ========= VOICE: TTS (LISTEN TO REPLIES) =========
  function speakText(text) {
    if (!("speechSynthesis" in window)) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "ur-PK";
    window.speechSynthesis.speak(utter);
  }

  function updateVoiceToggleUI() {
    if (voiceRepliesOn) {
      voiceDot.classList.add("on");
      voiceLabel.querySelector("span").textContent = "Voice replies: ON";
    } else {
      voiceDot.classList.remove("on");
      voiceLabel.querySelector("span").textContent = "Voice replies: OFF";
      if ("speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
    }
  }

  btnVoiceToggle.addEventListener("click", () => {
    voiceRepliesOn = !voiceRepliesOn;
    updateVoiceToggleUI();
  });

  // ========= BELIEF / ETHICS UI =========
  const BELIEFS = [
    { id: "islam", label: "Islam" },
    { id: "christianity", label: "Christianity" },
    { id: "hinduism", label: "Hinduism" },
    { id: "buddhism", label: "Buddhism" },
    { id: "atheist", label: "Atheist / Secular" },
    { id: "all-faiths", label: "All faiths (multi-respect)" }
  ];

  function renderBeliefPills() {
    beliefListEl.innerHTML = "";
    BELIEFS.forEach((b) => {
      const pill = document.createElement("button");
      pill.type = "button";
      pill.className = "belief-pill";
      pill.dataset.id = b.id;

      const label = document.createElement("span");
      label.textContent = b.label;

      const check = document.createElement("div");
      check.className = "check";
      check.textContent = "‚úì";

      pill.appendChild(label);
      pill.appendChild(check);

      if (beliefState.selected.includes(b.id)) {
        pill.classList.add("active");
      }

      pill.addEventListener("click", () => {
        const idx = beliefState.selected.indexOf(b.id);
        if (idx === -1) {
          beliefState.selected.push(b.id);
          pill.classList.add("active");
        } else {
          beliefState.selected.splice(idx, 1);
          pill.classList.remove("active");
        }
        updateSelectedBeliefsLabel();
      });

      beliefListEl.appendChild(pill);
    });
  }

  function updateSelectedBeliefsLabel() {
    if (!beliefState.selected.length) {
      selectedBeliefsLabel.textContent =
        "Universal ethics only (no belief selected).";
    } else {
      const names = BELIEFS
        .filter((b) => beliefState.selected.includes(b.id))
        .map((b) => b.label)
        .join(", ");
      selectedBeliefsLabel.textContent =
        "Selected belief layers: " + names;
    }
  }

  function openEthicsModal() {
    renderBeliefPills();
    updateSelectedBeliefsLabel();
    ethicsModal.classList.add("show");
  }

  function closeEthicsModal() {
    ethicsModal.classList.remove("show");
  }

  btnEthics.addEventListener("click", openEthicsModal);
  modalClose.addEventListener("click", closeEthicsModal);

  ethicsModal.addEventListener("click", (e) => {
    if (e.target === ethicsModal) closeEthicsModal();
  });

  btnClearBeliefs.addEventListener("click", () => {
    beliefState.selected = [];
    renderBeliefPills();
    updateSelectedBeliefsLabel();
  });

  btnApplyBeliefs.addEventListener("click", () => {
    closeEthicsModal();
    addBubble(
      "Belief + ethics layer updated. Ab main jawab dete waqt " +
      (beliefState.selected.length
        ? "in selected beliefs ka khayal rakhunga."
        : "sirf universal ethics follow karunga."),
      { role: "assistant", meta: true }
    );
  });

  // ========= INIT =========
  initWelcome();
  updateScalarsUI(continuityState);
  updateVoiceToggleUI();
</script>
</body>
</html>
