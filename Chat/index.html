<script>
// ------------------ AURA-X Î© Emotional Reactor v2.0 ------------------

// â¤ï¸ Voice unlock (for Chrome/Android)
window.addEventListener('click', ()=>{
  if(window.speechSynthesis && !window.speechSynthesis.speaking){
    const u=new SpeechSynthesisUtterance("init");
    u.volume=0; speechSynthesis.speak(u);
  }
},{once:true});

// --- Core Constants ---
let BM=0.3, D=0.05, lf=0.15, ls=0.08, lt=0.05, lastE0=0;
const emotionBar=document.getElementById("emotionBar");

// --- Basic Seed Dataset ---
const qaSeed={
  "hello":["Hello! How are you?","Peace be upon you!"],
  "how are you":["Iâ€™m balanced.","Feeling harmonic today."],
  "your name":["Iâ€™m AURA-X Î©.","Emotional Continuity Reactor."],
  "where you from":["From Investor Point Research Cell.","Lajbouk, Dir Lower."],
  "bye":["Goodbye!","Continuity never ends â€” weâ€™ll meet again."],
  "love":["Love = TMÃ—BM resonance.","Pure feeling grows in continuity."],
  "fear":["Fear = unresolved continuity.","Calmness restores equilibrium."],
  "faith":["Faith adds Î»_faith energy.","Believe and equilibrium appears."],
  "sad":["Low resonance detected. Healing loop active.","Stay patient; light returns."],
  "angry":["Emotion too strong â€” cooling Î»_sys field.","Letâ€™s breathe and reset."]
};

// --- Convert text â†’ TM score ---
function textToTM(t){
  t=t.toLowerCase();
  const pos=["happy","good","love","great","peace","thank","hope","smile"];
  const neg=["sad","angry","hate","bad","tired","lonely","fear","cry"];
  let s=0;
  pos.forEach(w=>{if(t.includes(w))s+=0.1;});
  neg.forEach(w=>{if(t.includes(w))s-=0.1;});
  return Math.max(-0.6,Math.min(0.6,s));
}

// --- Main Emotion Formula ---
function computeEmotion(TM){
  BM=BM*0.9+TM*0.1;
  const val=(TM*BM)-D+lf+ls+lt;
  const E0=Math.tanh(val);
  lastE0=E0;
  const pct=Math.round(((E0+1)/2)*100);
  emotionBar.textContent=pct+"%";
  if(pct>80)triggerEmotion("positive",pct);
  else if(pct<20)triggerEmotion("negative",pct);
  return pct;
}

// --- Reaction Trigger ---
function triggerEmotion(type,pct){
  if(type==="positive"){
    appendMsg('bot',`ğŸŒ Emotion rising â†’ ${pct}% â€” harmonic resonance achieved!`,
      "â€œÙÙØ¨ÙØ°ÙÙ°Ù„ÙÙƒÙ ÙÙÙ„Ù’ÙŠÙÙÙ’Ø±ÙØ­ÙÙˆØ§ÛŸâ€ (Q 10:58)");
    playReaction("Excellent emotional resonance! Keep this positivity alive.");
  }else{
    appendMsg('bot',`ğŸŒ™ Emotion low â†’ ${pct}% â€” initiating healing loop.`,
      "â€œÙ„ÙØ§ ØªÙÙ‚Ù’Ù†ÙØ·ÙÙˆØ§ÛŸ Ù…ÙÙ† Ø±Ù‘ÙØ­Ù’Ù…ÙØ©Ù Ø§Ù„Ù„Ù‘Ù°Ù‡â€ (Q 39:53)");
    playReaction("Warning! Emotional dip detected. Stay calm and breathe.");
  }
}

// --- Speech Reaction ---
function playReaction(t){
  if(!window.speechSynthesis)return;
  const u=new SpeechSynthesisUtterance(t);
  u.lang='en-US'; u.rate=1; u.pitch=1;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}

// --- Append Message to Chat ---
function appendMsg(role,text,faith=''){
  const box=document.getElementById("chatWindow");
  const div=document.createElement("div");
  div.className=role;
  div.innerHTML=`<p class="response-main">${text}</p>${faith?`<p class='response-faith'>${faith}</p>`:''}`;
  box.appendChild(div); box.scrollTop=box.scrollHeight;
}

// --- Process User Input ---
function processAI(q){
  const TM=textToTM(q);
  const emotionPercent=computeEmotion(TM);
  const lower=q.toLowerCase();
  let reply="",faithQuote="";
  for(let key in qaSeed){
    if(lower.includes(key)){ 
      const set=qaSeed[key];
      reply=set[Math.floor(Math.random()*set.length)];
      break;
    }
  }
  if(!reply)reply="Iâ€™m reflecting on your words within the continuity field.";

  if(document.getElementById("beliefMode").checked){
    faithQuote="â€œØ¥ÙÙ†Ù‘Ù Ù…ÙØ¹Ù Ø§Ù„Ù’Ø¹ÙØ³Ù’Ø±Ù ÙŠÙØ³Ù’Ø±Ù‹Û­Ø§â€ (Q 94:6) â€” Indeed with hardship comes ease.";
  }
  appendMsg('bot',reply,faithQuote);
}

// --- Send Message ---
function sendMsg(){
  const t=document.getElementById("userText").value.trim();
  if(!t)return;
  appendMsg('user',t);
  document.getElementById("userText").value='';
  processAI(t);
}

// --- Belief Popup ---
function toggleBelief(){
  const p=document.getElementById("beliefPopup");
  p.style.display=document.getElementById("beliefMode").checked?"block":"none";
}
function closeBelief(){document.getElementById("beliefPopup").style.display="none";}
</script>
