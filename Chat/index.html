<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AURA-X ‚Ä¢ Omega Prototype</title>
<style>
  :root{
    --bg:#0c111b; --panel:#111a24; --panel-2:#0f1722; --text:#e8eef6; --muted:#a7b3c4;
    --joy:#19c37d; --calm:#3aa0ff; --sad:#6b7a90; --anger:#ff5252; --fear:#b98bff; --anx:#ffd166;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  body{margin:0;display:flex;flex-direction:column}

  /* Animated aura background */
  .aura{
    position:fixed; inset:0;
    background: radial-gradient(1200px 700px at 50% 55%, #0a2b4a88 0%, transparent 60%),
                radial-gradient(700px 500px at 20% 80%, #002b3655 0%, transparent 60%),
                radial-gradient(900px 700px at 80% 20%, #0f1b3550 0%, transparent 60%);
    transition:filter .6s ease, background .6s ease;
    pointer-events:none; z-index:0;
  }
  .glow{position:fixed;inset:0;pointer-events:none;z-index:1;mix-blend-mode:screen;opacity:.4;transition:opacity .6s}
  .glow::before{
    content:""; position:absolute; left:50%; top:50%;
    width:120vmin; height:120vmin; transform:translate(-50%,-50%);
    border-radius:50%;
    filter:blur(80px); opacity:.8;
    background:radial-gradient(circle,#3aa0ff 0%, transparent 60%);
    transition:background .6s ease;
  }

  header{
    position:sticky; top:0; z-index:5;
    background:linear-gradient(#0b141f, #0b141fdd 70%, transparent);
    padding:14px 14px 6px; backdrop-filter:blur(6px);
    display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;
    border-bottom:1px solid #0f2333;
  }
  .badge{
    background:#07121d;border:1px solid #12324a; color:#caf; padding:6px 10px; border-radius:999px;
    font-weight:600; letter-spacing:.2px; display:flex; gap:8px; align-items:center; font-size:14px;
    box-shadow:0 0 0 1px #0b263d inset, 0 8px 30px #0006;
  }
  .badge .dot{width:10px;height:10px;border-radius:50%; box-shadow:0 0 12px currentColor}
  .state{opacity:.9}

  .wrap{flex:1; overflow:auto; padding:16px; z-index:2}
  .chat{max-width:820px; margin:0 auto; display:flex; flex-direction:column; gap:12px}

  .bubble{
    background:linear-gradient(180deg, #0e1722, #0c131c);
    border:1px solid #132435; border-radius:16px; padding:14px 16px; line-height:1.55;
    box-shadow:0 10px 30px #0008, inset 0 1px 0 #213245; font-size:15px;
  }
  .me{background:linear-gradient(180deg,#0f1b2a,#0c1520); border-color:#1c2f45}
  .bot-title{font-weight:700; margin-bottom:6px; color:#cfe6ff}
  .muted{color:var(--muted)}
  .echo{opacity:.9}

  .controls{
    max-width:820px; margin:8px auto 0; display:flex; gap:10px; flex-wrap:wrap; padding:0 16px;
  }
  .seg{
    background:#0d1622; border:1px solid #1b3148; border-radius:12px; padding:10px; display:flex; gap:10px; flex:1;
    min-width:260px; align-items:center; justify-content:space-between;
  }
  .seg label{font-size:13px; color:#bcd}
  .select, .input{
    background:#0a121c; color:#e6f0ff; border:1px solid #1a2f44; border-radius:10px; padding:8px 10px; width:100%;
  }
  .toggle{display:flex; align-items:center; gap:10px}
  .toggle input{width:20px;height:20px}

  form{
    position:sticky; bottom:0; z-index:5;
    background:linear-gradient(180deg, transparent, #0a0f18 40%, #0a0f18);
    padding:12px 16px 14px; border-top:1px solid #0e2437;
  }
  .row{max-width:820px; margin:0 auto; display:flex; gap:10px}
  textarea{
    flex:1; resize:none; min-height:46px; max-height:160px;
    border:1px solid #1a2f44; background:#0a121c; color:#e6f0ff; border-radius:12px;
    padding:12px 14px; line-height:1.5; font-size:15px; outline:none;
  }
  button{
    background:#2d8cff; border:none; color:white; padding:0 18px; border-radius:12px; font-weight:700;
    font-size:16px; min-width:86px;
    box-shadow:0 6px 20px #2d8cff55; height:46px;
  }

  /* emotion-color helpers */
  .joy   { color:var(--joy)}
  .calm  { color:var(--calm)}
  .sad   { color:var(--sad)}
  .anger { color:var(--anger)}
  .fear  { color:var(--fear)}
  .anx   { color:var(--anx)}
</style>
</head>
<body>
<div class="aura" id="aura"></div>
<div class="glow" id="glow"></div>

<header>
  <div class="badge" id="badge">
    <span class="dot" id="dot" style="color:var(--calm)"></span>
    <span>Œ© AURA-X</span> ‚Ä¢ <span class="state" id="state">calm</span>
  </div>
</header>

<div class="controls">
  <div class="seg" style="flex:1.1">
    <label style="width:120px">Guidance style</label>
    <select id="guideStyle" class="select">
      <option value="neutral">Neutral</option>
      <option value="ethics">Universal Ethics</option>
      <option value="islamic">Islamic</option>
    </select>
  </div>

  <div class="seg" style="flex:1">
    <div class="toggle">
      <input type="checkbox" id="qaOn"/>
      <label for="qaOn">Answer questions (LLM)</label>
    </div>
  </div>
  <div class="seg" style="flex:2">
    <label style="width:120px">API Endpoint</label>
    <input id="qaEndpoint" class="input" placeholder="https://YOUR-WORKER.example.com/api/ask"/>
  </div>
</div>

<div class="wrap">
  <div class="chat" id="chat">
    <div class="bubble">
      üëã Hello! I‚Äôm AURA-X ‚Äî your emotional resonance prototype. Tell me how you feel today.
    </div>
  </div>
</div>

<form id="form">
  <div class="row">
    <textarea id="inp" placeholder="Type your emotion or paste a long text‚Ä¶"></textarea>
    <button id="send" type="submit">Send</button>
  </div>
</form>

<script>
/* ---------- Utilities ---------- */
const chat = document.getElementById('chat');
const inp = document.getElementById('inp');
const form = document.getElementById('form');
const aura = document.getElementById('aura');
const glow = document.getElementById('glow');
const badge = document.getElementById('badge');
const stateEl = document.getElementById('state');
const dot = document.getElementById('dot');
const qaOn = document.getElementById('qaOn');
const qaEndpoint = document.getElementById('qaEndpoint');
const guideStyle = document.getElementById('guideStyle');

const EMO = {
  joy:   { color:'var(--joy)',    bg:'#0d2b1f', icon:'üòä' },
  calm:  { color:'var(--calm)',   bg:'#0b2438', icon:'ü´Å' },
  sadness:{color:'var(--sad)',    bg:'#101823', icon:'üò¢'},
  anger: { color:'var(--anger)',  bg:'#2b0e14', icon:'üò†' },
  fear:  { color:'var(--fear)',   bg:'#1f1230', icon:'üòü' },
  anxiety:{color:'var(--anx)',    bg:'#2a2512', icon:'üò•'},
  tired: { color:'#c0cbd8',       bg:'#0f1620', icon:'ü•±'},
  hope:  { color:'#6fe0b3',       bg:'#11271f', icon:'üå±'},
  confused:{color:'#f7b267',      bg:'#2b2212', icon:'ü§î'},
  neutral:{color:'var(--calm)',   bg:'#0b2438', icon:'üôÇ'}
};

function toEnd(){ chat.lastElementChild?.scrollIntoView({behavior:'smooth', block:'end'}) }
function escapeHTML(s){ return s.replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])) }

function addUser(t){
  const b=document.createElement('div'); b.className='bubble me';
  b.innerHTML=`üß† <b>You:</b> ${escapeHTML(t)}`;
  chat.appendChild(b); toEnd();
}
function addBot(html){
  const b=document.createElement('div'); b.className='bubble';
  b.innerHTML=html; chat.appendChild(b); toEnd();
}
function typingOn(){
  const b=document.createElement('div'); b.className='bubble'; b.id='typing';
  b.innerHTML=`Œ© AURA-X: <span class="muted">typing‚Ä¶</span>`;
  chat.appendChild(b); toEnd();
}
function typingOff(){ document.getElementById('typing')?.remove(); }

function auraTo(em){
  const meta = EMO[em] || EMO.neutral;
  stateEl.textContent = em;
  dot.style.color = meta.color;
  glow.style.opacity = .55;
  glow.style.setProperty('--c', meta.color);
  glow.style.setProperty('filter', 'saturate(1.3)');
  glow.style.setProperty('mix-blend-mode','screen');
  glow.style.setProperty('transition','opacity .6s, filter .6s');
  glow.style.setProperty('--x','0');

  glow.style.setProperty('--dummy','1'); // kick repaint
  glow.style.setProperty('opacity','.55');
  glow.style.setProperty('transition','opacity .6s');

  glow.querySelector?.(':scope'); // noop for Safari

  glow.style.setProperty('opacity','.55');
  glow.style.setProperty('transition','opacity .6s');

  glow.style.setProperty('--color', meta.color);
  glow.style.setProperty('--bg', meta.bg);

  glow.style.setProperty('--dummy2','1');
  glow.firstElementChild?.remove();
}
glow.innerHTML=''; // ensure pseudo keeps working
glow.insertAdjacentHTML('afterbegin','');

function setBackdrop(em){
  const meta = EMO[em] || EMO.neutral;
  aura.style.background = `
    radial-gradient(1200px 700px at 50% 55%, ${hexA(meta.color,0.45)} 0%, transparent 60%),
    radial-gradient(700px 500px at 20% 80%, ${hexA(meta.color,0.12)} 0%, transparent 60%),
    radial-gradient(900px 700px at 80% 20%, #0d1627aa 0%, transparent 60%)`;
  dot.style.color = meta.color;
}
function hexA(cssVar,alpha){
  // read computed color for var(--xyz)
  const el=document.createElement('div'); el.style.color=`${cssVar}`;
  document.body.appendChild(el);
  const rgb=getComputedStyle(el).color; document.body.removeChild(el);
  const m=rgb.match(/(\d+),\s*(\d+),\s*(\d+)/);
  if(!m) return 'rgba(58,160,255,'+alpha+')';
  return `rgba(${m[1]},${m[2]},${m[3]},${alpha})`;
}

/* ---------- Emotion detection (rule-based) ---------- */
const lex = {
  joy:      /happy|excited|grateful|alhamdulillah|shukr|great|love|wonderful|joy|proud|success/i,
  calm:     /calm|peace|relax|okay|fine|good|satisfied|serene|breath|deep breath/i,
  sadness:  /sad|upset|hurt|depressed|cry|empty|lonely|loss|broken|tears/i,
  anger:    /angry|mad|furious|annoyed|irritated|rage|hate|unfair|injustice/i,
  fear:     /afraid|scared|fear|terror|phobia|dar|khauf|panic/i,
  anxiety:  /anxious|nervous|stress|tension|worry|confused|confusion|parishan|pressure/i,
  tired:    /tired|sleepy|exhaust(ed)?|fatigue|thaka|thak gaya/i,
  hope:     /hope|optimistic|inshaallah|soon|believe|will try|determined/i,
  confused: /confused|unsure|doubt|puzzled|unclear|what to do/i
};

function detect(text){
  const scores = {joy:0, calm:0, sadness:0, anger:0, fear:0, anxiety:0, tired:0, hope:0, confused:0};
  const lower = text.toLowerCase();

  for(const k of Object.keys(lex)){
    scores[k] = (lower.match(lex[k])||[]).length;
  }
  // sentiment tilt
  if(/[!?]$/.test(text)) scores.anger += .2;
  if(/\bnot|never|no\b/i.test(text)) scores.sadness += .2;
  if(/\bthanks|shukr|alhamdulillah\b/i.test(text)) scores.joy += .7;

  let best='calm', max=-1, sum=0;
  for(const [k,v] of Object.entries(scores)){ sum+=v; if(v>max){max=v; best=k}}
  const conf = Math.min(98, Math.round( (max/(sum||1))*100 )) || (best==='calm'?65:55);
  return { primary: best, scores, conf };
}

/* ---------- Summariser (local, non-LLM) ---------- */
function summarise(text){
  const sents = text.replace(/\s+/g,' ').split(/(?<=[.!?ÿü])\s+/).filter(Boolean).slice(0,3);
  const short = sents.join(' ');
  return short.length? short : (text.length>140? text.slice(0,140)+'‚Ä¶' : text);
}

/* ---------- Guidance generator ---------- */
function guide(em, style){
  const t = {
    neutral:{
      sadness: "ŸÖ€å⁄∫ ÿ¢Ÿæ ⁄©€å ⁄©€åŸÅ€åÿ™ ÿ≥ŸÜ ÿ±€Åÿß €ÅŸà⁄∫€î ÿß€å⁄© ÿ¢€Åÿ≥ÿ™€Å ÿ≥ÿßŸÜÿ≥ ÿßŸÜÿØÿ±‚Ä¶ ÿ®ÿß€Åÿ± ŸÑ€å⁄∫ÿå ÿßŸàÿ± ÿÆŸàÿØ ⁄©Ÿà ŸÜÿ±ŸÖ€å ÿØ€å⁄∫€î ÿß⁄Øÿ± ŸÖŸÜÿßÿ≥ÿ® ŸÑ⁄Ø€í ÿ™Ÿà ÿßŸæŸÜ€í ŸÜÿ≤ÿØ€å⁄© ÿ™ÿ±€åŸÜ ÿ¥ÿÆÿµ ÿ≥€í ÿ®ÿßÿ™ ⁄©ÿ±€å⁄∫€î",
      anxiety: "ŸÅ⁄©ÿ± ⁄©€å ÿ¥ÿØÿ™ ⁄©ŸÖ ⁄©ÿ±ŸÜ€í ⁄©€í ŸÑÿ¶€í 4-4-4 ÿ≥ÿßŸÜÿ≥ ÿ¢ÿ≤ŸÖÿßÿ¶€å⁄∫: 4 ÿ≥€å⁄©ŸÜ⁄à ÿßŸÜÿØÿ±ÿå 4 ÿ±Ÿà⁄©€å⁄∫ÿå 4 ÿ®ÿß€Åÿ±€î ⁄©ÿßŸÖŸà⁄∫ ⁄©Ÿà ⁄Ü⁄æŸàŸπ€í ŸÇÿØŸÖŸà⁄∫ ŸÖ€å⁄∫ ÿ™Ÿà⁄ë ÿØ€å⁄∫€î",
      anger:   "ÿ∫ÿµ€Å ÿ®ÿ™ÿßÿ™ÿß €Å€í ⁄©€Å ⁄©Ÿàÿ¶€å ŸÇÿØÿ± ŸÖÿ™ÿßÿ´ÿ± €ÅŸàÿ¶€å €Å€í€î ŸÖÿ≠ŸÅŸàÿ∏ ÿ¨⁄Ø€Å ŸÖ€å⁄∫ ÿßÿ≥€í ŸÑŸÅÿ∏Ÿà⁄∫ ŸÖ€å⁄∫ ŸÑÿßÿ¶€å⁄∫ÿå Ÿæ⁄æÿ± ÿπŸÖŸÑ ⁄©€í ŸÑÿ¶€í ŸæŸèÿ±ÿ≥⁄©ŸàŸÜ ŸÇÿØŸÖ ⁄ÜŸÜ€å⁄∫€î",
      fear:    "ÿÆŸàŸÅ ⁄©Ÿà ŸÜÿßŸÖ ÿØ€å⁄∫ÿå ÿ¨⁄Ø€Å ÿØ€å⁄∫ÿå ÿßŸàÿ± ÿ≠ÿßÿ∂ÿ± ÿ≠ŸÇÿßÿ¶ŸÇ ŸÑ⁄©⁄æ€å⁄∫‚Äî⁄©€åÿß ŸÖ€åÿ±€í Ÿæÿßÿ≥ ŸÅŸàÿ±€å ÿÆÿ∑ÿ±€Å €Å€í €åÿß ÿ∞€ÅŸÜ ÿÆ€åÿßŸÑ ÿ®ŸÜÿß ÿ±€Åÿß €Å€íÿü",
      tired:   "ÿ¨ÿ≥ŸÖ ÿ¢ÿ±ÿßŸÖ ŸÖÿßŸÜ⁄Ø ÿ±€Åÿß €Å€í€î ŸæÿßŸÜ€åÿå €ÅŸÑ⁄©€å ⁄Ü€ÅŸÑ ŸÇÿØŸÖ€åÿå €åÿß 20 ŸÖŸÜŸπ ⁄©ÿß ÿ¢ÿ±ÿßŸÖ ŸÖÿØÿØ⁄Øÿßÿ± €ÅŸà ÿ≥⁄©ÿ™ÿß €Å€í€î",
      joy:     "€å€Å ÿÆŸàÿ¥€å ŸÑÿßÿ¶ŸÇŸê ÿ¥⁄©ÿ± €Å€í‚Äîÿßÿ≥ ŸÑŸÖÿ≠€í ⁄©Ÿà ÿ≥ÿßŸÜÿ≥ ⁄©€í ÿ≥ÿßÿ™⁄æ ÿß€åŸÜ⁄©ÿ± ⁄©ÿ±€å⁄∫ ÿ™ÿß⁄©€Å ÿØŸÖÿßÿ∫ ÿßÿ≥€í €åÿßÿØ ÿ±⁄©⁄æ€í€î",
      hope:    "ÿ¢Ÿæ ⁄©€å ÿßŸÖ€åÿØ ÿß€å⁄© ÿ≥ŸÖÿ™ ÿØ⁄©⁄æÿß ÿ±€Å€å €Å€í‚Äîÿß⁄ØŸÑÿß ⁄Ü⁄æŸàŸπÿßÿå ÿ≠ŸÇ€åŸÇ€å ŸÇÿØŸÖ ŸÑ⁄©⁄æ ŸÑ€å⁄∫€î",
      confused:"ÿß⁄Ü⁄æÿß ÿ≥ŸàÿßŸÑ! ŸÅ€åÿµŸÑ€í ⁄©€í ŸÑÿ¶€í 2 ÿ¢Ÿæÿ¥ŸÜ ŸÑ⁄©⁄æ€å⁄∫ÿå €Åÿ± ÿß€å⁄© ⁄©€í 1 ŸÅÿßÿ¶ÿØ€Å/1 ÿÆÿ∑ÿ±€Åÿå Ÿæ⁄æÿ± ⁄Ü⁄æŸàŸπÿß ÿ™ÿ¨ÿ±ÿ®€Å ⁄©ÿ±€å⁄∫€î",
      calm:    "ÿ¢Ÿæ ŸÖÿ±⁄©ÿ≤ ŸÖ€å⁄∫ €Å€å⁄∫‚Äîÿßÿ≥€å ÿ∑ÿ±ÿ≠ ÿ≥ÿßŸÜÿ≥ ⁄©€í ÿ≥ÿßÿ™⁄æ ŸÜÿ±ŸÖ€å ⁄©Ÿà ÿ®ÿ±ŸÇÿ±ÿßÿ± ÿ±⁄©⁄æ€å⁄∫€î"
    },
    ethics:{
      anger: "ÿ∑ÿßŸÇÿ™ ⁄©Ÿà ÿ∞ŸÖ€Å ÿØÿßÿ±€å ÿ≥€í ÿ®ÿ±ÿ™€å⁄∫‚Äî⁄©ÿ≥€å ⁄©Ÿà ŸÜŸÇÿµÿßŸÜ ŸÜ€Å€å⁄∫ÿå ŸÖÿ≥ÿ¶ŸÑ€í Ÿæÿ± ÿ™ŸÜŸÇ€åÿØÿå ÿ¥ÿÆÿµ Ÿæÿ± ŸÜ€Å€å⁄∫€î",
      confused: "ÿ≥⁄Üÿßÿ¶€åÿå ÿ∂ÿ±ÿ± ŸÜ€Å Ÿæ€ÅŸÜ⁄ÜÿßŸÜÿßÿå ÿßŸàÿ± ÿπÿØŸÑ‚ÄîÿßŸÜ ÿ™€åŸÜ ÿßÿµŸàŸÑŸà⁄∫ ⁄©€í ÿ≥ÿßÿ™⁄æ ŸÅ€åÿµŸÑ€Å ŸÇÿ±€åÿ® ÿ¢ÿ™ÿß €Å€í€î",
      fear: "ÿß⁄Øÿ± ÿØŸàÿ≥ÿ±Ÿà⁄∫ Ÿæÿ± ÿßÿ´ÿ± €Å€í ÿ™Ÿà ÿ¥ŸÅÿßŸÅ€åÿ™ ÿßÿÆÿ™€åÿßÿ± ⁄©ÿ±€å⁄∫ ÿßŸàÿ± ŸÖÿØÿØ ÿ∑ŸÑÿ® ⁄©ÿ±€å⁄∫‚Äî€å€Å ÿßÿÆŸÑÿßŸÇ€å €ÅŸÖÿ™ €Å€í€î",
      joy: "ÿßŸæŸÜ€å ÿÆŸàÿ¥€å ÿ®ÿßŸÜŸπŸÜÿß ÿ®⁄æ€å ÿß€å⁄© ÿßÿÆŸÑÿßŸÇ€å ÿπŸÖŸÑ €Å€í‚Äî⁄©ÿ≥€å ⁄©€å ÿÆÿ®ÿ±⁄Ø€åÿ±€å ⁄©ÿ±€å⁄∫€î"
    },
    islamic:{
      sadness: "ÿßŸêŸÜŸéŸë ŸÖŸéÿπŸé ÿßŸÑŸíÿπŸèÿ≥Ÿíÿ±Ÿê ŸäŸèÿ≥Ÿíÿ±Ÿãÿß ‚Äî ŸÖÿ¥⁄©ŸÑ ⁄©€í ÿ≥ÿßÿ™⁄æ ÿ¢ÿ≥ÿßŸÜ€å €Å€í€î ÿß€å⁄© ÿ¢€åÿ™/ÿØÿπÿß Ÿæ⁄ë⁄æ ⁄©ÿ± ÿ≥ÿßŸÜÿ≥ ⁄©€å ÿ™ÿßŸÑ ŸÖ€å⁄∫ ÿØ€Åÿ±ÿßÿ¶€å⁄∫€î",
      anxiety: "ÿ™ŸéŸàŸéŸÉŸèŸëŸÑ ⁄©€í ÿ≥ÿßÿ™⁄æ ÿ™ÿØÿ®€åÿ±: ⁄Ü⁄æŸàŸπÿß ŸÇÿØŸÖ ŸÑ⁄©⁄æ€å⁄∫ ÿßŸàÿ± ÿ®ÿ≥ŸÖ ÿßŸÑŸÑ€Å ⁄©€Å€Å ⁄©ÿ± ÿ¥ÿ±Ÿàÿπ ⁄©ÿ±€å⁄∫€î",
      joy: "ÿßŸÑÿ≠ŸÖÿØŸèŸÑŸÑŸëŸ∞€Å ‚Äî ÿ¥⁄©ÿ± ÿßÿØÿß ⁄©ÿ±€å⁄∫ ÿßŸàÿ± ŸÜ€åÿ™ ⁄©ÿ±€å⁄∫ ⁄©€Å ÿßÿ≥ ŸÜÿπŸÖÿ™ ÿ≥€í ÿÆ€åÿ± ÿ®ÿßŸÜŸπ€å⁄∫€î",
      fear: "¬´ÿ≠Ÿéÿ≥Ÿíÿ®ŸêŸäŸé ÿßŸÑŸÑŸëŸ∞ŸáŸè ŸàŸéŸÜŸêÿπŸíŸÖŸé ÿßŸÑŸíŸàŸéŸÉŸêŸäŸÑŸè¬ª ‚Äî €å€Å ÿ∞⁄©ÿ± ÿØŸÑ ⁄©Ÿà ŸÖÿ∂ÿ®Ÿàÿ∑ ⁄©ÿ±ÿ™ÿß €Å€í€î",
      anger:"ŸÜÿ®€å Ô∑∫ ŸÜ€í ŸÅÿ±ŸÖÿß€åÿß: ÿ∫ÿµ€Å ÿ¢ÿ¶€í ÿ™Ÿà ÿÆÿßŸÖŸàÿ¥€å ÿßŸàÿ± Ÿàÿ∂Ÿà‚ÄîŸæ€ÅŸÑ€í ŸÜŸÅÿ≥ ⁄©Ÿà Ÿπ⁄æŸÜ⁄àÿßÿå Ÿæ⁄æÿ± ⁄ØŸÅÿ™⁄ØŸà€î"
    }
  };

  const base = t.neutral[em] || t.neutral.calm;
  if(style==='neutral') return base;

  const extra = (t[style] && t[style][em]) ? (" " + t[style][em]) : "";
  return base + extra;
}

/* ---------- Q/A Bridge (optional LLM) ---------- */
function isQuestion(text){
  return /[?ÿü]$/.test(text.trim()) || /\b(what|why|how|when|where|who|which|can|should|kya|kyun|kab|kais[ae]?|how much|kitna)\b/i.test(text);
}
async function askLLM(prompt){
  const url = (qaEndpoint.value||"").trim();
  if(!url) throw new Error("No endpoint set");
  const res = await fetch(url,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ prompt })
  });
  if(!res.ok) throw new Error("HTTP "+res.status);
  const data = await res.json();
  return (data.answer||data.output||data.text||"").toString();
}

/* ---------- Submit ---------- */
inp.addEventListener('input', e=>{
  inp.style.height='auto'; inp.style.height=Math.min(160, inp.scrollHeight)+'px';
});

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const text = inp.value.trim();
  if(!text) return;
  inp.value=''; inp.style.height='46px';
  addUser(text);

  // 1) Optional: try to answer if a question and switch is ON
  let answeredText = null;
  if(qaOn.checked && isQuestion(text)){
    try{
      typingOn();
      const ans = await askLLM(text);
      typingOff();
      if(ans){
        const dAns = detect(ans);
        auraTo(dAns.primary); setBackdrop(dAns.primary);
        addBot(`<div class="bot-title">Œ© AURA-X (answer):</div>${escapeHTML(ans)}`);
      }else{
        addBot(`<div class="bot-title">Œ© AURA-X:</div><span class="muted">No answer from endpoint.</span>`);
      }
      answeredText = ans||null;
    }catch(err){
      typingOff();
      addBot(`<div class="bot-title">Œ© AURA-X:</div><span class="muted">Answer mode error: ${escapeHTML(String(err.message||err))}</span>`);
    }
  }

  // 2) Local emotion + summary + guidance (always)
  const d = detect(text);
  auraTo(d.primary); setBackdrop(d.primary);

  const summary = summarise(text);
  const conf = Math.max(40, d.conf);
  const emoName = d.primary;
  const icon = (EMO[emoName]?.icon)||'ü´Å';

  const guidance = guide(emoName, guideStyle.value);

  const block = `
    <div class="bot-title">Œ© AURA-X:</div>
    <div>Your tone shows <b class="${emoName}">${emoName}</b> ‚Äî soft resonance ${icon}</div>
    <div class="muted" style="margin:6px 0 2px">Anchor with one calm breath in‚Ä¶ out ü´Å</div>
    <div><b>Continuity:</b> staying in <b class="${emoName}">${emoName}</b></div>
    <div class="echo"><b>Echo:</b> ‚Äú${escapeHTML(summary)}‚Äù</div>
    <div style="margin-top:10px">
      <b>Summary score:</b> <span class="${emoName}">${conf}% ${emoName}</span>
    </div>
    <div style="margin-top:8px"><b>Guidance (${escapeHTML(guideStyle.value)}):</b> ${escapeHTML(guidance)}</div>
  `;
  addBot(block);
});

/* Initial visual */
auraTo('calm'); setBackdrop('calm');
</script>
</body>
</html>
