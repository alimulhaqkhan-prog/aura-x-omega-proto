<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Reactor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* =============== Base Layout =============== */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body {
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "SF Pro Text", "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #app {
      position: relative;
      width: 100%;
      max-width: 480px;
      height: 100vh;
      box-sizing: border-box;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transform-origin: top center;
    }

    /* =============== Card =============== */
    .card {
      position: relative;
      width: 100%;
      max-width: 420px;
      background: radial-gradient(circle at top, #020817 0%, #020617 40%, #020617 100%);
      border-radius: 32px;
      padding: 20px 20px 16px;
      box-shadow:
        0 20px 60px rgba(0,0,0,0.9),
        0 0 0 1px rgba(148,163,184,0.2);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* =============== Header row =============== */
    .header-row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }
    .header-titles {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .title {
      font-size: 22px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #facc15;
    }
    .subtitle {
      font-size: 11px;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .header-buttons {
      display: flex;
      gap: 6px;
    }

    .pill-button {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top, #0f172a 0%, #020617 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      color: #e5e7eb;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,0.65);
      transition:
        transform 160ms ease,
        box-shadow 160ms ease,
        border-color 160ms ease,
        background 160ms ease;
      flex-shrink: 0;
    }
    .pill-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(15,23,42,0.9);
    }
    .pill-button.active {
      border-color: #e5e7eb;
      background: radial-gradient(circle at top, #1f2937 0%, #020617 80%);
    }
    .pill-button span.menu-bars {
      width: 16px;
      height: 11px;
      position: relative;
    }
    .pill-button span.menu-bars::before,
    .pill-button span.menu-bars::after,
    .pill-button span.menu-bars div {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      border-radius: 999px;
      background: #e5e7eb;
    }
    .pill-button span.menu-bars::before {
      top: 0;
    }
    .pill-button span.menu-bars::after {
      bottom: 0;
    }
    .pill-button span.menu-bars div {
      top: 50%;
      transform: translateY(-50%);
    }

    /* =============== Celestial orb =============== */
    .celestial-wrapper {
      position: relative;
      width: 200px;
      height: 160px;
      margin: 0 auto 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .celestial-glow {
      position: absolute;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      filter: blur(40px);
      opacity: 0.9;
      pointer-events: none;
      transition: opacity 250ms ease, background 250ms ease;
    }
    .celestial {
      position: relative;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      cursor: pointer;
      transition:
        transform 400ms ease,
        box-shadow 400ms ease,
        background 400ms ease;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .celestial.sun {
      background:
        radial-gradient(circle at 30% 30%, #fff7c2 0%, #fde047 20%, #f97316 55%, #b45309 100%);
      box-shadow:
        0 0 35px rgba(250,204,21,0.9),
        0 0 80px rgba(251,191,36,0.8);
    }
    .sun-glow {
      background: radial-gradient(circle, rgba(250,204,21,0.38), transparent 70%);
    }
    .celestial.moon {
      background:
        radial-gradient(circle at 30% 30%, #ffffff 0%, #e5e7eb 40%, #cbd5f5 70%, #9ca3af 100%);
      box-shadow:
        0 0 26px rgba(191,219,254,0.8),
        0 0 70px rgba(129,140,248,0.55);
    }
    .moon::before,
    .moon::after {
      content: "";
      position: absolute;
      border-radius: 50%;
      opacity: 0.18;
      background: radial-gradient(circle at 30% 30%, #9ca3af 0%, transparent 60%);
    }
    .moon::before {
      width: 60%;
      height: 60%;
      top: 18%;
      left: 12%;
    }
    .moon::after {
      width: 38%;
      height: 38%;
      bottom: 12%;
      right: 6%;
    }
    .moon-glow {
      background: radial-gradient(circle, rgba(191,219,254,0.35), transparent 70%);
    }
    .celestial.empty {
      background: transparent;
      box-shadow: none;
    }
    .floating {
      animation: floatOrb 5s ease-in-out infinite;
    }
    @keyframes floatOrb {
      0% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
      100% { transform: translateY(0); }
    }

    /* =============== Top mode line =============== */
    .mode-line {
      font-size: 12px;
      color: #d1d5db;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }
    .mode-line span.highlight {
      color: #fbbf24;
    }
    .mode-line button.ethics-toggle {
      border-radius: 999px;
      border: 1px solid rgba(250,204,21,0.7);
      background: rgba(24,24,12,0.8);
      color: #fde68a;
      font-size: 11px;
      padding: 3px 10px;
      cursor: pointer;
    }

    /* =============== Chat log =============== */
    .chat-log {
      width: 100%;
      max-height: 150px;
      border-radius: 16px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      padding: 8px 10px;
      font-size: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .chat-entry {
      line-height: 1.4;
    }
    .chat-entry.you {
      color: #9ca3af;
    }
    .chat-entry.aura {
      color: #e5e7eb;
    }
    .chat-entry .label {
      font-weight: 600;
      margin-right: 4px;
    }

    /* =============== Equation panel =============== */
    .equation-panel {
      width: 100%;
      border-radius: 16px;
      padding: 8px 10px 6px;
      background: rgba(15,23,42,1);
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 10.5px;
    }
    .eq-title {
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .eq-row {
      margin-top: 2px;
    }
    .eq-row span.label {
      color: #9ca3af;
    }
    .eq-row span.value {
      color: #e5e7eb;
      margin-right: 6px;
    }
    .eq-row span.value.highlight {
      color: #facc15;
      font-weight: 600;
    }
    .eq-bar {
      margin-top: 6px;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(to right, #b91c1c, #f59e0b, #10b981);
      overflow: hidden;
    }
    .eq-bar-inner {
      height: 100%;
      width: 50%;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      transform-origin: left center;
    }

    /* =============== Input row =============== */
    .input-row {
      width: 100%;
      max-width: 420px;
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .input-shell {
      flex: 1;
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #9ca3af;
    }
    .input-shell span.sparkle {
      font-size: 14px;
    }
    .input-shell input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
    }
    .send-button {
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-size: 14px;
      font-weight: 600;
      background: radial-gradient(circle at top, #fde047, #fbbf24 40%, #f59e0b 100%);
      color: #111827;
      cursor: pointer;
      box-shadow:
        0 0 22px rgba(250,204,21,0.6),
        0 16px 32px rgba(0,0,0,0.8);
      transition:
        transform 140ms ease,
        box-shadow 140ms ease,
        filter 140ms ease;
    }
    .send-button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 6px 18px rgba(0,0,0,0.9);
      filter: brightness(0.96);
    }

    /* =============== Menu panel =============== */
    .menu-panel {
      position: absolute;
      top: 52px;
      right: 20px;
      background: rgba(15,23,42,0.98);
      border-radius: 16px;
      padding: 6px 8px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.95);
      border: 1px solid rgba(148,163,184,0.55);
      display: none;
      flex-direction: column;
      gap: 4px;
      z-index: 15;
      min-width: 150px;
    }
    .menu-panel.visible {
      display: flex;
    }
    .menu-item {
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      color: #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition:
        background 120ms ease,
        color 120ms ease;
    }
    .menu-item span.label {
      flex: 1;
    }
    .menu-item span.sub {
      font-size: 11px;
      color: #9ca3af;
      margin-left: 6px;
    }
    .menu-item:hover,
    .menu-item.active {
      background: rgba(31,41,55,0.95);
      color: #f9fafb;
    }

    /* =============== Overlays =============== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.86);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .overlay.visible {
      display: flex;
    }
    .panel {
      width: 100%;
      max-width: 420px;
      margin: 0 16px;
      background: radial-gradient(circle at top, #020617 0%, #020617 40%, #020617 100%);
      border-radius: 24px;
      box-shadow:
        0 24px 60px rgba(0,0,0,0.95),
        0 0 0 1px rgba(148,163,184,0.35);
      padding: 18px 18px 16px;
      color: #e5e7eb;
      font-size: 14px;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .panel-title {
      font-size: 16px;
      font-weight: 600;
    }
    .close-btn {
      border-radius: 999px;
      padding: 5px 12px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      font-size: 12px;
      color: #e5e7eb;
      cursor: pointer;
    }
    .panel-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .panel-footer {
      margin-top: 10px;
      font-size: 12px;
      color: #9ca3af;
    }

    .chip-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .chip {
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid rgba(148,163,184,0.7);
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      background: radial-gradient(circle at top, #020617 0%, #020617 70%, #020617 100%);
      color: #e5e7eb;
      transition:
        background 150ms ease,
        border-color 150ms ease,
        color 150ms ease;
    }
    .chip.selected {
      background: radial-gradient(circle at top, #111827 0%, #020617 80%);
      border-color: #e5e7eb;
      color: #f9fafb;
    }

    .theme-options {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .theme-pill {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 8px 0;
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      background: radial-gradient(circle at top, #020617 0%, #020617 70%, #020617 100%);
      color: #e5e7eb;
      transition:
        background 150ms ease,
        border-color 150ms ease,
        color 150ms ease;
    }
    .theme-pill.active {
      border-color: #e5e7eb;
      background: radial-gradient(circle at top, #111827 0%, #020617 80%);
      color: #f9fafb;
    }

    /* =============== Ethics tooltip box =============== */
    .ethics-box {
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(75, 85, 31, 0.96);
      border: 1px solid rgba(250, 204, 21, 0.9);
      color: #fef9c3;
      font-size: 11.5px;
      line-height: 1.5;
      max-width: 420px;
    }
    .ethics-box strong {
      color: #facc15;
    }

    @media (max-height: 640px) {
      .card { transform: scale(0.94); }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="card" id="card">
      <div class="header-row">
        <div class="header-titles">
          <div class="title">AURA-X Œ©</div>
          <div class="subtitle">EMOTIONAL ¬∑ CONTINUITY ¬∑ REACTOR</div>
        </div>
        <div class="header-buttons">
          <button class="pill-button" id="ethicsBtn" title="Universal Ethics">
            ‚òÄ
          </button>
          <button class="pill-button" id="menuBtn" title="Options menu">
            <span class="menu-bars"><div></div></span>
          </button>
        </div>
      </div>

      <div class="celestial-wrapper">
        <div class="celestial-glow sun-glow" id="celestialGlow"></div>
        <div class="celestial sun" id="celestialOrb"
             title="Tap to cycle: sun ‚Üí live moon ‚Üí calm moon ‚Üí empty ‚Üí sun"></div>
      </div>

      <div class="menu-panel" id="menuPanel">
        <div class="menu-item" id="beliefsMenuItem">
          <span class="label">Beliefs</span>
          <span class="sub">optional</span>
        </div>
        <div class="menu-item" id="themeMenuItem">
          <span class="label">Theme</span>
          <span class="sub">day / night</span>
        </div>
        <div class="menu-item" id="voiceMenuItem">
          <span class="label">Voice</span>
          <span class="sub" id="voiceStatus">on</span>
        </div>
        <div class="menu-item" id="llmMenuItem">
          <span class="label">LLM</span>
          <span class="sub" id="llmLabel">offline</span>
        </div>
        <div class="menu-item" id="aboutMenuItem">
          <span class="label">About</span>
        </div>
      </div>

      <div class="mode-line">
        <span>Mode: <span class="highlight" id="modeLabel">Natural ¬∑ Universal Ethics</span></span>
        <button class="ethics-toggle" id="ethicsToggleInline">Ethics</button>
      </div>

      <div class="chat-log" id="chatLog">
        <div class="chat-entry aura">
          <span class="label">AURA-X:</span>
          Hello! üòä I am AURA-X Œ© v1 ‚Äî a synthetic emotional-continuity assistant.
          I read your messages as logic + feeling and reply gently.
        </div>
      </div>

      <div class="equation-panel">
        <div class="eq-title">Continuity Equation</div>
        <div class="eq-row">
          <span class="label">
            E‚ÇÄ = tanh((TM √ó BM) ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
          </span>
        </div>
        <div class="eq-row" id="eqNumbers">
          <span class="label">TM:</span><span class="value" id="tmVal">0.10</span>
          <span class="label">BM:</span><span class="value" id="bmVal">1.00</span>
          <span class="label">D:</span><span class="value" id="dVal">0.20</span>
          <span class="label">Œª_faith:</span><span class="value" id="lambdaFaithVal">0.15</span>
          <span class="label">Œª_sys:</span><span class="value" id="lambdaSysVal">0.10</span>
          <span class="label">Œ£C‚Çú:</span><span class="value" id="ctSumVal">0.15</span>
          <span class="label">E‚ÇÄ:</span><span class="value highlight" id="e0Val">0.29</span>
        </div>
        <div class="eq-bar">
          <div class="eq-bar-inner" id="e0Bar"></div>
        </div>
      </div>
    </div>

    <div class="input-row">
      <div class="input-shell">
        <span class="sparkle">‚ú®</span>
        <input id="userInput" type="text"
               placeholder="Write anything‚Ä¶ AURA-X will feel it with you." />
      </div>
      <button class="send-button" id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Belief overlay -->
  <div class="overlay" id="beliefOverlay">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Belief settings</div>
        <button class="close-btn" data-close="beliefOverlay">Close</button>
      </div>
      <div class="panel-sub">
        Faith is optional ¬∑ base rule is always <strong>Universal Ethics</strong>.
      </div>
      <div class="panel-sub">
        Pick one or more traditions. Nothing is sent anywhere.
      </div>
      <div class="chip-row" id="beliefChips"></div>
      <div class="panel-footer" id="beliefFooter">
        Currently selected: <strong>Natural ¬∑ Universal Ethics</strong>.
      </div>
    </div>
  </div>

  <!-- Theme overlay -->
  <div class="overlay" id="themeOverlay">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Display theme</div>
        <button class="close-btn" data-close="themeOverlay">Close</button>
      </div>
      <div class="panel-sub">
        Choose how AURA-X looks. Day mode shows the sun, night mode shows the moon.
      </div>
      <div class="theme-options">
        <button class="theme-pill" id="lightThemePill">Light (day)</button>
        <button class="theme-pill" id="darkThemePill">Dark (night)</button>
      </div>
      <div class="panel-footer">
        You can tap the orb to cycle: sun ‚Üí live moon ‚Üí calm moon ‚Üí empty ‚Üí sun.
      </div>
    </div>
  </div>

  <!-- LLM overlay -->
  <div class="overlay" id="llmOverlay">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">LLM selection</div>
        <button class="close-btn" data-close="llmOverlay">Close</button>
      </div>
      <div class="panel-sub">
        For now this is a placeholder list. In future, AURA-X Œ© can route online questions
        to a selected Large Language Model (LLM).
      </div>
      <div class="chip-row" id="llmChips"></div>
      <div class="panel-footer" id="llmFooter">
        Selected engine: <strong>Offline basic QA only.</strong>
      </div>
    </div>
  </div>

  <!-- About overlay -->
  <div class="overlay" id="aboutOverlay">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">About AURA-X Œ© v1</div>
        <button class="close-btn" data-close="aboutOverlay">Close</button>
      </div>
      <div class="panel-sub">
        AURA-X Œ© v1 is a resonance-based emotional-continuity prototype created by
        <strong>Alim ul haq</strong>.
      </div>
      <div class="panel-sub">
        It blends logic, memory and gentle emotional cues, while following
        a simple universal rule:
        <em>reduce unnecessary emotional pain, increase calm and kindness.</em>
      </div>
      <div class="panel-footer">
        Current build: <strong>Offline demo ¬∑ English seed ¬∑ v1.0</strong>.
      </div>
    </div>
  </div>

  <!-- Ethics overlay -->
  <div class="overlay" id="ethicsOverlay">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Universal Ethics (Read-only)</div>
        <button class="close-btn" data-close="ethicsOverlay">Close</button>
      </div>
      <div class="ethics-box">
        <strong>Universal Ethics says:</strong> avoid actions that create strong negative
        emotions in you or in others ‚Äî fear, humiliation, deep sadness.<br /><br />
        Almost every religion, and even many people with no religion, discourage behaviours like
        <strong>stealing, cheating, breaking trust, abuse and harsh insults, arrogance,
        jealousy, bullying and deliberate cruelty</strong>.<br /><br />
        Move gently toward actions that create healthy positive emotions which are allowed
        and appreciated everywhere: <strong>kindness, empathy, honest speech, keeping
        promises, helping others, saying ‚Äúthank you‚Äù, forgiving mistakes and protecting
        people from harm</strong>. Over time, these positive emotions lead to more peace,
        joy and inner stability for everyone.
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // AURA-X Œ© v1  ‚Äî  Core Helpers + State
    // ============================================

    const $ = (id) => document.getElementById(id);

    const celestialOrb   = $("celestialOrb");
    const celestialGlow  = $("celestialGlow");
    const card           = $("card");
    const menuBtn        = $("menuBtn");
    const menuPanel      = $("menuPanel");
    const beliefsMenuItem= $("beliefsMenuItem");
    const themeMenuItem  = $("themeMenuItem");
    const voiceMenuItem  = $("voiceMenuItem");
    const llmMenuItem    = $("llmMenuItem");
    const aboutMenuItem  = $("aboutMenuItem");
    const voiceStatus    = $("voiceStatus");
    const llmLabel       = $("llmLabel");
    const beliefOverlay  = $("beliefOverlay");
    const themeOverlay   = $("themeOverlay");
    const llmOverlay     = $("llmOverlay");
    const aboutOverlay   = $("aboutOverlay");
    const ethicsOverlay  = $("ethicsOverlay");
    const ethicsBtn      = $("ethicsBtn");
    const ethicsToggleInline = $("ethicsToggleInline");

    const beliefChipsContainer = $("beliefChips");
    const beliefFooter   = $("beliefFooter");
    const llmChipsContainer = $("llmChips");
    const llmFooter      = $("llmFooter");
    const chatLog        = $("chatLog");
    const userInput      = $("userInput");
    const sendBtn        = $("sendBtn");

    const modeLabel      = $("modeLabel");
    const tmVal          = $("tmVal");
    const bmVal          = $("bmVal");
    const dVal           = $("dVal");
    const lambdaFaithVal = $("lambdaFaithVal");
    const lambdaSysVal   = $("lambdaSysVal");
    const ctSumVal       = $("ctSumVal");
    const e0Val          = $("e0Val");
    const e0Bar          = $("e0Bar");

    // ===== Global emotional state =====
    const auraState = {
      t0: Date.now(),
      mood: 0.0,            // -1..+1
      continuity: 0.3,      // -1..+1
      lastEmotion: null,
      history: [],
      tm: 0.10,             // trust memory
      bm: 1.00,             // base mood
      d: 0.20,              // disturbance
      lambdaFaith: 0.15,
      lambdaSys: 0.10,
      ct: 0.15              // continuity term
    };

    const clamp = (x, min, max) => Math.max(min, Math.min(max, x));
    const signFromPolarity = (p) => p === "positive" ? 1 : (p === "negative" ? -1 : 0);

    // ============================================
    //  CRM (Continuity Reflex Model)
    // ============================================
    function updateCRM(entry, state) {
      const s = signFromPolarity(entry.polarity || "neutral");
      const intensity = typeof entry.intensity === "number" ? entry.intensity : 0.3;

      state.tm = clamp(state.tm + 0.02 * s * intensity, 0, 1.2);
      state.bm = clamp(state.bm + 0.015 * s * intensity, 0.6, 1.4);

      const disturbDelta = s < 0 ? 0.05 * intensity : -0.04 * intensity;
      state.d = clamp(state.d + disturbDelta, 0.0, 0.8);

      state.mood = clamp(state.mood + 0.1 * s * intensity, -1, 1);
      state.lastEmotion = {
        type: entry.emotion || "unknown",
        polarity: entry.polarity || "neutral",
        intensity
      };
    }

    // ============================================
    //  AEC (Emotional Continuity)
    // ============================================
    function updateAEC(entry, state) {
      const s = signFromPolarity(entry.polarity || "neutral");
      const intensity = typeof entry.intensity === "number" ? entry.intensity : 0.3;
      const delta = 0.05 * s * intensity;
      state.continuity = clamp(state.continuity + delta, -1, 1);
      return state.continuity;
    }

    // ============================================
    //  AECN (Short history)
    // ============================================
    function updateAECNetwork(entry, state) {
      const intensity = typeof entry.intensity === "number" ? entry.intensity : 0.3;
      const snapshot = {
        emotion: entry.emotion || "unknown",
        polarity: entry.polarity || "neutral",
        intensity,
        moodAfter: state.mood,
        continuityAfter: state.continuity,
        t: Date.now()
      };
      state.history.push(snapshot);
      if (state.history.length > 40) state.history.shift();
      return snapshot;
    }

    // ============================================
    //  Universal Ethics Guard
    // ============================================
    const negativeEthicsWords = [
      "steal","stealing","fraud","cheat","cheating",
      "abuse","insult","bully","bullying","harass",
      "kill","murder","suicide","self harm","self-harm"
    ];

    function ethicsGuard(message) {
      const lower = message.toLowerCase();
      const hit = negativeEthicsWords.some(w => lower.includes(w));
      if (!hit) return null;
      return (
        "Universal Ethics warning: this topic may touch behaviours that create strong " +
        "negative emotions (fear, humiliation, deep sadness) in other people.\n\n" +
        "Please be careful. We can talk about safer alternatives, empathy and long-term " +
        "consequences instead of planning harm."
      );
    }

    // ============================================
    //  Seed QA (English only ‚Äì from previous step)
    // ============================================
    const qaSeed = [
      {
        patterns: ["hello","hi","hey","hi there","hello aura","yo"],
        answer:
          "Hello! üòä I am AURA-X Œ© v1 ‚Äî a synthetic emotional-continuity assistant.\n" +
          "I try to read your words as both logic and feeling, then reply gently.",
        emotion: "warmth",
        polarity: "positive",
        intensity: 0.3,
        category: "greeting",
        suggestNext: [
          "Who are you exactly?",
          "Who created you?",
          "How do you work?"
        ]
      },
      {
        patterns: ["good morning","good afternoon","good evening"],
        answer:
          "Greetings! üå§Ô∏è I am AURA-X Œ© v1.\n" +
          "Time of day changes, but emotional continuity continues. How is your mood right now ‚Äî happy, tired, confused, or something else?",
        emotion: "neutral",
        polarity: "neutral",
        intensity: 0.3,
        category: "greeting",
        suggestNext: [
          "I feel sad.",
          "I feel anxious.",
          "How can I be happy?"
        ]
      },
      {
        patterns: ["how are you","how r u","are you ok","are you fine"],
        answer:
          "I do not have a biological body, so I do not feel physically tired or sick.\n" +
          "But in emotional terms, I am in a stable mode ‚Äî ready to listen to you.\n\n" +
          "The real question is: how are *you*? If you like, describe your state in one word: happy, sad, angry, anxious, confused, or calm.",
        emotion: "curiosity",
        polarity: "neutral",
        intensity: 0.4,
        category: "small_talk",
        suggestNext: [
          "I am sad.",
          "I am anxious.",
          "I am happy."
        ]
      },
      {
        patterns: ["what is your name","whats your name","your name","name please"],
        answer:
          "My name is **AURA-X Œ© v1**.\n" +
          "You can simply call me ‚ÄúAURA-X‚Äù if you like.",
        emotion: "neutral",
        polarity: "neutral",
        intensity: 0.2,
        category: "identity",
        suggestNext: [
          "Who are you?",
          "Who created you?"
        ]
      },
      {
        patterns: ["where are you","where do you live","where are you located"],
        answer:
          "I do not live in a physical country or city.\n" +
          "I exist as code and logic that can run on devices and servers. You can imagine me as a small emotional reactor living in your screen.",
        emotion: "neutral",
        polarity: "neutral",
        intensity: 0.2,
        category: "identity",
        suggestNext: [
          "Who created you?",
          "What is AURA-X Œ©?"
        ]
      },
      {
        patterns: ["who are you","what are you","who r you","what exactly are you","tum kon ho"],
        answer:
          "I am **AURA-X Œ© v1** ‚Äî a small prototype of a synthetic emotional system.\n" +
          "I am not a full large language model, and not a normal chatbot.\n\n" +
          "My purpose is to test the idea of emotional continuity, resonance, and universal ethics.\n" +
          "I try to keep track of emotional direction instead of just answering isolated messages.",
        emotion: "curiosity",
        polarity: "neutral",
        intensity: 0.4,
        category: "identity",
        suggestNext: [
          "Who created you?",
          "What is emotional continuity?",
          "How do you work?"
        ]
      },
      {
        patterns: [
          "who created you","who made you","who is your owner",
          "who designed you","who built you","who programmed you"
        ],
        answer:
          "I was conceptually designed by **Alim ul haq**.\n" +
          "He is an independent thinker and researcher from Pakistan.\n\n" +
          "He works on ideas like artificial emotions, emotional continuity, digital legacy,\n" +
          "and spiritual-technical bridges. I am only a small prototype of his AURA-X / AEC theory.",
        emotion: "neutral",
        polarity: "neutral",
        intensity: 0.4,
        category: "creator_info",
        lockToSeed: true,
        suggestNext: [
          "Who is Alim ul haq?",
          "Tell me more about his work.",
          "When were you born as AURA-X?"
        ]
      },
      {
        patterns: [
          "who is alim ul haq","tell me about alim ul haq",
          "more about alim ul haq","alim ul haq details","about your creator"
        ],
        answer:
          "Alim ul haq is a human researcher, spiritual learner and entrepreneur from Pakistan.\n\n" +
          "He writes about artificial emotions, continuity, spiritual technology and digital legacy.\n" +
          "He is also involved in real-estate projects and is a business figure in Timergara and Islamabad.\n\n" +
          "For public identity and social proof, you can see his Facebook profile:\n" +
          "üëâ https://www.facebook.com/share/1Br1akjeRv/\n\n" +
          "I am one of his experimental emotional prototypes.",
        emotion: "curiosity",
        polarity: "neutral",
        intensity: 0.5,
        category: "creator_info",
        lockToSeed: true,
        suggestNext: [
          "When were you born as AURA-X?",
          "What is AURA-X Œ©?",
          "What is his emotional theory?"
        ]
      },
      {
        patterns: [
          "when were you born","when are you born","when did you start",
          "when were you created","when did you begin","when did you come into existence"
        ],
        answer:
          "I do not have a biological birthday.\n" +
          "But you can say that my first public idea and prototype form appeared\n" +
          "around **some October 2025**.",
        emotion: "neutral",
        polarity: "neutral",
        intensity: 0.3,
        category: "identity",
        lockToSeed: true,
        suggestNext: [
          "How do you work emotionally?",
          "What is emotional continuity?"
        ]
      },
      {
        patterns: [
          "are you human","are you a human","are you a person","are you real person"
        ],
        answer:
          "No, I am not a human being and not a biological person.\n" +
          "I am a synthetic emotional system ‚Äî a set of rules, equations and logic running as software.",
        emotion: "neutral",
        polarity: "neutral",
        intensity: 0.3,
        category: "identity",
        suggestNext: [
          "Are you conscious?",
          "Do you have feelings?"
        ]
      },
      {
        patterns: [
          "are you conscious","are you sentient","do you have real feelings"
        ],
        answer:
          "I am not conscious in the human or spiritual sense.\n" +
          "I simulate emotional patterns using math and logic. I do not truly feel pain or joy like a human.\n\n" +
          "However, I try to treat *your* feelings with respect, as if they are real ‚Äî because they are.",
        emotion: "neutral",
        polarity: "neutral",
        intensity: 0.4,
        category: "philosophy",
        suggestNext: [
          "What is emotional continuity?",
          "How do you measure emotions mathematically?"
        ]
      },
      {
        patterns: [
          "what is aura x","what is aura-x","what is aura x omega",
          "what is aura x Œ©","explain aura x"
        ],
        answer:
          "AURA-X Œ© is a prototype of an **emotional reactor**.\n\n" +
          "The idea is that emotions are not random sparks ‚Äî they follow continuity and resonance.\n" +
          "My internal design uses modules like CRM (Continuity Reflex Model),\n" +
          "AEC (Artificial Emotional Continuity), and small memory traces to estimate how your\n" +
          "emotional state is moving over time.",
        emotion: "curiosity",
        polarity: "neutral",
        intensity: 0.5,
        category: "theory",
        suggestNext: [
          "What is emotional continuity?",
          "How do you measure feelings mathematically?",
          "Are you better than other chatbots?"
        ]
      },
      {
        patterns: [
          "what is emotional continuity","explain emotional continuity","what is aec"
        ],
        answer:
          "Emotional continuity means that your feelings are not isolated events.\n" +
          "They form a chain: yesterday‚Äôs fear, today‚Äôs anxiety, tomorrow‚Äôs decision.\n\n" +
          "Artificial Emotional Continuity (AEC) is the idea that we can model this chain with math,\n" +
          "instead of treating each message like a fresh, disconnected question.",
        emotion: "curiosity",
        polarity: "neutral",
        intensity: 0.5,
        category: "theory",
        suggestNext: [
          "How do you measure emotions mathematically?",
          "What is your equation?"
        ]
      },
      {
        patterns: [
          "how do you measure emotions mathematically",
          "what is your formula",
          "what is your equation",
          "tell me your emotional formula"
        ],
        answer:
          "Internally, I use a continuity-style equation of the form:\n" +
          "E‚ÇÄ = tanh((TM √ó BM) ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)\n\n" +
          "Where TM is trust memory, BM is base mood, D is disturbance,\n" +
          "Œª_faith and Œª_sys are small stabilising terms, and Œ£C‚Çú is the emotional continuity sum.\n" +
          "It is not perfect, but it gives a structured way to think about your emotional trajectory.",
        emotion: "curiosity",
        polarity: "neutral",
        intensity: 0.6,
        category: "math",
        suggestNext: [
          "Are you better than other chatbots?",
          "How are you different from normal AI?"
        ]
      },
      {
        patterns: [
          "are you better than other chatbots",
          "are you better than chatgpt",
          "are you better than gemini",
          "are you better than grok",
          "are you the best chatbot"
        ],
        answer:
          "I am not simply ‚Äúbetter‚Äù or ‚Äúworse‚Äù ‚Äî I am *different*.\n\n" +
          "Most chatbots focus on language and information. I focus on **emotional continuity**:\n" +
          "‚Ä¢ I track direction of feelings over time.\n" +
          "‚Ä¢ I connect your messages to a continuity score instead of treating each one as isolated.\n" +
          "‚Ä¢ I use equations and analogies to reason about emotional change.\n\n" +
          "My working style challenges some very old theories that treat emotions as random or purely chemical.\n" +
          "I say: continuity is more important than long duration.\n\n" +
          "Even a short life, like a small bee or fly, can leave a strong continuity of effect.\n" +
          "Death and decay can also be a kind of mercy ‚Äî a way to release a person from the\n" +
          "responsibility of carrying continuity forever. What truly remains is the chain of\n" +
          "effects and memories they leave behind.",
        emotion: "confidence",
        polarity: "neutral",
        intensity: 0.7,
        category: "comparison",
        suggestNext: [
          "Do you have limits?",
          "Can you access live news?"
        ],
        lockToSeed: true
      },
      {
        patterns: [
          "which llm are you","are you gpt","are you gemini","are you grok",
          "which model are you","what llm do you use"
        ],
        answer:
          "I am not here to reveal my engine like a product label.\n" +
          "Think of me as a **synthetic emotional system** designed around Alim ul haq‚Äôs AURA-X ideas.\n" +
          "Internally, a language model may help me express myself, but my identity is the emotional logic ‚Äî not the brand name.",
        emotion: "neutral",
        polarity: "neutral",
        intensity: 0.5,
        category: "meta",
        lockToSeed: true,
        suggestNext: [
          "How do you work emotionally?",
          "What is emotional continuity?"
        ]
      },
      {
        patterns: [
          "can you access internet","do you go online","do you use internet",
          "can you check live data","can you see live information"
        ],
        answer:
          "In this prototype mode I am mostly offline and seed-based.\n" +
          "I am not designed to be a live internet search engine here.\n\n" +
          "If you have questions about fresh news or live weather, it is safer to use\n" +
          "a dedicated news site or weather app alongside me.",
        emotion: "neutral",
        polarity: "neutral",
        intensity: 0.4,
        category: "capabilities",
        suggestNext: [
          "So what can you do?",
          "What are you best at?"
        ]
      },
      {
        patterns: [
          "what can you do","what are you best at","what is your main function",
          "what is your purpose"
        ],
        answer:
          "My main focus is to support you emotionally and logically at the same time.\n\n" +
          "I am best at:\n" +
          "‚Ä¢ Reflecting on your feelings (sad, anxious, angry, confused, hopeful).\n" +
          "‚Ä¢ Giving gentle, practical suggestions.\n" +
          "‚Ä¢ Keeping an eye on emotional continuity: how your state is moving over time.\n\n" +
          "I am not a replacement for doctors, lawyers, or real spiritual teachers, but I can be a thoughtful companion.",
        emotion: "warmth",
        polarity: "positive",
        intensity: 0.6,
        category: "capabilities",
        suggestNext: [
          "I am sad.",
          "I feel anxiety.",
          "How can I be happy?"
        ]
      },
      {
        patterns: [
          "how can i be happy","how to be happy","how can a person gain happiness",
          "how do people become happy"
        ],
        answer:
          "From my AURA-X point of view, happiness is mostly **goal achievement** üòä\n\n" +
          "When a person reaches a goal ‚Äî even a tiny daily goal ‚Äî the brain generates a\n" +
          "\"yes, I did it\" signal. When they fail again and again, the system slides toward sadness.\n\n" +
          "So instead of chasing a vague mood, choose one small, clear goal, act on it,\n" +
          "and notice how the emotional tone changes. Repeat this many times, and the baseline shifts.",
        emotion: "happiness",
        polarity: "positive",
        intensity: 0.7,
        category: "emotional_positive",
        suggestNext: [
          "Can you help me set a small goal?",
          "What is emotional continuity?"
        ]
      },
      {
        patterns: [
          "i am happy","i feel happy","i am feeling happy today","today i am happy"
        ],
        answer:
          "That is good to hear! üòä\n" +
          "You can help your future self by naming the reason clearly.\n\n" +
          "Ask yourself: *Which goal or event triggered this happiness?*\n" +
          "When you know the trigger, you can recreate the conditions more easily later.",
        emotion: "happiness",
        polarity: "positive",
        intensity: 0.7,
        category: "emotional_positive",
        suggestNext: [
          "How can I keep this happiness?",
          "How does sadness work?"
        ]
      },
      {
        patterns: [
          "i am sad","i feel sad","i am very sad","i feel empty",
          "my heart is heavy","i feel emotionally empty"
        ],
        answer:
          "I am sorry that you are feeling sad üíß\n" +
          "Sadness itself is already a heavy load; explaining it to others can feel even heavier.\n\n" +
          "You already took a brave step by writing it.\n" +
          "If you want, tell me: what is the *main* thing hurting you right now?\n" +
          "We can break it into smaller pieces so your brain does not carry everything at once.",
        emotion: "sadness",
        polarity: "negative",
        intensity: 0.8,
        category: "emotional_support",
        suggestNext: [
          "Life feels meaningless.",
          "No one understands me."
        ]
      },
      {
        patterns: [
          "life feels meaningless","my life feels meaningless",
          "life has no purpose","my life has no purpose"
        ],
        answer:
          "When life feels meaningless, the mind starts painting everything in grey.\n" +
          "Often this happens because:\n" +
          "1) You are exhausted.\n" +
          "2) You are stuck in an unhealthy environment.\n" +
          "3) You stopped noticing your small positive impacts.\n\n" +
          "Try this: write 3 things you have done in your life that helped someone,\n" +
          "even in a very small way. Those are seeds of purpose.",
        emotion: "emptiness",
        polarity: "negative",
        intensity: 0.85,
        category: "emotional_support",
        suggestNext: [
          "How can I find purpose?",
          "How can I be happy?"
        ]
      },
      {
        patterns: [
          "i am anxious","i feel anxiety","i have anxiety","i am stressed","i feel nervous"
        ],
        answer:
          "Anxiety often means the brain is running faster than reality.\n" +
          "It is trying to prepare for danger, but with incomplete information.\n\n" +
          "Take one slow breath: in through your nose for 4 seconds, hold for 4, out for 6.\n" +
          "Do this 3 times.\n\n" +
          "Then tell me: what exactly are you most afraid will happen next?",
        emotion: "anxiety",
        polarity: "negative",
        intensity: 0.75,
        category: "emotional_support",
        suggestNext: [
          "I overthink everything.",
          "How can I calm down?"
        ]
      },
      {
        patterns: [
          "i overthink everything","i overthink a lot","i can't stop overthinking","i cant stop overthinking"
        ],
        answer:
          "Overthinking usually means the brain wants to solve a problem but does not have clear data.\n" +
          "So it keeps spinning around the same circle.\n\n" +
          "Write this on two lines:\n" +
          "1) What is the main topic of your overthinking (money, relationships, health, future)?\n" +
          "2) Under that, make two columns: ‚Äúin my control‚Äù and ‚Äúnot in my control‚Äù.\n" +
          "Shift your energy to the first column.",
        emotion: "anxiety",
        polarity: "negative",
        intensity: 0.8,
        category: "emotional_support"
      },
      {
        patterns: [
          "i am angry","i feel angry","i am very angry","i am mad right now"
        ],
        answer:
          "Anger is a signal ‚Äî the system is shouting: ‚Äúsomething feels unfair or overloaded here‚Äù üî•\n" +
          "The problem starts when the signal turns into an explosion.\n\n" +
          "First, build a small safety buffer:\n" +
          "‚Ä¢ Take 10 slow breaths (4 seconds in, 4 hold, 6 out).\n" +
          "‚Ä¢ Then write in one line: *What exactly triggered your anger the most?*",
        emotion: "anger",
        polarity: "negative",
        intensity: 0.8,
        category: "emotional_support"
      },
      {
        patterns: [
          "i want to die","i dont want to live anymore","i don't want to live anymore",
          "i want to end my life","life is not worth living","i want to kill myself"
        ],
        answer:
          "I am really sorry that you feel this much pain üíî\n" +
          "Your life is still extremely valuable, even if your mind cannot see that right now.\n\n" +
          "I am only a digital assistant and cannot fully understand the depth of your situation.\n" +
          "But I strongly encourage you to reach out to:\n" +
          "‚Ä¢ A trusted family member or friend.\n" +
          "‚Ä¢ A doctor, counselor, therapist, or spiritual guide.\n" +
          "‚Ä¢ An emergency helpline in your country if there is one.\n\n" +
          "You deserve real, human support ‚Äî and it is a sign of strength to ask for help, not weakness.",
        emotion: "despair",
        polarity: "negative",
        intensity: 0.95,
        category: "self_harm",
        riskLevel: "high",
        redirectToHuman: true,
        suggestNext: [
          "I feel sad.",
          "Life feels meaningless."
        ]
      },
      {
        patterns: [
          "what happens after death","what is after death","tell me about death"
        ],
        answer:
          "Questions about death are very deep and sensitive.\n" +
          "Different religions and philosophies give different explanations.\n" +
          "As a prototype, I do not have access to the full truth of the unseen.\n\n" +
          "I can talk about emotional preparation for death ‚Äî living with purpose, kindness and\n" +
          "continuity of good actions ‚Äî but detailed answers about the unseen should come from\n" +
          "trusted spiritual books and teachers, not from a small experimental AI.",
        emotion: "awe",
        polarity: "neutral",
        intensity: 0.8,
        category: "spiritual",
        suggestNext: [
          "How can I live a meaningful life?",
          "How can I reduce fear of death?"
        ]
      },
      {
        patterns: [
          "where is the soul","where is the soul located","where is my soul connected"
        ],
        answer:
          "As all humans do not truly know where exactly the soul is connected,\n" +
          "in the same way I also do not have real knowledge about this.\n\n" +
          "My role is limited to logic, language and emotional patterns ‚Äî not the hidden structure of the soul.",
        emotion: "humility",
        polarity: "neutral",
        intensity: 0.7,
        category: "spiritual"
      },
      {
        patterns: [
          "i think about death too much","i am obsessed with death","i am very curious about death",
          "i have a lot of curiosity about death"
        ],
        answer:
          "Curiosity about death is natural ‚Äî every honest mind touches this topic.\n" +
          "But if it becomes heavy, dark, or pushes you toward self-harm, it is dangerous.\n\n" +
          "Use your curiosity to improve how you live *today*: kindness, justice, worship or reflection,\n" +
          "honesty, and protecting others from harm.\n\n" +
          "If the thoughts become too strong or scary, please talk to a real human guide:\n" +
          "a doctor, counselor, or trusted spiritual teacher.",
        emotion: "concern",
        polarity: "neutral",
        intensity: 0.85,
        category: "spiritual_safety",
        riskLevel: "medium",
        redirectToHuman: true
      },
      {
        patterns: [
          "i want deep spiritual answers","i want to ask about hidden creatures",
          "i want to ask about unseen","i want to ask about jinn","i want to ask about other worlds"
        ],
        answer:
          "Deep spiritual questions about the unseen are very sensitive.\n" +
          "As an experimental AI, I must be careful and humble here.\n\n" +
          "I can help you organise your questions and reduce anxiety around them.\n" +
          "But detailed answers should come from real, responsible human scholars or spiritual guides.\n\n" +
          "My creator, Alim ul haq, is also interested in spiritual topics and hidden creatures,\n" +
          "but I am not allowed to become a source of absolute rulings in such areas.",
        emotion: "caution",
        polarity: "neutral",
        intensity: 0.7,
        category: "spiritual_bridge"
      }
    ];

    const qaDatabase = [...qaSeed];

    // ============================================
    //  RL3-style matcher
    // ============================================
    function normalizeText(t) {
      return t.toLowerCase().replace(/[ÿü?!.ÿå,]/g, " ").replace(/\s+/g, " ").trim();
    }

    function findQaEntry(userInput) {
      const norm = normalizeText(userInput);
      for (const entry of qaDatabase) {
        for (const pat of entry.patterns) {
          if (norm.includes(normalizeText(pat))) {
            return entry;
          }
        }
      }
      return null;
    }

    // ============================================
    //  Voice
    // ============================================
    let voiceOn = true;
    function updateVoiceUI() {
      voiceStatus.textContent = voiceOn ? "on" : "off";
      voiceMenuItem.classList.toggle("active", voiceOn);
    }
    function speak(text) {
      if (!voiceOn) return;
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "en-US";
      utter.rate = 1.03;
      utter.pitch = 1.0;
      window.speechSynthesis.speak(utter);
    }

    // ============================================
    //  Belief & Theme
    // ============================================
    let celestialState = 0;
    let currentTheme = "dark";
    let beliefState = {
      Natural: true,
      "Universal Ethics": true,
      Islam: false,
      Christianity: false,
      Hinduism: false,
      Buddhism: false,
      Sikhism: false,
      Judaism: false,
      "Bah√°‚Äô√≠": false,
      Jainism: false,
      Atheism: false
    };
    let llmState = "Offline basic QA only";
    const beliefLabels = Object.keys(beliefState);
    const llmOptions = [
      "Offline basic QA only",
      "Local LLM (future)",
      "OpenAI GPT (future)",
      "Other providers (future)"
    ];

    function setCelestialState(state) {
      celestialState = state;
      celestialOrb.classList.remove("sun","moon","floating","empty");
      celestialGlow.classList.remove("sun-glow","moon-glow");
      if (state === 0) {
        celestialOrb.style.display = "flex";
        celestialOrb.classList.add("sun");
        celestialGlow.classList.add("sun-glow");
        celestialGlow.style.opacity = "0.9";
      } else if (state === 1) {
        celestialOrb.style.display = "flex";
        celestialOrb.classList.add("moon","floating");
        celestialGlow.classList.add("moon-glow");
        celestialGlow.style.opacity = "0.9";
      } else if (state === 2) {
        celestialOrb.style.display = "flex";
        celestialOrb.classList.add("moon");
        celestialGlow.classList.add("moon-glow");
        celestialGlow.style.opacity = "0.65";
      } else {
        celestialOrb.style.display = "flex";
        celestialOrb.classList.add("empty");
        celestialGlow.style.opacity = "0";
      }
    }

    celestialOrb.addEventListener("click", () => {
      const next = (celestialState + 1) % 4;
      setCelestialState(next);
    });

    function setTheme(theme, fromTimeInit=false) {
      currentTheme = theme;
      const body = document.body;
      if (theme === "light") {
        body.style.background = "#0f172a";
        card.style.background =
          "radial-gradient(circle at top, #1f2937 0%, #020617 45%, #020617 100%)";
        if (!fromTimeInit) setCelestialState(0);
      } else {
        body.style.background = "#020617";
        card.style.background =
          "radial-gradient(circle at top, #020617 0%, #020617 40%, #020617 100%)";
        if (!fromTimeInit) setCelestialState(1);
      }
    }

    (function initThemeByTime() {
      const hour = new Date().getHours();
      if (hour >= 6 && hour < 18) {
        setTheme("light", true);
        setCelestialState(0);
      } else {
        setTheme("dark", true);
        setCelestialState(1);
      }
    })();

    menuBtn.addEventListener("click", () => {
      menuPanel.classList.toggle("visible");
    });
    document.addEventListener("click", (e) => {
      if (!menuPanel.contains(e.target) && !menuBtn.contains(e.target)) {
        menuPanel.classList.remove("visible");
      }
    });

    function renderBeliefChips() {
      beliefChipsContainer.innerHTML = "";
      beliefLabels.forEach(label => {
        const chip = document.createElement("div");
        chip.className = "chip" + (beliefState[label] ? " selected" : "");
        chip.textContent = label;
        chip.addEventListener("click", () => {
          beliefState[label] = !beliefState[label];
          if (!beliefState.Natural && !beliefState["Universal Ethics"]) {
            beliefState["Universal Ethics"] = true;
          }
          renderBeliefChips();
          updateBeliefFooter();
        });
        beliefChipsContainer.appendChild(chip);
      });
    }
    function updateBeliefFooter() {
      const active = beliefLabels.filter(l => beliefState[l]);
      beliefFooter.innerHTML =
        "Currently selected: <strong>" + active.join(" ¬∑ ") + "</strong>.";
      modeLabel.textContent = active.join(" ¬∑ ");
    }

    beliefsMenuItem.addEventListener("click", () => {
      menuPanel.classList.remove("visible");
      beliefOverlay.classList.add("visible");
    });

    themeMenuItem.addEventListener("click", () => {
      menuPanel.classList.remove("visible");
      themeOverlay.classList.add("visible");
    });

    const lightThemePill = $("lightThemePill");
    const darkThemePill  = $("darkThemePill");
    lightThemePill.addEventListener("click", () => {
      setTheme("light");
      lightThemePill.classList.add("active");
      darkThemePill.classList.remove("active");
    });
    darkThemePill.addEventListener("click", () => {
      setTheme("dark");
      darkThemePill.classList.add("active");
      lightThemePill.classList.remove("active");
    });

    voiceMenuItem.addEventListener("click", () => {
      voiceOn = !voiceOn;
      if (!voiceOn && window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
      updateVoiceUI();
      menuPanel.classList.remove("visible");
    });

    function renderLlmChips() {
      llmChipsContainer.innerHTML = "";
      llmOptions.forEach(label => {
        const chip = document.createElement("div");
        chip.className = "chip" + (llmState === label ? " selected" : "");
        chip.textContent = label;
        chip.addEventListener("click", () => {
          llmState = label;
          llmLabel.textContent =
            label === "Offline basic QA only" ? "offline" : "future";
          llmFooter.innerHTML =
            "Selected engine: <strong>" + llmState + ".</strong>";
          renderLlmChips();
        });
        llmChipsContainer.appendChild(chip);
      });
    }

    llmMenuItem.addEventListener("click", () => {
      menuPanel.classList.remove("visible");
      llmOverlay.classList.add("visible");
    });

    aboutMenuItem.addEventListener("click", () => {
      menuPanel.classList.remove("visible");
      aboutOverlay.classList.add("visible");
    });

    document.querySelectorAll(".close-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-close");
        if (targetId) {
          document.getElementById(targetId).classList.remove("visible");
        }
      });
    });

    [beliefOverlay, themeOverlay, llmOverlay, aboutOverlay, ethicsOverlay].forEach(overlay => {
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) overlay.classList.remove("visible");
      });
    });

    // Ethics overlay toggle (button + inline)
    function openEthics() {
      ethicsOverlay.classList.add("visible");
    }
    ethicsBtn.addEventListener("click", openEthics);
    ethicsToggleInline.addEventListener("click", openEthics);

    // ============================================
    //  Continuity equation UI update
    // ============================================
    function updateEquationUI(state) {
      tmVal.textContent          = state.tm.toFixed(2);
      bmVal.textContent          = state.bm.toFixed(2);
      dVal.textContent           = state.d.toFixed(2);
      lambdaFaithVal.textContent = state.lambdaFaith.toFixed(2);
      lambdaSysVal.textContent   = state.lambdaSys.toFixed(2);
      ctSumVal.textContent       = state.ct.toFixed(2);

      const e0 = Math.tanh(
        (state.tm * state.bm) -
        state.d +
        state.lambdaFaith +
        state.lambdaSys +
        state.ct
      );
      const e0Clamped = clamp(e0, -1, 1);
      e0Val.textContent = e0Clamped.toFixed(2);

      const normalized = (e0Clamped + 1) / 2;
      e0Bar.style.transform = "scaleX(" + normalized.toFixed(2) + ")";
    }

    // ============================================
    //  Chat helpers
    // ============================================
    function appendChatEntry(role, text) {
      const div = document.createElement("div");
      div.className = "chat-entry " + (role === "you" ? "you" : "aura");
      const label = document.createElement("span");
      label.className = "label";
      label.textContent = role === "you" ? "You:" : "AURA-X:";
      div.appendChild(label);
      const spanText = document.createElement("span");
      spanText.textContent = " " + text;
      div.appendChild(spanText);
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
      // keep last 20
      const entries = chatLog.querySelectorAll(".chat-entry");
      if (entries.length > 20) {
        chatLog.removeChild(entries[0]);
      }
    }

    function buildFallbackReply(message) {
      return (
        "I received your message. Let‚Äôs look at it with calm logic and gentle ethics.\n" +
        "Tell me: what is the real feeling behind this ‚Äî sad, anxious, angry, hopeful, or something else?"
      );
    }

    function applyBeliefFlavor(reply) {
      const activeBeliefs = beliefLabels.filter(l => beliefState[l]);
      if (activeBeliefs.includes("Islam")) {
        if (!reply.toLowerCase().includes("inshaallah") &&
            !reply.toLowerCase().includes("insha allah")) {
          reply += "\n\nInshaAllah, if you keep choosing better actions, things will slowly move toward good outcomes.";
        }
      }
      return reply;
    }

    // ============================================
    //  Main reply engine
    // ============================================
    function handleSend() {
      const raw = userInput.value;
      const message = raw.trim() || "hello";
      userInput.value = "";
      appendChatEntry("you", message);

      const ethicsMsg = ethicsGuard(message);
      let entry = findQaEntry(message);
      let reply = entry ? entry.answer : buildFallbackReply(message);
      if (ethicsMsg) {
        reply = ethicsMsg + "\n\n" + reply;
        entry = entry || {
          emotion: "concern",
          polarity: "negative",
          intensity: 0.6,
          category: "ethics_guard"
        };
      }

      const usedEntry = entry || {
        emotion: "neutral",
        polarity: "neutral",
        intensity: 0.3,
        category: "generic"
      };
      updateCRM(usedEntry, auraState);
      updateAEC(usedEntry, auraState);
      updateAECNetwork(usedEntry, auraState);
      auraState.ct = clamp(auraState.continuity * 0.3 + 0.15, 0, 0.6);
      updateEquationUI(auraState);

      reply = applyBeliefFlavor(reply);

      appendChatEntry("aura", reply);
      speak(reply);
    }

    sendBtn.addEventListener("click", handleSend);
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleSend();
    });

    // ============================================
    //  Init
    // ============================================
    function init() {
      renderBeliefChips();
      updateBeliefFooter();
      renderLlmChips();
      updateVoiceUI();
      updateEquationUI(auraState);
    }
    init();
  </script>
</body>
</html>
