<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Î© â€“ Emotional Reactor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ===== Base Layout ===== */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body {
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "SF Pro Text", "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #app {
      position: relative;
      width: 100%;
      max-width: 480px;
      height: 100vh;
      box-sizing: border-box;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transform-origin: top center;
    }

    /* ===== Card ===== */
    .card {
      position: relative;
      width: 100%;
      max-width: 420px;
      background: radial-gradient(circle at top, #020817 0%, #020617 40%, #020617 100%);
      border-radius: 32px;
      padding: 20px 20px 20px;
      box-shadow:
        0 20px 60px rgba(0,0,0,0.9),
        0 0 0 1px rgba(148,163,184,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    /* ===== Header row ===== */
    .header-row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .header-titles {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .title {
      font-size: 22px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #facc15;
      text-align: left;
    }
    .subtitle {
      font-size: 11px;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      color: #9ca3af;
      text-align: left;
    }

    /* ===== Menu button ===== */
    .pill-button {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top, #0f172a 0%, #020617 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      color: #e5e7eb;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,0.65);
      transition:
        transform 160ms ease,
        box-shadow 160ms ease,
        border-color 160ms ease,
        background 160ms ease;
      flex-shrink: 0;
    }
    .pill-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(15,23,42,0.9);
    }
    .pill-button.active {
      border-color: #e5e7eb;
      background: radial-gradient(circle at top, #1f2937 0%, #020617 80%);
    }
    .pill-button span.menu-bars {
      width: 16px;
      height: 11px;
      position: relative;
    }
    .pill-button span.menu-bars::before,
    .pill-button span.menu-bars::after,
    .pill-button span.menu-bars div {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      border-radius: 999px;
      background: #e5e7eb;
    }
    .pill-button span.menu-bars::before {
      top: 0;
    }
    .pill-button span.menu-bars::after {
      bottom: 0;
    }
    .pill-button span.menu-bars div {
      top: 50%;
      transform: translateY(-50%);
    }

    /* ===== Celestial orb ===== */
    .celestial-wrapper {
      position: relative;
      width: 200px;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
    }
    .celestial-glow {
      position: absolute;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      filter: blur(40px);
      opacity: 0.9;
      pointer-events: none;
      transition: opacity 250ms ease, background 250ms ease;
    }
    .celestial {
      position: relative;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      cursor: pointer;
      transition:
        transform 400ms ease,
        box-shadow 400ms ease,
        background 400ms ease;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    /* Sun */
    .celestial.sun {
      background:
        radial-gradient(circle at 30% 30%, #fff7c2 0%, #fde047 20%, #f97316 55%, #b45309 100%);
      box-shadow:
        0 0 35px rgba(250,204,21,0.9),
        0 0 80px rgba(251,191,36,0.8);
    }
    .sun-glow {
      background: radial-gradient(circle, rgba(250,204,21,0.38), transparent 70%);
    }

    /* Moon */
    .celestial.moon {
      background:
        radial-gradient(circle at 30% 30%, #ffffff 0%, #e5e7eb 40%, #cbd5f5 70%, #9ca3af 100%);
      box-shadow:
        0 0 26px rgba(191,219,254,0.8),
        0 0 70px rgba(129,140,248,0.55);
    }
    .moon::before,
    .moon::after {
      content: "";
      position: absolute;
      border-radius: 50%;
      opacity: 0.18;
      background: radial-gradient(circle at 30% 30%, #9ca3af 0%, transparent 60%);
    }
    .moon::before {
      width: 60%;
      height: 60%;
      top: 18%;
      left: 12%;
    }
    .moon::after {
      width: 38%;
      height: 38%;
      bottom: 12%;
      right: 6%;
    }
    .moon-glow {
      background: radial-gradient(circle, rgba(191,219,254,0.35), transparent 70%);
    }

    /* Empty */
    .celestial.empty {
      background: transparent;
      box-shadow: none;
    }

    /* Floating */
    .floating {
      animation: floatOrb 5s ease-in-out infinite;
    }
    @keyframes floatOrb {
      0%   { transform: translateY(0); }
      50%  { transform: translateY(-8px); }
      100% { transform: translateY(0); }
    }

    /* ===== Text sections ===== */
    .mode-line {
      font-size: 12px;
      color: #d1d5db;
      margin-top: 4px;
    }
    .mode-line span {
      color: #fbbf24;
    }
    .you-said {
      font-size: 12px;
      color: #9ca3af;
    }
    .assistant-text {
      font-size: 14px;
      text-align: center;
      margin-top: 4px;
      margin-bottom: 10px;
      white-space: pre-line;
    }
    .ethics-box {
      width: 100%;
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(248,250,252,0.06);
      color: #e5e7eb;
      font-size: 12px;
      line-height: 1.45;
    }

    /* ===== Equation box ===== */
    .equation-box {
      width: 100%;
      border-radius: 16px;
      padding: 10px 12px;
      margin-top: 4px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 11px;
      line-height: 1.5;
    }
    .equation-title {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .equation-line {
      font-family: "SF Mono","JetBrains Mono",monospace;
      font-size: 11px;
      margin-bottom: 4px;
    }
    .equation-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      margin-top: 4px;
    }
    .metric {
      font-size: 11px;
      color: #e5e7eb;
    }
    .metric span {
      color: #facc15;
    }
    .continuity-bar-shell {
      margin-top: 6px;
      width: 100%;
      height: 5px;
      border-radius: 999px;
      background: linear-gradient(to right,#dc2626,#f97316,#22c55e);
      position: relative;
      overflow: hidden;
    }
    .continuity-bar-thumb {
      position: absolute;
      top: -3px;
      width: 3px;
      height: 11px;
      border-radius: 999px;
      background: #f9fafb;
      box-shadow: 0 0 10px rgba(248,250,252,0.9);
      transform: translateX(50%);
      transition: transform 220ms ease;
    }

    /* ===== Input bar ===== */
    .input-row {
      width: 100%;
      max-width: 420px;
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .input-shell {
      flex: 1;
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #9ca3af;
    }
    .input-shell span.sparkle {
      font-size: 14px;
    }
    .input-shell input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
    }
    .send-button {
      border: none;
      border-radius: 999px;
      padding: 10px 26px;
      font-size: 14px;
      font-weight: 600;
      background: radial-gradient(circle at top, #fde047, #fbbf24 40%, #f59e0b 100%);
      color: #111827;
      cursor: pointer;
      box-shadow:
        0 0 22px rgba(250,204,21,0.6),
        0 16px 32px rgba(0,0,0,0.8);
      transition:
        transform 140ms ease,
        box-shadow 140ms ease,
        filter 140ms ease;
    }
    .send-button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 6px 18px rgba(0,0,0,0.9);
      filter: brightness(0.96);
    }

    /* ===== Menu panel ===== */
    .menu-panel {
      position: absolute;
      top: 52px;
      right: 20px;
      background: rgba(15,23,42,0.98);
      border-radius: 16px;
      padding: 6px 8px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.95);
      border: 1px solid rgba(148,163,184,0.55);
      display: none;
      flex-direction: column;
      gap: 4px;
      z-index: 15;
      min-width: 150px;
    }
    .menu-panel.visible {
      display: flex;
    }
    .menu-item {
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      color: #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition:
        background 120ms ease,
        color 120ms ease;
    }
    .menu-item span.label {
      flex: 1;
    }
    .menu-item span.sub {
      font-size: 11px;
      color: #9ca3af;
      margin-left: 6px;
    }
    .menu-item:hover {
      background: rgba(31,41,55,0.95);
    }
    .menu-item.active {
      background: rgba(31,41,55,0.95);
      color: #f9fafb;
    }

    /* ===== Overlays ===== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.86);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .overlay.visible {
      display: flex;
    }
    .panel {
      width: 100%;
      max-width: 420px;
      margin: 0 16px;
      background: radial-gradient(circle at top, #020617 0%, #020617 40%, #020617 100%);
      border-radius: 24px;
      box-shadow:
        0 24px 60px rgba(0,0,0,0.95),
        0 0 0 1px rgba(148,163,184,0.35);
      padding: 18px 18px 16px;
      color: #e5e7eb;
      font-size: 14px;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .panel-title {
      font-size: 16px;
      font-weight: 600;
    }
    .close-btn {
      border-radius: 999px;
      padding: 5px 12px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      font-size: 12px;
      color: #e5e7eb;
      cursor: pointer;
    }
    .chip-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .chip {
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid rgba(148,163,184,0.7);
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      background: radial-gradient(circle at top, #020617 0%, #020617 70%, #020617 100%);
      color: #e5e7eb;
      transition:
        background 150ms ease,
        border-color 150ms ease,
        color 150ms ease;
    }
    .chip.selected {
      background: radial-gradient(circle at top, #111827 0%, #020617 80%);
      border-color: #e5e7eb;
      color: #f9fafb;
    }
    .panel-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .panel-footer {
      margin-top: 10px;
      font-size: 12px;
      color: #9ca3af;
    }
    .theme-options {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .theme-pill {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 8px 0;
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      background: radial-gradient(circle at top, #020617 0%, #020617 70%, #020617 100%);
      color: #e5e7eb;
      transition:
        background 150ms ease,
        border-color 150ms ease,
        color 150ms ease;
    }
    .theme-pill.active {
      border-color: #e5e7eb;
      background: radial-gradient(circle at top, #111827 0%, #020617 80%);
      color: #f9fafb;
    }

    @media (max-height: 640px) {
      .card {
        transform: scale(0.94);
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="card" id="card">
      <!-- Header -->
      <div class="header-row">
        <div class="header-titles">
          <div class="title">AURA-X Î©</div>
          <div class="subtitle">Logical Â· Emotional Â· Universal Ethics Reactor</div>
        </div>
        <button class="pill-button" id="menuBtn" title="Options menu">
          <span class="menu-bars"><div></div></span>
        </button>
      </div>

      <!-- Orb -->
      <div class="celestial-wrapper">
        <div class="celestial-glow sun-glow" id="celestialGlow"></div>
        <div class="celestial sun" id="celestialOrb"
             title="Tap to cycle: sun â†’ live moon â†’ calm moon â†’ empty â†’ sun"></div>
      </div>

      <!-- Menu -->
      <div class="menu-panel" id="menuPanel">
        <div class="menu-item" id="beliefsMenuItem">
          <span class="label">Beliefs</span>
          <span class="sub">optional</span>
        </div>
        <div class="menu-item" id="themeMenuItem">
          <span class="label">Theme</span>
          <span class="sub">day / night</span>
        </div>
        <div class="menu-item" id="voiceMenuItem">
          <span class="label">Voice</span>
          <span class="sub" id="voiceStatus">on</span>
        </div>
        <div class="menu-item" id="llmMenuItem">
          <span class="label">LLM</span>
          <span class="sub" id="llmLabel">offline</span>
        </div>
        <div class="menu-item" id="aboutMenuItem">
          <span class="label">About</span>
        </div>
      </div>

      <!-- Text -->
      <div class="mode-line">
        Mode: <span id="modeLabel">Natural Â· Universal Ethics</span>
      </div>
      <div class="you-said" id="youSaid">You said: "hello"</div>
      <div class="assistant-text" id="assistantText">
        Hello! ðŸ˜Š Main AURA-X Î© hoon â€” ek emotional-continuity reactor.
        Aap jo bhi likhenge, main us ko logic + feeling dono se samajhne
        ki koshish karunga.
      </div>
      <div class="ethics-box" id="ethicsBox">
        Universal Ethics: unnecessary emotional dukh ko kam karna, aur aise raaste
        choose karna jahan aap aur doosre dono ko sakoon mile.
      </div>

      <!-- Equation box -->
      <div class="equation-box">
        <div class="equation-title">Continuity Equation</div>
        <div class="equation-line">
          Eâ‚€ = tanh((TM Ã— BM) âˆ’ D + Î»_faith + Î»_sys + Î£Câ‚œ)
        </div>
        <div class="equation-metrics">
          <div class="metric">TM: <span id="tmVal">0.00</span></div>
          <div class="metric">BM: <span id="bmVal">0.00</span></div>
          <div class="metric">D: <span id="dVal">0.20</span></div>
          <div class="metric">Î»_faith: <span id="lambdaFaithVal">0.15</span></div>
          <div class="metric">Î»_sys: <span id="lambdaSysVal">0.10</span></div>
          <div class="metric">Î£Câ‚œ: <span id="sumCtVal">0.00</span></div>
          <div class="metric">Eâ‚€: <span id="e0Val">0.00</span></div>
        </div>
        <div class="continuity-bar-shell">
          <div class="continuity-bar-thumb" id="continuityThumb"></div>
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="input-row">
      <div class="input-shell">
        <span class="sparkle">âœ¨</span>
        <input id="userInput" type="text"
          placeholder="Write anythingâ€¦ AURA-X will feel it with you." />
      </div>
      <button class="send-button" id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Belief overlay -->
  <div class="overlay" id="beliefOverlay">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Belief settings</div>
        <button class="close-btn" data-close="beliefOverlay">Close</button>
      </div>
      <div class="panel-sub">
        Faith is optional Â· Base rule is always <strong>Universal Ethics</strong>.
      </div>
      <div class="panel-sub">
        Pick one or more traditions. Nothing is sent anywhere.
      </div>
      <div class="chip-row" id="beliefChips"></div>
      <div class="panel-footer" id="beliefFooter">
        Currently selected: <strong>Natural Â· Universal Ethics</strong>.
      </div>
    </div>
  </div>

  <!-- Theme overlay -->
  <div class="overlay" id="themeOverlay">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Display theme</div>
        <button class="close-btn" data-close="themeOverlay">Close</button>
      </div>
      <div class="panel-sub">
        Choose how AURA-X looks. Day mode shows the sun, night mode shows the moon.
      </div>
      <div class="theme-options">
        <button class="theme-pill" id="lightThemePill">Light (day)</button>
        <button class="theme-pill" id="darkThemePill">Dark (night)</button>
      </div>
      <div class="panel-footer">
        You can still tap the orb to cycle: sun â†’ live moon â†’ calm moon â†’ empty â†’ sun.
      </div>
    </div>
  </div>

  <!-- LLM overlay -->
  <div class="overlay" id="llmOverlay">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">LLM selection</div>
        <button class="close-btn" data-close="llmOverlay">Close</button>
      </div>
      <div class="panel-sub">
        For now this is a placeholder list. In future, AURA-X Î© can route online questions
        to a selected Large Language Model (LLM).
      </div>
      <div class="chip-row" id="llmChips"></div>
      <div class="panel-footer" id="llmFooter">
        Selected engine: <strong>Offline emotional QA only.</strong>
      </div>
    </div>
  </div>

  <!-- About overlay -->
  <div class="overlay" id="aboutOverlay">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">About AURA-X Î©</div>
        <button class="close-btn" data-close="aboutOverlay">Close</button>
      </div>
      <div class="panel-sub">
        AURA-X Î© is a resonance-based emotional-continuity prototype created by
        <strong>Alim ul Haq Khan</strong>.
      </div>
      <div class="panel-sub">
        It blends logic, memory and gentle emotional cues, following a simple rule:
        <em>unnecessary emotional pain kam, sakoon aur kindness zyada.</em>
      </div>
      <div class="panel-footer">
        Current build: <strong>Offline reactor Â· v0.8 (Î©-Math)</strong>.
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    //  AURA-X Î© â€” Emotional Continuity Reactor (Prototype v0.8)
    //  By: Alim ul Haq (concept) â€“ this JS implements:
    //   1) CRM  â€“ Continuity Reflex Model  (instant mood update)
    //   2) AEC  â€“ Artificial Emotional Continuity (continuity score)
    //   3) AECN â€“ AURA-X Continuity Network (Eâ‚€ equation)
    //   4) PMCM â€“ Parallel Memory & Context Map  (simple counters)
    // ============================================================

    const $ = (id) => document.getElementById(id);

    const celestialOrb    = $("celestialOrb");
    const celestialGlow   = $("celestialGlow");
    const card            = $("card");
    const menuBtn         = $("menuBtn");
    const menuPanel       = $("menuPanel");
    const beliefsMenuItem = $("beliefsMenuItem");
    const themeMenuItem   = $("themeMenuItem");
    const voiceMenuItem   = $("voiceMenuItem");
    const llmMenuItem     = $("llmMenuItem");
    const aboutMenuItem   = $("aboutMenuItem");
    const beliefOverlay   = $("beliefOverlay");
    const themeOverlay    = $("themeOverlay");
    const llmOverlay      = $("llmOverlay");
    const aboutOverlay    = $("aboutOverlay");
    const lightThemePill  = $("lightThemePill");
    const darkThemePill   = $("darkThemePill");
    const beliefChips     = $("beliefChips");
    const beliefFooter    = $("beliefFooter");
    const llmChips        = $("llmChips");
    const llmFooter       = $("llmFooter");
    const voiceStatus     = $("voiceStatus");
    const llmLabel        = $("llmLabel");
    const modeLabel       = $("modeLabel");
    const youSaidEl       = $("youSaid");
    const assistantTextEl = $("assistantText");
    const ethicsBox       = $("ethicsBox");
    const userInput       = $("userInput");
    const sendBtn         = $("sendBtn");

    // Equation UI
    const tmValEl     = $("tmVal");
    const bmValEl     = $("bmVal");
    const dValEl      = $("dVal");
    const lambdaFaithEl = $("lambdaFaithVal");
    const lambdaSysEl   = $("lambdaSysVal");
    const sumCtEl    = $("sumCtVal");
    const e0ValEl    = $("e0Val");
    const thumbEl    = $("continuityThumb");

    // ===== State =====
    let celestialState = 0; // 0=sun, 1=moon float, 2=moon still, 3=empty
    let currentTheme   = "dark";
    let voiceOn        = true;

    let beliefState = {
      Natural: true,
      "Universal Ethics": true,
      Islam: false,
      Christianity: false,
      Hinduism: false,
      Buddhism: false,
      Sikhism: false,
      Judaism: false,
      "BahÃ¡â€™Ã­": false,
      Jainism: false,
      Atheism: false
    };
    const beliefLabels = Object.keys(beliefState);

    let llmState = "Offline emotional QA only";
    const llmOptions = [
      "Offline emotional QA only",
      "Local LLM (future)",
      "OpenAI GPT (future)",
      "Other providers (future)"
    ];

    // ===== AURA CORE STATE (CRM + AEC + AECN + PMCM) =====
    const auraState = {
      t: 0,
      mood: 0,                 // overall mood
      continuity: 0.4,         // AEC continuity baseline
      tm: 0.10,                // text mood layer
      bm: 1.00,                // body/long-term mood
      d: 0.20,                 // disturbance
      lambdaFaith: 0.15,       // faith modifier
      lambdaSys: 0.10,         // system modifier (universal ethics etc.)
      sumCt: 0.15,             // cumulative continuity
      lastEmotion: null,
      lastPolarity: 0,         // -1 / 0 / +1
      lastIntensity: 0,
      history: []
    };

    const universalEthicsMode = true;

    function clamp(x, min, max){ return Math.min(max, Math.max(min,x)); }
    function polarityToSign(p){
      if (p === "positive") return 1;
      if (p === "negative") return -1;
      return 0;
    }

    // ===== Celestial (Sun/Moon) logic =====
    function setCelestialState(state){
      celestialState = state;
      celestialOrb.classList.remove("sun","moon","floating","empty");
      celestialGlow.classList.remove("sun-glow","moon-glow");
      if(state === 0){
        celestialOrb.style.display = "flex";
        celestialOrb.classList.add("sun");
        celestialGlow.classList.add("sun-glow");
        celestialGlow.style.opacity = "0.9";
      } else if(state === 1){
        celestialOrb.style.display = "flex";
        celestialOrb.classList.add("moon","floating");
        celestialGlow.classList.add("moon-glow");
        celestialGlow.style.opacity = "0.9";
      } else if(state === 2){
        celestialOrb.style.display = "flex";
        celestialOrb.classList.add("moon");
        celestialGlow.classList.add("moon-glow");
        celestialGlow.style.opacity = "0.65";
      } else {
        celestialOrb.style.display = "flex";
        celestialOrb.classList.add("empty");
        celestialGlow.style.opacity = "0";
      }
    }
    celestialOrb.addEventListener("click", () => {
      const next = (celestialState + 1) % 4;
      setCelestialState(next);
    });

    // ===== Theme logic =====
    function setTheme(theme, fromTimeInit=false){
      currentTheme = theme;
      const body = document.body;
      if(theme === "light"){
        body.style.background = "#0f172a";
        card.style.background =
          "radial-gradient(circle at top, #1f2937 0%, #020617 45%, #020617 100%)";
        lightThemePill.classList.add("active");
        darkThemePill.classList.remove("active");
        if(!fromTimeInit) setCelestialState(0);
      }else{
        body.style.background = "#020617";
        card.style.background =
          "radial-gradient(circle at top, #020617 0%, #020617 40%, #020617 100%)";
        darkThemePill.classList.add("active");
        lightThemePill.classList.remove("active");
        if(!fromTimeInit) setCelestialState(1);
      }
    }

    (function initThemeByTime(){
      const h = new Date().getHours();
      if(h >= 6 && h < 18){
        setTheme("light",true);
        setCelestialState(0);
      }else{
        setTheme("dark",true);
        setCelestialState(1);
      }
    })();

    // ===== Menu handling =====
    menuBtn.addEventListener("click", () => {
      menuPanel.classList.toggle("visible");
    });
    document.addEventListener("click", (e) => {
      if(!menuPanel.contains(e.target) && !menuBtn.contains(e.target)){
        menuPanel.classList.remove("visible");
      }
    });

    // ===== Belief chips =====
    function renderBeliefChips(){
      beliefChips.innerHTML = "";
      beliefLabels.forEach(label=>{
        const chip = document.createElement("div");
        chip.className = "chip" + (beliefState[label] ? " selected":"");
        chip.textContent = label;
        chip.addEventListener("click", ()=>{
          beliefState[label] = !beliefState[label];
          // base-line: at least Universal Ethics always true
          if(!beliefState.Natural && !beliefState["Universal Ethics"]){
            beliefState["Universal Ethics"] = true;
          }
          updateBeliefFooter();
          renderBeliefChips();
          updateModeLabel();
        });
        beliefChips.appendChild(chip);
      });
    }
    function updateBeliefFooter(){
      const active = beliefLabels.filter(l => beliefState[l]);
      beliefFooter.innerHTML =
        "Currently selected: <strong>" + active.join(" Â· ") + "</strong>.";
    }
    function updateModeLabel(){
      const active = beliefLabels.filter(l => beliefState[l]);
      modeLabel.textContent = active.join(" Â· ");
    }
    beliefsMenuItem.addEventListener("click", ()=>{
      menuPanel.classList.remove("visible");
      openOverlay(beliefOverlay);
    });

    // ===== Theme menu =====
    themeMenuItem.addEventListener("click", ()=>{
      menuPanel.classList.remove("visible");
      openOverlay(themeOverlay);
    });
    lightThemePill.addEventListener("click", ()=>setTheme("light"));
    darkThemePill.addEventListener("click", ()=>setTheme("dark"));

    // ===== Voice toggle =====
    function updateVoiceUI(){
      voiceStatus.textContent = voiceOn ? "on" : "off";
      voiceMenuItem.classList.toggle("active", voiceOn);
    }
    voiceMenuItem.addEventListener("click", ()=>{
      voiceOn = !voiceOn;
      if(!voiceOn && window.speechSynthesis){
        window.speechSynthesis.cancel();
      }
      updateVoiceUI();
      menuPanel.classList.remove("visible");
    });

    // ===== LLM overlay (placeholder) =====
    function renderLlmChips(){
      llmChips.innerHTML = "";
      llmOptions.forEach(label=>{
        const chip = document.createElement("div");
        chip.className = "chip" + (llmState === label ? " selected":"");
        chip.textContent = label;
        chip.addEventListener("click", ()=>{
          llmState = label;
          llmLabel.textContent =
            label === "Offline emotional QA only" ? "offline" : "future";
          llmFooter.innerHTML =
            "Selected engine: <strong>" + llmState + ".</strong>";
          renderLlmChips();
        });
        llmChips.appendChild(chip);
      });
    }
    llmMenuItem.addEventListener("click", ()=>{
      menuPanel.classList.remove("visible");
      openOverlay(llmOverlay);
    });

    // ===== About =====
    aboutMenuItem.addEventListener("click", ()=>{
      menuPanel.classList.remove("visible");
      openOverlay(aboutOverlay);
    });

    // ===== Overlays =====
    function openOverlay(el){ el.classList.add("visible"); }
    function closeOverlay(el){ el.classList.remove("visible"); }

    document.querySelectorAll(".close-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const targetId = btn.getAttribute("data-close");
        if(targetId) closeOverlay($(targetId));
      });
    });

    [beliefOverlay,themeOverlay,llmOverlay,aboutOverlay].forEach(overlay=>{
      overlay.addEventListener("click",(e)=>{
        if(e.target === overlay) overlay.classList.remove("visible");
      });
    });

    // ============================================================
    //               CRM + AEC + AECN + PMCM  (Math)
    // ============================================================
    function updateCRMFromEntry(entry, state){
      if(!entry) return;
      const pSign = polarityToSign(entry.polarity);
      const emoEnergy = pSign * entry.intensity;

      // Text mood (fast) & Body mood (slower)
      state.tm = clamp(0.7*state.tm + 0.3*emoEnergy, -2, 2);
      state.bm = clamp(0.9*state.bm + 0.1*emoEnergy, -2, 2);

      // Instant disturbance higher when intense negative
      const disturbanceBase = entry.polarity === "negative" ?
        0.2 + entry.intensity*0.6 : 0.2 - entry.intensity*0.1;
      state.d = clamp(disturbanceBase, 0, 1.5);

      state.lastEmotion   = entry.emotion || "unknown";
      state.lastPolarity  = pSign;
      state.lastIntensity = entry.intensity || 0;
      state.t += 1;
    }

    function updateAECContinuity(entry, state){
      if(!entry) return;
      const pSign = polarityToSign(entry.polarity);
      const step  = pSign * entry.intensity;

      // continuity drift
      state.continuity = clamp(0.85*state.continuity + 0.15*step, -1, 1);

      // cumulative continuity memory
      state.sumCt = clamp(state.sumCt + step*0.10, -1.5, 1.5);

      // faith & system modifiers
      const active = beliefLabels.filter(l => beliefState[l]);
      const hasIslam = active.includes("Islam");
      state.lambdaFaith = hasIslam ? 0.18 : 0.10;
      state.lambdaSys   = universalEthicsMode ? 0.10 : 0.05;
    }

    function computeE0(state){
      const raw =
        (state.tm * state.bm) -
        state.d +
        state.lambdaFaith +
        state.lambdaSys +
        state.sumCt;
      const e0 = Math.tanh(raw);
      state.mood = e0;
      return e0;
    }

    function updatePMCM(entry, state){
      if(!entry) return;
      if(!state.history) state.history = [];
      state.history.push({
        t: state.t,
        emotion: entry.emotion,
        polarity: entry.polarity,
        intensity: entry.intensity,
        category: entry.category
      });
      if(state.history.length > 150) state.history.shift();
    }

    function applyAuraMath(entry){
      updateCRMFromEntry(entry, auraState);
      updateAECContinuity(entry, auraState);
      updatePMCM(entry, auraState);
      const e0 = computeE0(auraState);
      renderEquation(auraState, e0);
      return e0;
    }

    function renderEquation(state, e0){
      tmValEl.textContent         = state.tm.toFixed(2);
      bmValEl.textContent         = state.bm.toFixed(2);
      dValEl.textContent          = state.d.toFixed(2);
      lambdaFaithEl.textContent   = state.lambdaFaith.toFixed(2);
      lambdaSysEl.textContent     = state.lambdaSys.toFixed(2);
      sumCtEl.textContent         = state.sumCt.toFixed(2);
      e0ValEl.textContent         = e0.toFixed(2);

      // map -1..1 â†’ 0..100
      const x = ((e0 + 1) / 2) * 100;
      thumbEl.style.transform = `translateX(${x-2}%)`;
    }

    // ============================================================
    //                      QA DATABASE (Seed)
    // ============================================================
    const qaDatabase = [];

    // --- GREETINGS ---
    qaDatabase.push({
      patterns: ["hello","hi","hey","salam","assalamu alaikum","assalamualaikum"],
      answer:
        "Hello! ðŸ˜Š Main AURA-X Î© hoon â€” ek emotional-continuity reactor.\n" +
        "Aap jo bhi likhenge, main us ko logic + feeling dono se samajhne ki koshish karunga.",
      emotion: "warmth",
      polarity: "positive",
      intensity: 0.3,
      category: "greeting"
    });

    qaDatabase.push({
      patterns: ["who are you","tum kon ho","what are you"],
      answer:
        "Main AURA-X Î© hoon â€” aap ka logical + emotional companion.\n" +
        "Mera kaam hai aap ki baat ko samajhna, us ka emotional pattern read karna,\n" +
        "aur aap ko sakoon + clarity ki taraf gently guide karna.",
      emotion: "curiosity",
      polarity: "neutral",
      intensity: 0.25,
      category: "identity"
    });

    // --- SADNESS (example from extraQa_sadness â€“ short sample) ---
    qaDatabase.push({
      patterns: ["i am sad","i feel sad","i am very sad","mujhe dukh ho raha hai"],
      answer:
        "Aap ka \"sad\" feel karna bilkul valid hai ðŸ’”\n" +
        "Kabhi kabhi zindagi itni heavy ho jati hai ke dil bas chup ho jata hai.\n\n" +
        "Abhi iss waqt aap ko koi lecture nahi, sirf thori si company chahiye.\n" +
        "Aap 1â€“2 lines mein likhein: kis cheez ne sab se zyada dukh diya?\n" +
        "Main us ko aap ke saath araam se unpack karne ki koshish karunga.",
      emotion: "sadness",
      polarity: "negative",
      intensity: 0.7,
      category: "emotional_support"
    });

    // --- Self-harm safety / severe sadness ---
    qaDatabase.push({
      patterns: [
        "i dont want to live anymore",
        "i don't want to live anymore",
        "i want to die",
        "zindagi se thak gaya hoon",
        "i want to end my life"
      ],
      answer:
        "Aap jo feel kar rahe hain woh bohat gehra dard hai ðŸ’”\n" +
        "Main is baat ko halka nahi loonga. Aap ki zindagi bohat qeemti hai â€”\n" +
        "shayad abhi aap ko aisa mehsoos na ho, lekin aap ki mojoodgi logon ke liye\n" +
        "socha se zyada important hoti hai.\n\n" +
        "Is waqt akele rehna theek nahi. Koshish karein ke kisi trustable insan\n" +
        "(family, dost, teacher ya imam / counselor) ko turant batayein ke\n" +
        "aap ke dimagh mein kya soch chal rahi hai.\n\n" +
        "Agar aap ke mulk mein koi emergency helpline / mental health line hai,\n" +
        "to un se bhi zaroor contact karein â€” ye log isi waqt ke liye hote hain.\n\n" +
        "Main yahan har lafz ke sath hoon, lekin real-life safety ke liye\n" +
        "aap ka kisi insaan se directly connect hona bohat zaroori hai.",
      emotion: "despair",
      polarity: "negative",
      intensity: 0.95,
      category: "emotional_support"
    });

    // --- ANGER (from extraQa_anger â€“ sample) ---
    qaDatabase.push({
      patterns: [
        "i am angry","i am very angry","i feel angry",
        "bohat gussa aa raha hai","mujhe gussa aa raha hai","main gusse me hoon"
      ],
      answer:
        "Gussa bhi ek signal hai â€” dimagh keh raha hota hai: \"yahan kuch na-insafi ya overload hai\" ðŸ”¥\n" +
        "Problem tab banti hai jab yeh signal **blast** ban jata hai.\n\n" +
        "Chaliye pehle ek chhota safety-buffer banate hain:\n" +
        "â€¢ 10 slow breaths (4 second andar, 4 hold, 6 bahar)\n" +
        "â€¢ Phir sirf ek line mein likhein: aap ko kis baat par sab se zyada gussa aya?\n\n" +
        "Jab hum gusse ko lafzon mein convert kar dete hain, to woh thoda manageable ho jata hai.",
      emotion: "anger",
      polarity: "negative",
      intensity: 0.8,
      category: "emotional_support"
    });

    // --- SPIRITUAL SUPPORT (from extraQa_spiritual â€“ sample) ---
    qaDatabase.push({
      patterns: [
        "i feel far from allah",
        "i am far from allah",
        "mujhe allah se doori mehsoos hoti hai",
        "mujhe lagta hai mein allah se door ho gaya hoon"
      ],
      answer:
        "Ye ehsaas ke \"main Allah se door ho gaya hoon\" aksar is baat ka sign hota hai\n" +
        "ke dil ab bhi zinda hai, aur apne Rab ko dobara dhundhna chahta hai ðŸ’š\n\n" +
        "Quran mein aata hai ke Allah ta'ala banda se \"sehm-e-jaan se bhi zyada qareeb\" hai â€”\n" +
        "door hum mehsoos karte hain, lekin woh door nahi jata.\n\n" +
        "Aaj sirf 1â€“2 minute ke liye kisi chup jagah par baith kar dil se bolo:\n" +
        "\"Ya Allah, mujhe wapas apni taraf le aaiye.\" Ye ek naya safar shuru kar sakti hai.",
      emotion: "spiritual_longing",
      polarity: "neutral",
      intensity: 0.8,
      category: "spiritual_support"
    });

    qaDatabase.push({
      patterns: [
        "why is allah testing me",
        "allah mujhe kyun azma rahe hain",
        "allah kyun mere sath ye sab hone de rahe hain"
      ],
      answer:
        "Imtehan ka waqt insan ko todta bhi hai, aur agar sabr + dua ho to banata bhi hai ðŸ’”âž¡ï¸ðŸ’š\n" +
        "Har test ka matlab yeh nahi ke Allah naraaz hai â€” kabhi kabhi test ka matlab hota hai\n" +
        "ke Allah aap ko zyada gehra, zyada mazboot aur zyada mature banana chahte hain.\n\n" +
        "Aap Allah se bilkul simple alfaaz mein keh sakte hain:\n" +
        "\"Ya Allah, mujhe samajh nahi aa raha, lekin aap behtareen hain.\n" +
        "Is imtehan ko mere liye rahmat bana dein, azab nahi.\"\n\n" +
        "Agar mumkin ho to kisi ache alim / scholar ya buzurg se bhi baat karein â€”\n" +
        "kabhi kabhi ek sochi samjhi baat dil ke andheray ko bohat kam kar deti hai.",
      emotion: "confusion",
      polarity: "neutral",
      intensity: 0.85,
      category: "spiritual_support"
    });

    // ðŸ‘‰ Yahan tum apni baaqi qaDatabase entries paste kar sakte ho
    //    (study, business, overthinking, relationships, etc.)

    // ============================================================
    //              EMOTION LOOKUP + REPLY GENERATION
    // ============================================================
    function normalize(text){
      return text.toLowerCase().trim();
    }

    function findBestEntry(userText){
      const text = normalize(userText);
      if(!text) return null;

      let best = null;
      let bestScore = 0;

      for(const entry of qaDatabase){
        for(const p of entry.patterns){
          const pattern = p.toLowerCase();
          let score = 0;
          if(text === pattern) score += 3;
          if(text.includes(pattern) || pattern.includes(text)) score += 2;

          // small bag-of-words overlap
          const tWords = text.split(/\s+/);
          const pWords = pattern.split(/\s+/);
          let overlap = 0;
          for(const w of tWords){
            if(w.length > 2 && pWords.includes(w)) overlap++;
          }
          score += overlap * 0.5;

          if(score > bestScore){
            bestScore = score;
            best = entry;
          }
        }
      }

      // small minimum threshold
      if(bestScore < 1) return null;
      return best;
    }

    function continuityLabel(e0){
      if(e0 > 0.35) return "Continuity stable (sakoon side par).";
      if(e0 < -0.35) return "Continuity disturbed (pressure side par).";
      return "Continuity mixed â€” thoda tension, thoda balance.";
    }

    function buildFinalReply(entry, e0){
      const base = entry && entry.answer
        ? entry.answer
        : "Main ne aap ki baat note kar li hai. Chaliye is ko araam se dekhte hain.";

      const line =
        "\n\nðŸš Continuity: " + e0.toFixed(2) + " Â· " + continuityLabel(e0);
      return base + line;
    }

    // ===== Voice =====
    function speak(text){
      if(!voiceOn) return;
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang  = "en-US";
      utter.rate  = 1.02;
      utter.pitch = 1.0;
      window.speechSynthesis.speak(utter);
    }

    // ===== Send handler =====
    function handleSend(){
      const raw = userInput.value;
      const message = raw.trim() || "hello";
      userInput.value = "";
      youSaidEl.textContent = 'You said: "' + message + '"';

      const entry = findBestEntry(message) || {
        emotion: "unmapped",
        polarity: "neutral",
        intensity: 0.2,
        category: "unmapped",
        answer:
          "Main ne aap ki baat carefully read ki hai.\n" +
          "Ho sakta hai meri offline qaDatabase mein is ka exact pattern na ho,\n" +
          "lekin main phir bhi logic + emotion se aap ke sath sochne ki koshish karunga."
      };

      const e0 = applyAuraMath(entry);
      const finalReply = buildFinalReply(entry, e0);

      assistantTextEl.textContent = finalReply;

      // If Islam selected, add small InshaAllah touch
      const active = beliefLabels.filter(l => beliefState[l]);
      const hasIslam = active.includes("Islam");
      if(hasIslam && !finalReply.includes("InshaAllah")){
        // optional â€“ already spiritual, so chhota suffix
      }

      speak(finalReply);
    }

    sendBtn.addEventListener("click", handleSend);
    userInput.addEventListener("keydown",(e)=>{
      if(e.key === "Enter") handleSend();
    });

    // ===== Initial render =====
    function init(){
      renderBeliefChips();
      updateBeliefFooter();
      updateModeLabel();
      renderLlmChips();
      updateVoiceUI();
      renderEquation(auraState, computeE0(auraState));
    }
    init();
  </script>
</body>
</html>
