<script>
/* ===== AURA-X Local Q&A (No server needed)  ===========================
   Paste right before </body>. It auto-hooks the "Send" button and shows
   answers inside the chat when LLM is OFF or endpoint is missing.
====================================================================== */

// ---- 1) Config ------------------------------------------------------
const AURA_CFG = {
  useLocalWhenNoEndpoint: true,   // Ø§Ú¯Ø± endpoint Ù†ÛÛŒÚº ÛÛ’ ØªÙˆ Ù„ÙˆÚ©Ù„ Q&A Ø§Ø³ØªØ¹Ù…Ø§Ù„ ÛÙˆ
  llmEnabledSelector: '#toggle-llm, [data-llm-toggle], input[type=checkbox][name*=llm], .llm-toggle',
  endpointSelector: 'input[type=text][placeholder*="YOUR-WORKER"], input[placeholder*="Endpoint"], #api-endpoint',
  sendButtonText: 'send',         // Ø¨Ù¹Ù† Ú©Û’ Ù¹ÛŒÚ©Ø³Ù¹ Ø³Û’ Ø¨Ù¹Ù† ØªÙ„Ø§Ø´ Ú©ÛŒØ§ Ø¬Ø§Ø¦Û’ Ú¯Ø§
};

// ---- 2) Mini Q&A base (Ø¢Ù¾ Ø§Ù¾Ù†Û’ 200+ Ø³ÙˆØ§Ù„Ø§Øª ÛŒÛØ§Úº Ø¨Ú‘Ú¾Ø§ Ø³Ú©ØªÛ’ ÛÛŒÚº) -----
const QA_DATA = [
  { q: "what's your name", a: "Iâ€™m Alimai â€” your AURA-X guide. May I know your name?" },
  { q: "who are you", a: "Iâ€™m Alimai, an emotional-continuity assistant built on AURA-X Î© prototype." },
  { q: "how are you", a: "Iâ€™m resonating well. How are you feeling right now â€” calm, joy, or a bit tense?" },
  { q: "may i help you", a: "Yes, please. Tell me what youâ€™re working on; I can explain features, recall notes, or suggest a calm anchor." },
  { q: "what is aura", a: "AURA-X Î© models emotional continuity (emotion â‰  reaction) with TMÃ—BM resonance and optional faith/ethics filters." },
  { q: "emotion not equal to reaction", a: "Correct. In AURA-X, emotion is a self-sustaining resonance that can persist without a fresh stimulus." },
  { q: "who created you", a: "Alim ul Haq Khan â€” InvestorPoint research cell." },
  { q: "help", a: "Type your question or feeling. Iâ€™ll respond and show a simple anchor: 1 calm breath inâ€¦ out." },
  // Ø¢Ù¾ Ø§Ù¾Ù†Û’ Q/A Ø¬Ùˆ Ù¾ÛÙ„Û’ Ù…ÛŒÚº Ù†Û’ Ø¯ÛŒÛ’ ØªÚ¾Û’ Ø§Ù†ÛÛŒÚº Ø¨Ú¾ÛŒ ÛŒÛØ§Úº Ø´Ø§Ù…Ù„ Ú©Ø± Ø¯ÛŒÚº
];

// ---- 3) Helpers ------------------------------------------------------
function norm(t){ return (t||"").toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ').trim(); }
function scoreMatch(u, q){ // Ú†Ú¾ÙˆÙ¹Ø§ Ø³Ø§ Ù…ÛŒÚ† Ø§Ø³Ú©ÙˆØ±
  u = norm(u); q = norm(q);
  if (!q) return 0;
  if (u === q) return 3;
  if (u.startsWith(q)) return 2;
  if (u.includes(q)) return 1;
  return 0;
}
function findLocalAnswer(user){
  const u = norm(user);
  let best = {a:null, s:0};
  for (const item of QA_DATA){
    const s = scoreMatch(u, item.q);
    if (s > best.s){ best = {a:item.a, s}; if (s===3) break; }
  }
  if (best.a) return best.a;

  // Fallbacks by keyword
  if (/\b(name|who are you)\b/i.test(u)) return "Iâ€™m Alimai â€” your AURA-X guide. May I know your name?";
  if (/\b(how are you|kese ho|kesy ho)\b/i.test(u)) return "Iâ€™m resonating well. How are you feeling now?";
  if (/\bhelp|madad|guide\b/i.test(u)) return "Tell me what you need. I can explain, recall, or suggest a calm anchor.";
  return "Let me reflect on that. Can you rephrase in one short line?";
}

function getLLMState(){
  // Ø¢ÛŒØ§ LLM Ù¹ÙˆÚ¯Ù„ Ø¢Ù† ÛÛ’ Ø§ÙˆØ± endpoint Ø¯ÛŒØ§ ÛÙˆØ§ ÛÛ’ØŸ
  const toggle = document.querySelector(AURA_CFG.llmEnabledSelector);
  const ep = document.querySelector(AURA_CFG.endpointSelector);
  const llmOn = toggle ? !!toggle.checked : false;
  const hasEndpoint = ep ? !!ep.value.trim() : false;
  return { llmOn, hasEndpoint };
}

// ---- 4) Render bubble (AURA-X style, minimally themed) --------------
function renderLocalBubble(text){
  // Ú†ÛŒÙ¹ Ú©Ù†Ù¹ÛŒÙ†Ø± ÚˆÚ¾ÙˆÙ†ÚˆÙ†Û’ Ú©ÛŒ Ú©ÙˆØ´Ø´ØŒ Ù†Û Ù…Ù„Û’ ØªÙˆ Ø§Ù† Ù¾Ù¹ Ú©Û’ Ø§ÙˆÙ¾Ø± Ù„Ú¯Ø§ Ø¯ÛŒÚº
  const possibleContainers = [
    document.querySelector('.messages'),
    document.querySelector('#messages'),
    document.querySelector('[data-chat]'),
    document.querySelector('main')
  ];
  const host = possibleContainers.find(Boolean) || document.body;

  const card = document.createElement('div');
  card.setAttribute('data-local-qa','');
  card.style.background = 'rgba(20,28,34,0.85)';
  card.style.border = '1px solid rgba(255,255,255,0.06)';
  card.style.borderRadius = '14px';
  card.style.padding = '14px 16px';
  card.style.margin = '12px 8px';
  card.style.color = '#e8f0f6';
  card.style.boxShadow = '0 4px 12px rgba(0,0,0,.25)';

  const h = document.createElement('div');
  h.textContent = 'Î© AURA-X (local Q&A)';
  h.style.fontWeight = '700';
  h.style.marginBottom = '6px';
  h.style.opacity = '.9';

  const p = document.createElement('div');
  p.textContent = text;

  const anchor = document.createElement('div');
  anchor.style.marginTop = '8px';
  anchor.style.opacity = '.8';
  anchor.textContent = 'Anchor: one calm breath inâ€¦ out ğŸ«';

  card.appendChild(h);
  card.appendChild(p);
  card.appendChild(anchor);
  host.appendChild(card);
  // ØªÚ¾ÙˆÚ‘Ø§ Ø§Ø³Ú©Ø±ÙˆÙ„ Ù†ÛŒÚ†Û’
  try { card.scrollIntoView({behavior:'smooth', block:'end'}); } catch(e){}
}

// ---- 5) Hook â€œSendâ€ button ------------------------------------------
function findInput(){
  // Ø³Ø¨ Ø³Û’ Ù†ÛŒÚ†Û’ ÙˆØ§Ù„Ø§ textarea/ input
  const tx = [...document.querySelectorAll('textarea,input[type=text]')].pop();
  return tx;
}
function findSendButton(){
  const allBtns = [...document.querySelectorAll('button')];
  const sendBtn = allBtns.find(b => (b.textContent||'').trim().toLowerCase()===AURA_CFG.sendButtonText)
               || allBtns.find(b => b.textContent?.match(/send/i));
  return sendBtn;
}

function attachLocalQA(){
  const btn = findSendButton();
  const input = findInput();
  if(!btn || !input) return; // UI Ø§Ø¨Ú¾ÛŒ Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’

  // Ø¨Ø§Ø± Ø¨Ø§Ø± Ù†Û Ù„Ú¯Û’
  if (btn.dataset.auraLocalHooked) return;
  btn.dataset.auraLocalHooked = '1';

  btn.addEventListener('click', (ev)=>{
    const { llmOn, hasEndpoint } = getLLMState();

    // Ø§Ú¯Ø± LLM Ø¨Ù†Ø¯ ÛÛ’ ÛŒØ§ endpoint Ù†ÛÛŒÚº ÛÛ’ Ø§ÙˆØ± ÛÙ… Ù†Û’ Ù„ÙˆÚ©Ù„ ÙØ¹Ø§Ù„ Ø±Ú©Ú¾Ø§ ÛÛ’ ØªÙˆ Ù„ÙˆÚ©Ù„ Ø¬ÙˆØ§Ø¨ Ø¯Ú©Ú¾Ø§Ø¦ÛŒÚº
    if (AURA_CFG.useLocalWhenNoEndpoint && (!llmOn || !hasEndpoint)){
      // ØªÚ¾ÙˆÚ‘Ø§ Ø³Ø§ ÙˆÙ‚ÙÛ ØªØ§Ú©Û Ø¢Ù¾ Ú©Ø§ Ø§ØµÙ„ UI ÛŒÙˆØ²Ø± Ù…ÛŒØ³Ø¬ Ø±ÛŒÙ†ÚˆØ± Ú©Ø± Ø¯Û’
      setTimeout(()=>{
        const user = input.value || input.dataset.value || '';
        if (user && user.trim()){
          const ans = findLocalAnswer(user);
          renderLocalBubble(ans);
        }
      }, 60);
    }
    // ÙˆØ±Ù†Û Ú©Ú†Ú¾ Ù†Û Ú©Ø±ÛŒÚºØŒ Ø§ØµÙ„ LLM ÙˆØ§Ù„Ø§ ÙÙ„Ùˆ Ú†Ù„Û’ Ú¯Ø§
  });
}

// DOM ØªÛŒØ§Ø± ÛÙˆØªÛ’ ÛÛŒ ÛÙÚ© Ù„Ú¯Ø§ Ø¯ÛŒÚº
document.addEventListener('DOMContentLoaded', ()=>{
  attachLocalQA();
  // Ø§Ú¯Ø± UI Ù„ÛŒÙ¹ Ù„ÙˆÚˆ ÛÙˆ ØªÙˆ Ú©Ú†Ú¾ Ø¨Ø§Ø± Ù¾Ú¾Ø± Ú©ÙˆØ´Ø´
  setTimeout(attachLocalQA, 500);
  setTimeout(attachLocalQA, 1500);
});
</script>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AURA-X â€¢ Omega Prototype</title>
<style>
  :root{
    --bg:#0c111b; --panel:#111a24; --panel-2:#0f1722; --text:#e8eef6; --muted:#a7b3c4;
    --joy:#19c37d; --calm:#3aa0ff; --sad:#6b7a90; --anger:#ff5252; --fear:#b98bff; --anx:#ffd166;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  body{margin:0;display:flex;flex-direction:column}

  /* Animated aura background */
  .aura{
    position:fixed; inset:0;
    background: radial-gradient(1200px 700px at 50% 55%, #0a2b4a88 0%, transparent 60%),
                radial-gradient(700px 500px at 20% 80%, #002b3655 0%, transparent 60%),
                radial-gradient(900px 700px at 80% 20%, #0f1b3550 0%, transparent 60%);
    transition:filter .6s ease, background .6s ease;
    pointer-events:none; z-index:0;
  }
  .glow{position:fixed;inset:0;pointer-events:none;z-index:1;mix-blend-mode:screen;opacity:.4;transition:opacity .6s}
  .glow::before{
    content:""; position:absolute; left:50%; top:50%;
    width:120vmin; height:120vmin; transform:translate(-50%,-50%);
    border-radius:50%;
    filter:blur(80px); opacity:.8;
    background:radial-gradient(circle,#3aa0ff 0%, transparent 60%);
    transition:background .6s ease;
  }

  header{
    position:sticky; top:0; z-index:5;
    background:linear-gradient(#0b141f, #0b141fdd 70%, transparent);
    padding:14px 14px 6px; backdrop-filter:blur(6px);
    display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;
    border-bottom:1px solid #0f2333;
  }
  .badge{
    background:#07121d;border:1px solid #12324a; color:#caf; padding:6px 10px; border-radius:999px;
    font-weight:600; letter-spacing:.2px; display:flex; gap:8px; align-items:center; font-size:14px;
    box-shadow:0 0 0 1px #0b263d inset, 0 8px 30px #0006;
  }
  .badge .dot{width:10px;height:10px;border-radius:50%; box-shadow:0 0 12px currentColor}
  .state{opacity:.9}

  .wrap{flex:1; overflow:auto; padding:16px; z-index:2}
  .chat{max-width:820px; margin:0 auto; display:flex; flex-direction:column; gap:12px}

  .bubble{
    background:linear-gradient(180deg, #0e1722, #0c131c);
    border:1px solid #132435; border-radius:16px; padding:14px 16px; line-height:1.55;
    box-shadow:0 10px 30px #0008, inset 0 1px 0 #213245; font-size:15px;
  }
  .me{background:linear-gradient(180deg,#0f1b2a,#0c1520); border-color:#1c2f45}
  .bot-title{font-weight:700; margin-bottom:6px; color:#cfe6ff}
  .muted{color:var(--muted)}
  .echo{opacity:.9}

  .controls{
    max-width:820px; margin:8px auto 0; display:flex; gap:10px; flex-wrap:wrap; padding:0 16px;
  }
  .seg{
    background:#0d1622; border:1px solid #1b3148; border-radius:12px; padding:10px; display:flex; gap:10px; flex:1;
    min-width:260px; align-items:center; justify-content:space-between;
  }
  .seg label{font-size:13px; color:#bcd}
  .select, .input{
    background:#0a121c; color:#e6f0ff; border:1px solid #1a2f44; border-radius:10px; padding:8px 10px; width:100%;
  }
  .toggle{display:flex; align-items:center; gap:10px}
  .toggle input{width:20px;height:20px}

  form{
    position:sticky; bottom:0; z-index:5;
    background:linear-gradient(180deg, transparent, #0a0f18 40%, #0a0f18);
    padding:12px 16px 14px; border-top:1px solid #0e2437;
  }
  .row{max-width:820px; margin:0 auto; display:flex; gap:10px}
  textarea{
    flex:1; resize:none; min-height:46px; max-height:160px;
    border:1px solid #1a2f44; background:#0a121c; color:#e6f0ff; border-radius:12px;
    padding:12px 14px; line-height:1.5; font-size:15px; outline:none;
  }
  button{
    background:#2d8cff; border:none; color:white; padding:0 18px; border-radius:12px; font-weight:700;
    font-size:16px; min-width:86px;
    box-shadow:0 6px 20px #2d8cff55; height:46px;
  }

  /* emotion-color helpers */
  .joy   { color:var(--joy)}
  .calm  { color:var(--calm)}
  .sad   { color:var(--sad)}
  .anger { color:var(--anger)}
  .fear  { color:var(--fear)}
  .anx   { color:var(--anx)}
</style>
</head>
<body>
<div class="aura" id="aura"></div>
<div class="glow" id="glow"></div>

<header>
  <div class="badge" id="badge">
    <span class="dot" id="dot" style="color:var(--calm)"></span>
    <span>Î© AURA-X</span> â€¢ <span class="state" id="state">calm</span>
  </div>
</header>

<div class="controls">
  <div class="seg" style="flex:1.1">
    <label style="width:120px">Guidance style</label>
    <select id="guideStyle" class="select">
      <option value="neutral">Neutral</option>
      <option value="ethics">Universal Ethics</option>
      <option value="islamic">Islamic</option>
    </select>
  </div>

  <div class="seg" style="flex:1">
    <div class="toggle">
      <input type="checkbox" id="qaOn"/>
      <label for="qaOn">Answer questions (LLM)</label>
    </div>
  </div>
  <div class="seg" style="flex:2">
    <label style="width:120px">API Endpoint</label>
    <input id="qaEndpoint" class="input" placeholder="https://YOUR-WORKER.example.com/api/ask"/>
  </div>
</div>

<div class="wrap">
  <div class="chat" id="chat">
    <div class="bubble">
      ğŸ‘‹ Hello! Iâ€™m AURA-X â€” your emotional resonance prototype. Tell me how you feel today.
    </div>
  </div>
</div>

<form id="form">
  <div class="row">
    <textarea id="inp" placeholder="Type your emotion or paste a long textâ€¦"></textarea>
    <button id="send" type="submit">Send</button>
  </div>
</form>

<script>
/* ---------- Utilities ---------- */
const chat = document.getElementById('chat');
const inp = document.getElementById('inp');
const form = document.getElementById('form');
const aura = document.getElementById('aura');
const glow = document.getElementById('glow');
const badge = document.getElementById('badge');
const stateEl = document.getElementById('state');
const dot = document.getElementById('dot');
const qaOn = document.getElementById('qaOn');
const qaEndpoint = document.getElementById('qaEndpoint');
const guideStyle = document.getElementById('guideStyle');

const EMO = {
  joy:   { color:'var(--joy)',    bg:'#0d2b1f', icon:'ğŸ˜Š' },
  calm:  { color:'var(--calm)',   bg:'#0b2438', icon:'ğŸ«' },
  sadness:{color:'var(--sad)',    bg:'#101823', icon:'ğŸ˜¢'},
  anger: { color:'var(--anger)',  bg:'#2b0e14', icon:'ğŸ˜ ' },
  fear:  { color:'var(--fear)',   bg:'#1f1230', icon:'ğŸ˜Ÿ' },
  anxiety:{color:'var(--anx)',    bg:'#2a2512', icon:'ğŸ˜¥'},
  tired: { color:'#c0cbd8',       bg:'#0f1620', icon:'ğŸ¥±'},
  hope:  { color:'#6fe0b3',       bg:'#11271f', icon:'ğŸŒ±'},
  confused:{color:'#f7b267',      bg:'#2b2212', icon:'ğŸ¤”'},
  neutral:{color:'var(--calm)',   bg:'#0b2438', icon:'ğŸ™‚'}
};

function toEnd(){ chat.lastElementChild?.scrollIntoView({behavior:'smooth', block:'end'}) }
function escapeHTML(s){ return s.replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])) }

function addUser(t){
  const b=document.createElement('div'); b.className='bubble me';
  b.innerHTML=`ğŸ§  <b>You:</b> ${escapeHTML(t)}`;
  chat.appendChild(b); toEnd();
}
function addBot(html){
  const b=document.createElement('div'); b.className='bubble';
  b.innerHTML=html; chat.appendChild(b); toEnd();
}
function typingOn(){
  const b=document.createElement('div'); b.className='bubble'; b.id='typing';
  b.innerHTML=`Î© AURA-X: <span class="muted">typingâ€¦</span>`;
  chat.appendChild(b); toEnd();
}
function typingOff(){ document.getElementById('typing')?.remove(); }

function auraTo(em){
  const meta = EMO[em] || EMO.neutral;
  stateEl.textContent = em;
  dot.style.color = meta.color;
  glow.style.opacity = .55;
  glow.style.setProperty('--c', meta.color);
  glow.style.setProperty('filter', 'saturate(1.3)');
  glow.style.setProperty('mix-blend-mode','screen');
  glow.style.setProperty('transition','opacity .6s, filter .6s');
  glow.style.setProperty('--x','0');

  glow.style.setProperty('--dummy','1'); // kick repaint
  glow.style.setProperty('opacity','.55');
  glow.style.setProperty('transition','opacity .6s');

  glow.querySelector?.(':scope'); // noop for Safari

  glow.style.setProperty('opacity','.55');
  glow.style.setProperty('transition','opacity .6s');

  glow.style.setProperty('--color', meta.color);
  glow.style.setProperty('--bg', meta.bg);

  glow.style.setProperty('--dummy2','1');
  glow.firstElementChild?.remove();
}
glow.innerHTML=''; // ensure pseudo keeps working
glow.insertAdjacentHTML('afterbegin','');

function setBackdrop(em){
  const meta = EMO[em] || EMO.neutral;
  aura.style.background = `
    radial-gradient(1200px 700px at 50% 55%, ${hexA(meta.color,0.45)} 0%, transparent 60%),
    radial-gradient(700px 500px at 20% 80%, ${hexA(meta.color,0.12)} 0%, transparent 60%),
    radial-gradient(900px 700px at 80% 20%, #0d1627aa 0%, transparent 60%)`;
  dot.style.color = meta.color;
}
function hexA(cssVar,alpha){
  // read computed color for var(--xyz)
  const el=document.createElement('div'); el.style.color=`${cssVar}`;
  document.body.appendChild(el);
  const rgb=getComputedStyle(el).color; document.body.removeChild(el);
  const m=rgb.match(/(\d+),\s*(\d+),\s*(\d+)/);
  if(!m) return 'rgba(58,160,255,'+alpha+')';
  return `rgba(${m[1]},${m[2]},${m[3]},${alpha})`;
}

/* ---------- Emotion detection (rule-based) ---------- */
const lex = {
  joy:      /happy|excited|grateful|alhamdulillah|shukr|great|love|wonderful|joy|proud|success/i,
  calm:     /calm|peace|relax|okay|fine|good|satisfied|serene|breath|deep breath/i,
  sadness:  /sad|upset|hurt|depressed|cry|empty|lonely|loss|broken|tears/i,
  anger:    /angry|mad|furious|annoyed|irritated|rage|hate|unfair|injustice/i,
  fear:     /afraid|scared|fear|terror|phobia|dar|khauf|panic/i,
  anxiety:  /anxious|nervous|stress|tension|worry|confused|confusion|parishan|pressure/i,
  tired:    /tired|sleepy|exhaust(ed)?|fatigue|thaka|thak gaya/i,
  hope:     /hope|optimistic|inshaallah|soon|believe|will try|determined/i,
  confused: /confused|unsure|doubt|puzzled|unclear|what to do/i
};

function detect(text){
  const scores = {joy:0, calm:0, sadness:0, anger:0, fear:0, anxiety:0, tired:0, hope:0, confused:0};
  const lower = text.toLowerCase();

  for(const k of Object.keys(lex)){
    scores[k] = (lower.match(lex[k])||[]).length;
  }
  // sentiment tilt
  if(/[!?]$/.test(text)) scores.anger += .2;
  if(/\bnot|never|no\b/i.test(text)) scores.sadness += .2;
  if(/\bthanks|shukr|alhamdulillah\b/i.test(text)) scores.joy += .7;

  let best='calm', max=-1, sum=0;
  for(const [k,v] of Object.entries(scores)){ sum+=v; if(v>max){max=v; best=k}}
  const conf = Math.min(98, Math.round( (max/(sum||1))*100 )) || (best==='calm'?65:55);
  return { primary: best, scores, conf };
}

/* ---------- Summariser (local, non-LLM) ---------- */
function summarise(text){
  const sents = text.replace(/\s+/g,' ').split(/(?<=[.!?ØŸ])\s+/).filter(Boolean).slice(0,3);
  const short = sents.join(' ');
  return short.length? short : (text.length>140? text.slice(0,140)+'â€¦' : text);
}

/* ---------- Guidance generator ---------- */
function guide(em, style){
  const t = {
    neutral:{
      sadness: "Ù…ÛŒÚº Ø¢Ù¾ Ú©ÛŒ Ú©ÛŒÙÛŒØª Ø³Ù† Ø±ÛØ§ ÛÙˆÚºÛ” Ø§ÛŒÚ© Ø¢ÛØ³ØªÛ Ø³Ø§Ù†Ø³ Ø§Ù†Ø¯Ø±â€¦ Ø¨Ø§ÛØ± Ù„ÛŒÚºØŒ Ø§ÙˆØ± Ø®ÙˆØ¯ Ú©Ùˆ Ù†Ø±Ù…ÛŒ Ø¯ÛŒÚºÛ” Ø§Ú¯Ø± Ù…Ù†Ø§Ø³Ø¨ Ù„Ú¯Û’ ØªÙˆ Ø§Ù¾Ù†Û’ Ù†Ø²Ø¯ÛŒÚ© ØªØ±ÛŒÙ† Ø´Ø®Øµ Ø³Û’ Ø¨Ø§Øª Ú©Ø±ÛŒÚºÛ”",
      anxiety: "ÙÚ©Ø± Ú©ÛŒ Ø´Ø¯Øª Ú©Ù… Ú©Ø±Ù†Û’ Ú©Û’ Ù„Ø¦Û’ 4-4-4 Ø³Ø§Ù†Ø³ Ø¢Ø²Ù…Ø§Ø¦ÛŒÚº: 4 Ø³ÛŒÚ©Ù†Úˆ Ø§Ù†Ø¯Ø±ØŒ 4 Ø±ÙˆÚ©ÛŒÚºØŒ 4 Ø¨Ø§ÛØ±Û” Ú©Ø§Ù…ÙˆÚº Ú©Ùˆ Ú†Ú¾ÙˆÙ¹Û’ Ù‚Ø¯Ù…ÙˆÚº Ù…ÛŒÚº ØªÙˆÚ‘ Ø¯ÛŒÚºÛ”",
      anger:   "ØºØµÛ Ø¨ØªØ§ØªØ§ ÛÛ’ Ú©Û Ú©ÙˆØ¦ÛŒ Ù‚Ø¯Ø± Ù…ØªØ§Ø«Ø± ÛÙˆØ¦ÛŒ ÛÛ’Û” Ù…Ø­ÙÙˆØ¸ Ø¬Ú¯Û Ù…ÛŒÚº Ø§Ø³Û’ Ù„ÙØ¸ÙˆÚº Ù…ÛŒÚº Ù„Ø§Ø¦ÛŒÚºØŒ Ù¾Ú¾Ø± Ø¹Ù…Ù„ Ú©Û’ Ù„Ø¦Û’ Ù¾ÙØ±Ø³Ú©ÙˆÙ† Ù‚Ø¯Ù… Ú†Ù†ÛŒÚºÛ”",
      fear:    "Ø®ÙˆÙ Ú©Ùˆ Ù†Ø§Ù… Ø¯ÛŒÚºØŒ Ø¬Ú¯Û Ø¯ÛŒÚºØŒ Ø§ÙˆØ± Ø­Ø§Ø¶Ø± Ø­Ù‚Ø§Ø¦Ù‚ Ù„Ú©Ú¾ÛŒÚºâ€”Ú©ÛŒØ§ Ù…ÛŒØ±Û’ Ù¾Ø§Ø³ ÙÙˆØ±ÛŒ Ø®Ø·Ø±Û ÛÛ’ ÛŒØ§ Ø°ÛÙ† Ø®ÛŒØ§Ù„ Ø¨Ù†Ø§ Ø±ÛØ§ ÛÛ’ØŸ",
      tired:   "Ø¬Ø³Ù… Ø¢Ø±Ø§Ù… Ù…Ø§Ù†Ú¯ Ø±ÛØ§ ÛÛ’Û” Ù¾Ø§Ù†ÛŒØŒ ÛÙ„Ú©ÛŒ Ú†ÛÙ„ Ù‚Ø¯Ù…ÛŒØŒ ÛŒØ§ 20 Ù…Ù†Ù¹ Ú©Ø§ Ø¢Ø±Ø§Ù… Ù…Ø¯Ø¯Ú¯Ø§Ø± ÛÙˆ Ø³Ú©ØªØ§ ÛÛ’Û”",
      joy:     "ÛŒÛ Ø®ÙˆØ´ÛŒ Ù„Ø§Ø¦Ù‚Ù Ø´Ú©Ø± ÛÛ’â€”Ø§Ø³ Ù„Ù…Ø­Û’ Ú©Ùˆ Ø³Ø§Ù†Ø³ Ú©Û’ Ø³Ø§ØªÚ¾ Ø§ÛŒÙ†Ú©Ø± Ú©Ø±ÛŒÚº ØªØ§Ú©Û Ø¯Ù…Ø§Øº Ø§Ø³Û’ ÛŒØ§Ø¯ Ø±Ú©Ú¾Û’Û”",
      hope:    "Ø¢Ù¾ Ú©ÛŒ Ø§Ù…ÛŒØ¯ Ø§ÛŒÚ© Ø³Ù…Øª Ø¯Ú©Ú¾Ø§ Ø±ÛÛŒ ÛÛ’â€”Ø§Ú¯Ù„Ø§ Ú†Ú¾ÙˆÙ¹Ø§ØŒ Ø­Ù‚ÛŒÙ‚ÛŒ Ù‚Ø¯Ù… Ù„Ú©Ú¾ Ù„ÛŒÚºÛ”",
      confused:"Ø§Ú†Ú¾Ø§ Ø³ÙˆØ§Ù„! ÙÛŒØµÙ„Û’ Ú©Û’ Ù„Ø¦Û’ 2 Ø¢Ù¾Ø´Ù† Ù„Ú©Ú¾ÛŒÚºØŒ ÛØ± Ø§ÛŒÚ© Ú©Û’ 1 ÙØ§Ø¦Ø¯Û/1 Ø®Ø·Ø±ÛØŒ Ù¾Ú¾Ø± Ú†Ú¾ÙˆÙ¹Ø§ ØªØ¬Ø±Ø¨Û Ú©Ø±ÛŒÚºÛ”",
      calm:    "Ø¢Ù¾ Ù…Ø±Ú©Ø² Ù…ÛŒÚº ÛÛŒÚºâ€”Ø§Ø³ÛŒ Ø·Ø±Ø­ Ø³Ø§Ù†Ø³ Ú©Û’ Ø³Ø§ØªÚ¾ Ù†Ø±Ù…ÛŒ Ú©Ùˆ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø±Ú©Ú¾ÛŒÚºÛ”"
    },
    ethics:{
      anger: "Ø·Ø§Ù‚Øª Ú©Ùˆ Ø°Ù…Û Ø¯Ø§Ø±ÛŒ Ø³Û’ Ø¨Ø±ØªÛŒÚºâ€”Ú©Ø³ÛŒ Ú©Ùˆ Ù†Ù‚ØµØ§Ù† Ù†ÛÛŒÚºØŒ Ù…Ø³Ø¦Ù„Û’ Ù¾Ø± ØªÙ†Ù‚ÛŒØ¯ØŒ Ø´Ø®Øµ Ù¾Ø± Ù†ÛÛŒÚºÛ”",
      confused: "Ø³Ú†Ø§Ø¦ÛŒØŒ Ø¶Ø±Ø± Ù†Û Ù¾ÛÙ†Ú†Ø§Ù†Ø§ØŒ Ø§ÙˆØ± Ø¹Ø¯Ù„â€”Ø§Ù† ØªÛŒÙ† Ø§ØµÙˆÙ„ÙˆÚº Ú©Û’ Ø³Ø§ØªÚ¾ ÙÛŒØµÙ„Û Ù‚Ø±ÛŒØ¨ Ø¢ØªØ§ ÛÛ’Û”",
      fear: "Ø§Ú¯Ø± Ø¯ÙˆØ³Ø±ÙˆÚº Ù¾Ø± Ø§Ø«Ø± ÛÛ’ ØªÙˆ Ø´ÙØ§ÙÛŒØª Ø§Ø®ØªÛŒØ§Ø± Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ù…Ø¯Ø¯ Ø·Ù„Ø¨ Ú©Ø±ÛŒÚºâ€”ÛŒÛ Ø§Ø®Ù„Ø§Ù‚ÛŒ ÛÙ…Øª ÛÛ’Û”",
      joy: "Ø§Ù¾Ù†ÛŒ Ø®ÙˆØ´ÛŒ Ø¨Ø§Ù†Ù¹Ù†Ø§ Ø¨Ú¾ÛŒ Ø§ÛŒÚ© Ø§Ø®Ù„Ø§Ù‚ÛŒ Ø¹Ù…Ù„ ÛÛ’â€”Ú©Ø³ÛŒ Ú©ÛŒ Ø®Ø¨Ø±Ú¯ÛŒØ±ÛŒ Ú©Ø±ÛŒÚºÛ”"
    },
    islamic:{
      sadness: "Ø§ÙÙ†ÙÙ‘ Ù…ÙØ¹Ù Ø§Ù„Ù’Ø¹ÙØ³Ù’Ø±Ù ÙŠÙØ³Ù’Ø±Ù‹Ø§ â€” Ù…Ø´Ú©Ù„ Ú©Û’ Ø³Ø§ØªÚ¾ Ø¢Ø³Ø§Ù†ÛŒ ÛÛ’Û” Ø§ÛŒÚ© Ø¢ÛŒØª/Ø¯Ø¹Ø§ Ù¾Ú‘Ú¾ Ú©Ø± Ø³Ø§Ù†Ø³ Ú©ÛŒ ØªØ§Ù„ Ù…ÛŒÚº Ø¯ÛØ±Ø§Ø¦ÛŒÚºÛ”",
      anxiety: "ØªÙÙˆÙÙƒÙÙ‘Ù„ Ú©Û’ Ø³Ø§ØªÚ¾ ØªØ¯Ø¨ÛŒØ±: Ú†Ú¾ÙˆÙ¹Ø§ Ù‚Ø¯Ù… Ù„Ú©Ú¾ÛŒÚº Ø§ÙˆØ± Ø¨Ø³Ù… Ø§Ù„Ù„Û Ú©ÛÛ Ú©Ø± Ø´Ø±ÙˆØ¹ Ú©Ø±ÛŒÚºÛ”",
      joy: "Ø§Ù„Ø­Ù…Ø¯ÙÙ„Ù„Ù‘Ù°Û â€” Ø´Ú©Ø± Ø§Ø¯Ø§ Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ù†ÛŒØª Ú©Ø±ÛŒÚº Ú©Û Ø§Ø³ Ù†Ø¹Ù…Øª Ø³Û’ Ø®ÛŒØ± Ø¨Ø§Ù†Ù¹ÛŒÚºÛ”",
      fear: "Â«Ø­ÙØ³Ù’Ø¨ÙÙŠÙ Ø§Ù„Ù„Ù‘Ù°Ù‡Ù ÙˆÙÙ†ÙØ¹Ù’Ù…Ù Ø§Ù„Ù’ÙˆÙÙƒÙÙŠÙ„ÙÂ» â€” ÛŒÛ Ø°Ú©Ø± Ø¯Ù„ Ú©Ùˆ Ù…Ø¶Ø¨ÙˆØ· Ú©Ø±ØªØ§ ÛÛ’Û”",
      anger:"Ù†Ø¨ÛŒ ï·º Ù†Û’ ÙØ±Ù…Ø§ÛŒØ§: ØºØµÛ Ø¢Ø¦Û’ ØªÙˆ Ø®Ø§Ù…ÙˆØ´ÛŒ Ø§ÙˆØ± ÙˆØ¶Ùˆâ€”Ù¾ÛÙ„Û’ Ù†ÙØ³ Ú©Ùˆ Ù¹Ú¾Ù†ÚˆØ§ØŒ Ù¾Ú¾Ø± Ú¯ÙØªÚ¯ÙˆÛ”"
    }
  };

  const base = t.neutral[em] || t.neutral.calm;
  if(style==='neutral') return base;

  const extra = (t[style] && t[style][em]) ? (" " + t[style][em]) : "";
  return base + extra;
}

/* ---------- Q/A Bridge (optional LLM) ---------- */
function isQuestion(text){
  return /[?ØŸ]$/.test(text.trim()) || /\b(what|why|how|when|where|who|which|can|should|kya|kyun|kab|kais[ae]?|how much|kitna)\b/i.test(text);
}
async function askLLM(prompt){
  const url = (qaEndpoint.value||"").trim();
  if(!url) throw new Error("No endpoint set");
  const res = await fetch(url,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ prompt })
  });
  if(!res.ok) throw new Error("HTTP "+res.status);
  const data = await res.json();
  return (data.answer||data.output||data.text||"").toString();
}

/* ---------- Submit ---------- */
inp.addEventListener('input', e=>{
  inp.style.height='auto'; inp.style.height=Math.min(160, inp.scrollHeight)+'px';
});

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const text = inp.value.trim();
  if(!text) return;
  inp.value=''; inp.style.height='46px';
  addUser(text);

  // 1) Optional: try to answer if a question and switch is ON
  let answeredText = null;
  if(qaOn.checked && isQuestion(text)){
    try{
      typingOn();
      const ans = await askLLM(text);
      typingOff();
      if(ans){
        const dAns = detect(ans);
        auraTo(dAns.primary); setBackdrop(dAns.primary);
        addBot(`<div class="bot-title">Î© AURA-X (answer):</div>${escapeHTML(ans)}`);
      }else{
        addBot(`<div class="bot-title">Î© AURA-X:</div><span class="muted">No answer from endpoint.</span>`);
      }
      answeredText = ans||null;
    }catch(err){
      typingOff();
      addBot(`<div class="bot-title">Î© AURA-X:</div><span class="muted">Answer mode error: ${escapeHTML(String(err.message||err))}</span>`);
    }
  }

  // 2) Local emotion + summary + guidance (always)
  const d = detect(text);
  auraTo(d.primary); setBackdrop(d.primary);

  const summary = summarise(text);
  const conf = Math.max(40, d.conf);
  const emoName = d.primary;
  const icon = (EMO[emoName]?.icon)||'ğŸ«';

  const guidance = guide(emoName, guideStyle.value);

  const block = `
    <div class="bot-title">Î© AURA-X:</div>
    <div>Your tone shows <b class="${emoName}">${emoName}</b> â€” soft resonance ${icon}</div>
    <div class="muted" style="margin:6px 0 2px">Anchor with one calm breath inâ€¦ out ğŸ«</div>
    <div><b>Continuity:</b> staying in <b class="${emoName}">${emoName}</b></div>
    <div class="echo"><b>Echo:</b> â€œ${escapeHTML(summary)}â€</div>
    <div style="margin-top:10px">
      <b>Summary score:</b> <span class="${emoName}">${conf}% ${emoName}</span>
    </div>
    <div style="margin-top:8px"><b>Guidance (${escapeHTML(guideStyle.value)}):</b> ${escapeHTML(guidance)}</div>
  `;
  addBot(block);
});

/* Initial visual */
auraTo('calm'); setBackdrop('calm');
</script>
</body>
</html>

BM_MESSAGES = { L1:[...70 msgs...], L2:[...70 msgs...], â€¦, L7:[...70 msgs...] };


<script>
// ----- Basic local Q&A switch (no server needed) -----
AURA_DATA = window.AURA_DATA || {};
AURA_DATA.llm_enabled = false;        // LLM Ø¨Ù†Ø¯
AURA_DATA.endpoint   = "";            // Ø®Ø§Ù„ÛŒ Ú†Ú¾ÙˆÚ‘ Ø¯ÛŒÚº

// Ø§Ú¯Ø± Ø¢Ù¾ Ù†Û’ qa_basic Ú©Ùˆ Ú©Ø³ÛŒ ÙˆÛŒØ±ÛŒ Ø§ÛŒØ¨Ù„ Ù…ÛŒÚº Ø±Ú©Ú¾Ø§ ÛÛ’:
const QA_DATA = (window.QA_DATA || []);  // [{q:"what's your name", a:"I'm Alimai..."}, ...]

function normalize(t){ return (t||"").toLowerCase().replace(/[^\p{L}\p{N}\s]/gu," ").trim(); }

function localAnswer(user){
  const u = normalize(user);
  // 1) exact / startsWith / includes Ù…ÛŒÚ†
  let best = QA_DATA.find(x => normalize(x.q) === u)
          ||  QA_DATA.find(x => u.startsWith(normalize(x.q)))
          ||  QA_DATA.find(x => u.includes(normalize(x.q)));
  // 2) Ø¨ÛØª Ø¹Ø§Ù… Ø³ÙˆØ§Ù„Ø§Øª Ù†Û Ù…Ù„ÛŒÚº ØªÙˆ soft fallback
  if(!best){
    // Ú†Ù†Ø¯ Ú©ÛŒ ÙˆØ±ÚˆØ² Ú©ÛŒ Ø¨Ù†ÛŒØ§Ø¯ Ù¾Ø± fallback
    if(/\b(name|who are you)\b/i.test(u)) best = {a:"Iâ€™m Alimai â€” your AURA-X guide. May I know your name?"};
    else if(/\b(how are you|kese ho|kesy ho)\b/i.test(u)) best = {a:"Iâ€™m resonating well. How are you feeling right now?"};
    else if(/\bhelp|madad|guide\b/i.test(u)) best = {a:"Tell me what you need. I can explain features, recall notes, or suggest a calm anchor."};
  }
  return best ? best.a : "Let me reflect on that. Can you rephrase in 1 short line?";
}

// UI Ø§Ù†Ø¶Ù…Ø§Ù…: Ø¬Ø¨ â€œLLMâ€ Ø¨Ù†Ø¯ ÛÙˆ ØªÙˆ Ø§Ø³ÛŒ Ø³Û’ Ø¬ÙˆØ§Ø¨ Ø¨Ù†Ø§Ø¦ÛŒÚº
async function getAnswer(userText){
  // Ø§Ú¯Ø± Ú©ÛÛŒÚº Ø§ÙˆØ± ÛŒÛ ÙÙ†Ú©Ø´Ù† Ù…ÙˆØ¬ÙˆØ¯ ÛÛ’ ØªÙˆ Ø§Ø³ Ù…ÛŒÚº ÛŒÛ Ú†ÛŒÚ© Ø±Ú©Ú¾ Ø¯ÛŒÚº
  if (AURA_DATA.llm_enabled && AURA_DATA.endpoint){
    // ...Ø¢Ù¾ Ú©Ø§ Ù…ÙˆØ¬ÙˆØ¯Û fetch LLM Ú©ÙˆÚˆ ÛŒÛØ§Úº Ø±ÛÛ’ Ú¯Ø§...
  } else {
    return localAnswer(userText);
  }
}

// Ù…Ø«Ø§Ù„: send Ø¨Ù¹Ù† ÛÛŒÙ†ÚˆÙ„Ø± Ù…ÛŒÚº
window.handleUserSubmit = async function(userText){
  const reply = await getAnswer(userText);
  renderAnswerBubble(reply); // Ø¢Ù¾ Ú©Û’ UI Ù…ÛŒÚº Ø¬ÙˆØ§Ø¨ Ø¯Ú©Ú¾Ø§Ù†Û’ Ú©Ø§ ÙÙ†Ú©Ø´Ù†
};
</script>

<script>
function initLLMToggle(){
  const hasEndpoint = !!AURA_DATA.endpoint;
  const llmSwitch = document.querySelector('#toggle-llm'); // Ø¢Ù¾ Ú©Û’ HTML Ù…ÛŒÚº Ú†ÛŒÚ© Ø¨Ø§Ú©Ø³ Ú©Ø§ id
  if (llmSwitch){
    llmSwitch.checked = hasEndpoint; // endpoint Ù†Û ÛÙˆ ØªÙˆ Ø¨Ù†Ø¯
  }
  const tip = document.querySelector('#endpoint-tip');
  if (tip) tip.textContent = hasEndpoint ? "" : "No endpoint set â€” using local Q&A.";
}
window.addEventListener('DOMContentLoaded', initLLMToggle);
</script>
