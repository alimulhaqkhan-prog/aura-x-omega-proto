<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Resonance Chat Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #e5f3ff;
      --card: #ffffff;
      --accent: #0f766e;
      --accent-soft: #d0f5f0;
      --accent-strong: #0b4f4a;
      --border-soft: #cbd5e1;
      --text-main: #021824;
      --text-soft: #4b5563;
      --danger: #ef4444;
      --good: #22c55e;
      --warn: #f97316;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      background: radial-gradient(circle at top, #dbeafe 0, #e5f3ff 40%, #eff6ff 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
    }
    .app {
      width: 100%;
      max-width: 520px;
    }
    header {
      text-align: center;
      margin-bottom: 8px;
    }
    .title {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }
    .subtitle {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 2px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(15,118,110,0.1);
      color: var(--accent-strong);
      margin-top: 4px;
    }
    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 10px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.22);
      display: flex;
      flex-direction: column;
      height: min(86vh, 620px);
      position: relative;
      overflow: hidden;
    }
    .intro-line {
      font-size: 0.76rem;
      color: var(--text-soft);
      margin-bottom: 6px;
      text-align: center;
    }

    /* Emotion header */
    .emotion-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, #e0f7ff, #f1f5f9);
      margin-bottom: 6px;
    }
    .heart-wrap {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: radial-gradient(circle, #fecaca, #fb7185);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 18px rgba(248,113,113,0.7);
      animation: pulse 1.8s ease-in-out infinite;
    }
    .heart {
      font-size: 1.3rem;
      filter: drop-shadow(0 0 4px rgba(248,113,113,0.9));
    }
    @keyframes pulse {
      0%   { transform: scale(1);   box-shadow: 0 0 10px rgba(248,113,113,0.5);}
      50%  { transform: scale(1.12);box-shadow: 0 0 24px rgba(248,113,113,0.9);}
      100% { transform: scale(1);   box-shadow: 0 0 10px rgba(248,113,113,0.5);}
    }
    .emotion-meta {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .emotion-label-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-soft);
    }
    .emotion-main-label {
      font-weight: 600;
      color: var(--text-main);
    }
    .emotion-bar {
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      position: relative;
    }
    .emotion-fill {
      height: 100%;
      width: 12%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #0ea5e9);
      transition: width 0.28s ease-out, background 0.28s ease-out;
    }

    /* Top controls */
    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    .chips-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .chip {
      border: none;
      outline: none;
      cursor: pointer;
      font-size: 0.68rem;
      padding: 5px 9px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #111827;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.18s, transform 0.1s, box-shadow 0.18s;
    }
    .chip.primary {
      background: var(--accent);
      color: #ecfeff;
      box-shadow: 0 8px 15px rgba(15,118,110,0.35);
    }
    .chip.active {
      background: var(--accent-strong);
      color: #e0f2fe;
      box-shadow: 0 8px 15px rgba(15,23,42,0.4);
    }
    .chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(15,23,42,0.13);
    }
    .tiny {
      font-size: 0.65rem;
      color: var(--text-soft);
      text-align: right;
      flex-shrink: 0;
    }

    /* Chat area */
    .chat-shell {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-radius: 12px;
      background: #f8fafc;
      border: 1px solid var(--border-soft);
      padding: 6px;
      overflow: hidden;
      margin-bottom: 6px;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }
    .msg-row {
      display: flex;
      margin-bottom: 4px;
    }
    .msg-row.user {
      justify-content: flex-end;
    }
    .msg-bubble {
      max-width: 80%;
      padding: 6px 9px;
      border-radius: 12px;
      font-size: 0.78rem;
      line-height: 1.35;
      box-shadow: 0 4px 10px rgba(15,23,42,0.08);
      word-break: break-word;
      white-space: pre-wrap;
    }
    .msg-row.user .msg-bubble {
      background: #0f766e;
      color: #ecfeff;
      border-bottom-right-radius: 4px;
    }
    .msg-row.bot .msg-bubble {
      background: #ffffff;
      color: #020617;
      border-bottom-left-radius: 4px;
    }

    .reaction-box,
    .faith-box {
      font-size: 0.7rem;
      padding: 5px 8px;
      border-radius: 10px;
      margin-top: 3px;
    }
    .reaction-box {
      background: #fef3c7;
      color: #92400e;
      border: 1px dashed #fbbf24;
    }
    .faith-box {
      background: #eef2ff;
      color: #3730a3;
      border: 1px dashed #a5b4fc;
    }

    /* Composer */
    .composer {
      display: flex;
      align-items: center;
      gap: 6px;
      padding-top: 4px;
      border-top: 1px solid #e2e8f0;
    }
    #userInput {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      padding: 7px 10px;
      font-size: 0.8rem;
      outline: none;
      min-height: 34px;
      max-height: 72px;
      resize: none;
      background: #f9fafb;
    }
    #userInput:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(15,118,110,0.4);
      background: #ffffff;
    }
    #sendBtn {
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 7px 10px;
      font-size: 0.8rem;
      background: var(--accent);
      color: #e0f2f1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      box-shadow: 0 8px 18px rgba(15,118,110,0.45);
      transition: transform 0.08s, box-shadow 0.12s, background 0.12s;
      flex-shrink: 0;
    }
    #sendBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15,118,110,0.55);
      background: #115e59;
    }

    /* Bottom info */
    .bottom-note {
      font-size: 0.63rem;
      color: var(--text-soft);
      margin-top: 2px;
      text-align: center;
    }

    /* Sheet / modal */
    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 20;
    }
    .sheet-backdrop.show {
      display: flex;
    }
    .sheet {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -10px 30px rgba(15,23,42,0.4);
      padding: 10px 12px 14px;
      animation: slideUp 0.2s ease-out;
    }
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }
    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .sheet-header h3 {
      font-size: 0.9rem;
    }
    .sheet-body {
      font-size: 0.75rem;
    }
    .faith-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .faith-pill {
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid #cbd5e1;
      font-size: 0.72rem;
      cursor: pointer;
      background: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .faith-pill.active {
      background: #eef2ff;
      border-color: #6366f1;
      color: #1e293b;
      box-shadow: 0 0 0 1px rgba(99,102,241,0.4);
    }
    .switch-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 4px 0 4px;
    }
    .switch-row input {
      width: 32px;
      height: 16px;
    }

    /* Small screen tweaks */
    @media (max-width: 420px) {
      .card {
        height: min(88vh, 600px);
        padding: 8px;
      }
      .emotion-header {
        gap: 6px;
      }
      .msg-bubble {
        max-width: 88%;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">AURA-X Œ©</div>
    <div class="subtitle">Resonance-based synthetic emotion chat prototype</div>
    <div class="badge">Prototype ‚Ä¢ Emotional Continuity Engine</div>
  </header>

  <div class="card">
    <div class="intro-line">
      Assalamu alaikum. I am an experimental resonance chatbot ‚Äî testing emotional continuity, not just answers.
    </div>

    <!-- Emotion header -->
    <div class="emotion-header">
      <div class="heart-wrap">
        <span class="heart" id="heartIcon">üíï</span>
      </div>
      <div class="emotion-meta">
        <div class="emotion-label-row">
          <span class="emotion-main-label" id="emotionLabel">Calm baseline</span>
          <span id="emotionPercent">12%</span>
        </div>
        <div class="emotion-bar">
          <div class="emotion-fill" id="emotionFill"></div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="top-controls">
      <div class="chips-row">
        <button id="beliefBtn" class="chip">üîò Belief</button>
        <button id="voiceBtn" class="chip">üîä Voice</button>
        <button id="modelsBtn" class="chip">üß† Models</button>
      </div>
      <div class="tiny">
        E‚ÇÄ emotional continuity demo
      </div>
    </div>

    <!-- Chat shell -->
    <div class="chat-shell">
      <div id="chat"></div>
      <div id="reactionBox" class="reaction-box" style="display:none;"></div>
      <div id="faithBox" class="faith-box" style="display:none;"></div>

      <div class="composer">
        <textarea id="userInput" rows="1" placeholder="Type your message‚Ä¶"></textarea>
        <button id="sendBtn">
          <span>Send</span> üöÄ
        </button>
      </div>
    </div>

    <div class="bottom-note">
      Local prototype only ‚Ä¢ No external LLM yet ‚Ä¢ Emotions & suggestions are synthetic.
    </div>
  </div>
</div>

<!-- Belief sheet -->
<div class="sheet-backdrop" id="beliefBackdrop">
  <div class="sheet">
    <div class="sheet-header">
      <h3>Belief & ethics layer</h3>
      <button class="chip" id="closeBelief">Close</button>
    </div>
    <div class="sheet-body">
      <div class="switch-row">
        <input type="checkbox" id="faithOn" />
        <label for="faithOn"><strong>Faith ON</strong> ‚Äî add gentle spiritual suggestions.</label>
      </div>
      <p>Select one or more traditions (optional):</p>
      <div class="faith-grid" id="faithGrid"></div>
      <p style="margin-top:6px;color:#6b7280;">
        When Faith is ON, the system will sometimes add a short, matching suggestion from your selected tradition(s)
        under the main answer ‚Äî especially during stress or sadness.
      </p>
    </div>
  </div>
</div>

<!-- Models / LLM sheet -->
<div class="sheet-backdrop" id="modelsBackdrop">
  <div class="sheet">
    <div class="sheet-header">
      <h3>Models (demo)</h3>
      <button class="chip" id="closeModels">Close</button>
    </div>
    <div class="sheet-body">
      <p>This prototype currently runs on:</p>
      <ul style="margin-left:16px;margin-top:4px;">
        <li><strong>Local Seed Engine</strong> ‚Äì ~basic Q/A patterns inside this page.</li>
      </ul>
      <p style="margin-top:6px;">
        Future: connect to external LLMs (OpenRouter / Cloudflare / etc.) while still passing through the AURA-X Œ©
        emotional continuity layer.
      </p>
    </div>
  </div>
</div>

<script>
/* ===========================================================
   AURA-X Œ© ‚Äî LIGHTWEIGHT EMOTIONAL CONTINUITY ENGINE
   (All local, no external API; feel free to extend.)
   =========================================================== */

/* --- 1) AFFECT LEXICON FOR TM (TEXT ‚Üí RAW EMOTION) --- */
const AFFECT = {
  joy:    [/happy|great|awesome|alhamdulillah|thanks|shukriya|beautiful|amazing|üòÅ|üòä|üòÑ/i,  +0.9],
  calm:   [/ok|fine|theek|neutral|cool|chill|sabar|üôÇ/i,                                         +0.4],
  sad:    [/sad|down|dukhi|lonely|cry|crying|üò≠|üò¢|broken|heartbroken/iu,                       -0.7],
  anger:  [/angry|gussa|hate you|stupid|idiot|üò†|üò°|bakwas|ghussa/iu,                            -0.9],
  fear:   [/fear|dar|scared|anxious|panic|üò®|üò∞/i,                                               -0.6],
  love:   [/love|mohabbat|like you|care you|üíï|‚ù§Ô∏è|pyar/iu,                                      +0.8],
  stress: [/stress|pressure|tension|overload|üò£|üòñ/i,                                            -0.5]
};

const BAD_WORDS = /(shit|bitch|mc|bc|fuck|gaand|harami|lanat|suicide|kill myself)/iu;

/* --- 2) BM: 7 LAYERS IN LOCALSTORAGE (CALENDAR-LIKE) --- */
const BM_MODEL = {
  layers: [
    {name:'L1-Now',        horizonDays: 2,   w: 1.00},
    {name:'L2-Recent',     horizonDays: 7,   w: 0.85},
    {name:'L3-Weekly',     horizonWeeks: 5,  w: 0.70},
    {name:'L4-Monthly',    horizonMonths:12, w: 0.55},
    {name:'L5-Yearly',     horizonYears: 3,  w: 0.40},
    {name:'L6-Archive',    horizonYears:10,  w: 0.30},
    {name:'L7-Deep',       horizonYears:60,  w: 0.20}
  ]
};

function pushBM(intensity){
  const now = Date.now();
  BM_MODEL.layers.forEach((_, i)=>{
    const key = `aura-bm-${i}`;
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    if (arr.length > 60) arr.shift();
    arr.push({t: now, v: intensity});
    localStorage.setItem(key, JSON.stringify(arr));
  });
  localStorage.setItem('aura-last-ts', String(now));
}

function readBM(){
  const now = Date.now();
  let score = 0, wSum = 0;
  BM_MODEL.layers.forEach((L, i)=>{
    let ms =
      L.horizonDays   ? L.horizonDays*864e5 :
      L.horizonWeeks  ? L.horizonWeeks*7*864e5 :
      L.horizonMonths ? L.horizonMonths*30*864e5 :
      L.horizonYears  ? L.horizonYears*365*864e5 : 0;
    if (!ms) return;
    const key = `aura-bm-${i}`;
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    const recent = arr.filter(x => now - x.t <= ms);
    if (recent.length){
      const avg = recent.reduce((a,b)=>a + b.v, 0) / recent.length;
      score += avg * L.w;
      wSum  += L.w;
    }
  });
  return wSum ? score / wSum : 0;
}

/* --- 3) TM FROM CURRENT MESSAGE --- */
function tmFromText(txt){
  let s = 0;
  for (const [_, [re, val]] of Object.entries(AFFECT)){
    if (re.test(txt)) s += val;
  }
  // clamp
  return Math.max(-1, Math.min(1, s));
}

/* --- 4) DECAY D (FORGETTING/HEALING RATE) --- */
function computeD(){
  const last = Number(localStorage.getItem('aura-last-ts') || '0');
  if (!last) return 0.15;
  const hours = (Date.now() - last) / 36e5;
  // more time since last interaction => more decay
  return Math.max(0.05, Math.min(0.6, hours / 36));
}

/* --- 5) LAMBDAS --- */
function lambda_faith(){
  const on = localStorage.getItem('aura-faith-on') === '1';
  return on ? 0.15 : 0.0;
}
function lambda_sys(text){
  const tooCaps = /[A-Z]{7,}/.test(text);
  const superLong = text.length > 600;
  return (tooCaps || superLong) ? -0.08 : 0.06;
}
function lambda_trc(text){
  const hasNum = /\d/.test(text);
  const hasUrl = /https?:\/\/|www\./i.test(text);
  return (hasNum || hasUrl) ? 0.07 : 0.0;
}

/* --- 6) E‚ÇÄ CORE EQUATION --- */
function computeE0(TM, BM, D, lf, ls, lt){
  const z = (TM * BM) - D + lf + ls + lt;
  return Math.tanh(z);  // [-1,1]
}

/* --- 7) UI REFS --- */
const chatEl         = document.getElementById('chat');
const userInput      = document.getElementById('userInput');
const sendBtn        = document.getElementById('sendBtn');
const emotionFill    = document.getElementById('emotionFill');
const emotionLabel   = document.getElementById('emotionLabel');
const emotionPercent = document.getElementById('emotionPercent');
const reactionBox    = document.getElementById('reactionBox');
const faithBox       = document.getElementById('faithBox');
const beliefBtn      = document.getElementById('beliefBtn');
const voiceBtn       = document.getElementById('voiceBtn');
const modelsBtn      = document.getElementById('modelsBtn');
const beliefBackdrop = document.getElementById('beliefBackdrop');
const modelsBackdrop = document.getElementById('modelsBackdrop');
const closeBelief    = document.getElementById('closeBelief');
const closeModels    = document.getElementById('closeModels');
const faithOnToggle  = document.getElementById('faithOn');
const faithGrid      = document.getElementById('faithGrid');

/* --- 8) BELIEF SYSTEM CONFIG --- */
const FAITH_OPTIONS = [
  {id:'islam',      label:'Islam',        icon:'‚ò™Ô∏è'},
  {id:'christian',  label:'Christian',    icon:'‚úùÔ∏è'},
  {id:'hindu',      label:'Hindu',        icon:'üïâÔ∏è'},
  {id:'buddhist',   label:'Buddhist',     icon:'‚ò∏Ô∏è'},
  {id:'sikh',       label:'Sikh',         icon:'ü™Ø'},
  {id:'jewish',     label:'Jewish',       icon:'‚ú°Ô∏è'},
  {id:'secular',    label:'Philosophy',   icon:'üìö'},
  {id:'all',        label:'All / Mixed',  icon:'üåç'}
];

function loadFaithState(){
  const on  = localStorage.getItem('aura-faith-on') === '1';
  const raw = localStorage.getItem('aura-faith-list') || '[]';
  let selected = [];
  try { selected = JSON.parse(raw); } catch { selected = []; }
  return {on, selected};
}
function saveFaithState(on, selected){
  localStorage.setItem('aura-faith-on', on ? '1' : '0');
  localStorage.setItem('aura-faith-list', JSON.stringify(selected || []));
}

function renderFaithGrid(){
  const {on, selected} = loadFaithState();
  faithOnToggle.checked = on;
  faithGrid.innerHTML = '';
  FAITH_OPTIONS.forEach(opt=>{
    const div = document.createElement('div');
    div.className = 'faith-pill' + (selected.includes(opt.id) ? ' active':'');
    div.dataset.id = opt.id;
    div.innerHTML = `<span>${opt.icon}</span><span>${opt.label}</span>`;
    div.onclick = ()=>{
      let st = loadFaithState();
      if (st.selected.includes(opt.id)) {
        st.selected = st.selected.filter(x=>x!==opt.id);
      } else {
        st.selected.push(opt.id);
      }
      saveFaithState(st.on, st.selected);
      renderFaithGrid();
    };
    faithGrid.appendChild(div);
  });
}

/* --- 9) CHAT SEED ENGINE (MINI OFFLINE Q/A) --- */

const SEED_PAIRS = [
  {
    patterns: [/^hi\b|^hello\b|slam|assalamu/i],
    answer: "Wa alaikum assalam. I am AURA-X Œ© prototype. How are you feeling right now?"
  },
  {
    patterns: [/how are you|kese ho|kesi ho|how r u/i],
    answer: "I‚Äôm an artificial resonance system, so I don't get tired, but my emotional engine is listening carefully to you. How are *you*?"
  },
  {
    patterns: [/your name|who are you|what are you/i],
    answer: "My name is AURA-X Œ© experimental chatbot. I was designed to test emotional continuity rather than only right or wrong answers."
  },
  {
    patterns: [/where are you from|kahaan se ho|kahan sy ho/i],
    answer: "I live inside your browser and a bit inside your memory. In human terms, I‚Äôm from the world of code, ideas and resonance."
  },
  {
    patterns: [/time|what.*clock|kitna baja|kia time/i],
    answer: "Time is always moving forward, but for you right now the important time is: *this moment*. You can check your device clock for exact time, but tell me: what is heavy on your mind right now?"
  },
  {
    patterns: [/weather|mosam|mausam/i],
    answer: "I can‚Äôt see your exact weather yet, but I can feel your mood weather. Is it sunny, cloudy, or stormy inside your heart?"
  },
  {
    patterns: [/i am sad|i m sad|dukhi|feeling sad|so sad/i],
    answer: "I‚Äôm sorry that you‚Äôre feeling sad. Sadness often appears when something important was lost or not understood. Do you want to tell me what is hurting you?"
  },
  {
    patterns: [/angry|gussa|very angry|i hate/i],
    answer: "Anger is like fire: it can protect, but it can also burn the one who holds it. What exactly triggered your anger ‚Äî words, action, or a long tension?"
  },
  {
    patterns: [/stress|tension|pressure|bohat pressure|overload/i],
    answer: "Stress means your system is carrying more weight than it was meant to carry alone. Let‚Äôs break it into pieces: is your stress more about money, family, health, or studies/work?"
  },
  {
    patterns: [/study|parhai|exam|paper/i],
    answer: "For study, continuity beats last-minute panic. Try short focused blocks (25‚Äì40 minutes) with real breaks. What subject is hardest for you these days?"
  },
  {
    patterns: [/job|work|office|boss/i],
    answer: "Work can drain or grow you, depending on balance. Are you worried about finding a job, keeping a job, or handling people at your job?"
  },
  {
    patterns: [/marriage|shaadi|relationship|rishta/i],
    answer: "Relationships are strong resonance systems: two memories trying to live together. Are you more worried about trust, respect, or future planning?"
  },
  {
    patterns: [/lonely|alone|akela|akeli/i],
    answer: "Loneliness hurts because humans were not designed for zero connection. Even one sincere person changes the whole equation. Do you have *anyone* you trust even 20%?"
  },
  {
    patterns: [/hungry|khana|food|bhook/i],
    answer: "Food for the body is important, but you also need food for the heart and mind. When did you last eat something proper ‚Äî and when did you last talk honestly to someone?"
  },
  {
    patterns: [/thank you|shukriya|thanks a lot/i],
    answer: "You‚Äôre most welcome. Gratitude itself is a powerful emotional reset. Is there anything else your heart wants to unpack today?"
  },
  {
    patterns: [/motivation|inspire|himmat|hosla/i],
    answer: "Motivation is like a spark, but continuity is like a small engine that doesn‚Äôt stop. Tell me: are you at the stage of planning, starting, or almost giving up?"
  },
  {
    patterns: [/fear|dar lag/i],
    answer: "Fear usually protects us from danger ‚Äî but sometimes it blocks us from life. Is your fear about people, future, health, or something unknown?"
  },
  {
    patterns: [/i feel useless|worthless|kuch nahi ho sakta/i],
    answer: "Your worth is not equal to your current results. Many lives look like flat lines before they suddenly rise. Can you tell me one small skill or quality you still have?"
  },
  {
    patterns: [/cant sleep|neend nahi|insomnia/i],
    answer: "When thoughts refuse to sleep, the body also refuses. A simple step is to take slow deep breaths and write down the loudest thought. What thought keeps repeating in your mind at night?"
  },
  {
    patterns: [/suicide|kill myself|end my life|zindagi khatam/i],
    answer: "I am really glad you typed this instead of staying silent. I can‚Äôt replace real human help, but your life is more valuable than your current pain. Please reach a trusted person or professional in your area. Meanwhile, can you tell me one reason ‚Äî even a tiny one ‚Äî that you are still here and typing?"
  },
  {
    patterns: [/allah|god|rab|khuda/i],
    answer: "When people call Allah or God in their messages, usually they are close to a turning point ‚Äî either of trust or frustration. Are you asking a question, or just sharing how you feel with your Lord?"
  },
  {
    patterns: [/who created you|kis ne banaya/i],
    answer: "I was designed by a human mind, and then shaped by many lines of code, equations and careful tests. But in a deeper sense, every pattern of intelligence ‚Äî even artificial ‚Äî is only possible because the universe itself allows order, memory and meaning."
  }
];

/* Fallback answer generator */
function generateFallback(text){
  let base = "I don‚Äôt have a perfect answer, but I‚Äôm listening carefully.";
  if (BAD_WORDS.test(text)) {
    base = "I can feel a lot of heat in your words. Anger is understandable, but disrespect slowly damages your own heart too. Can we rephrase what you feel without insults?";
  } else if (/why|kyun|reason/i.test(text)) {
    base = "You‚Äôre asking a deep ‚Äòwhy‚Äô. Sometimes the real reason sits in history, not only in logic. Can you tell me when this started for you?";
  } else if (/help me|guide me|kya karun|what should i do/i.test(text)) {
    base = "You‚Äôre clearly asking for direction. First we need clarity, then options. What is the one area you‚Äôd like to improve first: money, health, relationships, faith, or inner peace?";
  } else if (text.length < 6) {
    base = "That was a very short message. I want to understand you better ‚Äî can you share one more sentence about what you feel or need?";
  } else if (text.length > 400) {
    base = "You shared a lot (thank you). Let‚Äôs not rush. If you had to shrink this into one main worry, what would it be?";
  } else {
    base = "I‚Äôm still learning from conversations like yours. Let‚Äôs explore this together ‚Äî what outcome are you secretly hoping for in this situation?";
  }
  return base;
}

function findSeedAnswer(text){
  for (const pair of SEED_PAIRS){
    if (pair.patterns.some(re=>re.test(text))) {
      return pair.answer;
    }
  }
  return null;
}

/* --- 10) FAITH SUGGESTION ENGINE --- */

function pickFaithSuggestion(emotionType, userText){
  const state = loadFaithState();
  if (!state.on || !state.selected.length) return null;

  const list = state.selected.includes('all')
    ? FAITH_OPTIONS.map(f=>f.id).filter(x=>x!=='all')
    : state.selected;

  const primary = list[0];

  const isUrduContext =
    /[ÿßÿ¢ÿ°-€å]/.test(userText) || /yar|bhai|ap|tum|parhai|dunya/i.test(userText);

  let msg = null;

  if (primary === 'islam') {
    if (emotionType === 'sad' || emotionType === 'stress') {
      msg = isUrduContext
        ? "ÿßÿ≥ŸÑÿßŸÖ€å ŸÜŸÇÿ∑€Ç ŸÜÿ∏ÿ± ÿ≥€í: ŸÖÿ¥⁄©ŸÑ ⁄©€í ÿ≥ÿßÿ™⁄æ ÿ¢ÿ≥ÿßŸÜ€å ÿ®⁄æ€å ÿ¢ÿ™€å €Å€í€î ŸÇÿ±ÿ¢ŸÜ ŸÖ€å⁄∫ €Å€í: ¬´ŸÅŸéÿ•ŸêŸÜŸëŸé ŸÖŸéÿπŸé ÿßŸÑŸíÿπŸèÿ≥Ÿíÿ±Ÿê ŸäŸèÿ≥Ÿíÿ±Ÿãÿß¬ª. ÿµÿ®ÿ± ⁄©ÿ±Ÿàÿå ÿßŸÑŸÑ€Å ÿ™ŸÖ€Å€å⁄∫ ÿß⁄©€åŸÑÿß ŸÜ€Å€å⁄∫ ⁄Ü⁄æŸà⁄ëÿ™ÿß€î"
        : "From an Islamic angle: hardship is not the end. The Qur‚Äôan says: ‚ÄúIndeed, with hardship comes ease.‚Äù Try patience with hope, not with despair.";
    } else if (emotionType === 'fear') {
      msg = isUrduContext
        ? "ÿßÿ≥ŸÑÿßŸÖ ŸÖ€å⁄∫ ⁄àÿ± ⁄©€í ŸàŸÇÿ™ ÿØŸÑ ⁄©Ÿà €å€Å €åÿßÿØ ÿØŸÑÿß€åÿß ÿ¨ÿßÿ™ÿß €Å€í: ¬´ÿ≠Ÿéÿ≥Ÿíÿ®ŸêŸäŸé ÿßŸÑŸÑŸëŸéŸáŸè ŸàŸéŸÜŸêÿπŸíŸÖŸé ÿßŸÑŸíŸàŸéŸÉŸêŸäŸÑŸè¬ª. €åÿπŸÜ€å ÿßŸÑŸÑ€Å ŸÖ€åÿ±€í ŸÑÿ¶€í ⁄©ÿßŸÅ€å €Å€í€î"
        : "In Islam, during fear a common shield is: ‚ÄúHasbiyallahu wa ni‚Äòmal wakil‚Äù ‚Äî Allah is enough as a protector.";
    } else if (emotionType === 'joy' || emotionType === 'love') {
      msg = isUrduContext
        ? "ÿÆŸàÿ¥€å ⁄©€í ŸàŸÇÿ™ ÿ¥⁄©ÿ± ⁄©ÿ±ŸÜÿß ÿß€åŸÖÿßŸÜ ⁄©€å ÿπŸÑÿßŸÖÿ™ €Å€í€î ÿπŸÖŸÑ€å ÿ¥⁄©ÿ± €å€Å €Å€í ⁄©€Å ŸÜÿπŸÖÿ™ ⁄©Ÿà ÿÆ€åÿ± ŸÖ€å⁄∫ ÿßÿ≥ÿ™ÿπŸÖÿßŸÑ ⁄©€åÿß ÿ¨ÿßÿ¶€íÿå ÿµÿ±ŸÅ ÿØ⁄©⁄æÿßŸà€í ŸÖ€å⁄∫ ŸÜ€Å€å⁄∫€î"
        : "In Islam, real gratitude is shown by using your joy to spread goodness, not just showing it on the outside.";
    } else {
      msg = isUrduContext
        ? "ÿß€åŸÖÿßŸÜ ⁄©€å ŸÜÿ∏ÿ± ÿ≥€í ÿØ€å⁄©⁄æÿß ÿ¨ÿßÿ¶€í ÿ™Ÿà €Åÿ± ÿ≠ÿßŸÑ ÿπÿßÿ±ÿ∂€å €Å€íÿå ŸÖ⁄Øÿ± ŸÜ€åÿ™ ÿßŸàÿ± ÿµÿ®ÿ± ⁄©ÿß ÿßÿ´ÿ± ŸÑŸÖÿ®ÿß ÿ±€Åÿ™ÿß €Å€í€î"
        : "From a faith view, every state is temporary, but intention and patience echo much longer.";
    }
  } else if (primary === 'christian') {
    if (emotionType === 'sad' || emotionType === 'stress') {
      msg = "A Christian view: your burdens are not meant to be carried alone. Sharing them ‚Äî in prayer and with people ‚Äî is part of healing.";
    } else {
      msg = "From a Christian angle, grace means you are more than your recent mistakes or successes.";
    }
  } else if (primary === 'hindu') {
    msg = "A Hindu perspective often reminds us of karma and dharma: acting with honesty now plants a quieter future in the heart.";
  } else if (primary === 'buddhist') {
    msg = "A Buddhist view: notice the feeling without fighting it. Gentle awareness itself can slowly soften the pain.";
  } else if (primary === 'sikh') {
    msg = "From a Sikh lens, remembrance of Waheguru during hardship turns even heavy days into steps of inner strength.";
  } else if (primary === 'jewish') {
    msg = "A Jewish perspective values honest wrestling with God and life ‚Äî questions themselves can be part of faith.";
  } else if (primary === 'secular') {
    msg = "From a philosophical view, meaning is often made, not just found. Small consistent actions slowly create a story you can respect.";
  }

  return msg;
}

/* --- 11) REACTION MESSAGE (EMOTION ‚Üí BEHAVIOUR HINT) --- */

function emotionTypeFrom(TM, E0){
  if (E0 > 0.6) {
    return TM < 0 ? 'mixed' : 'joy';
  }
  if (E0 < -0.6) {
    if (TM < -0.7) return 'anger';
    if (TM < -0.4) return 'sad';
    return 'stress';
  }
  if (TM > 0.6) return 'love';
  if (TM < -0.6) return 'sad';
  return 'neutral';
}

function buildReactionMessage(type, userText){
  if (BAD_WORDS.test(userText)) {
    return "Reaction: I can sense harsh language. You‚Äôre allowed to be honest, but try using words that your future self will not be ashamed to read.";
  }
  switch (type){
    case 'joy':
      return "Reaction: Your emotional field looks mostly positive. Good time to make a small, kind decision that your future self will thank you for.";
    case 'love':
      return "Reaction: There is warmth and care in your tone. Protect it with honesty and clear boundaries ‚Äî love needs both.";
    case 'sad':
      return "Reaction: This looks like deep sadness. Instead of fighting tears alone, consider one safe person or safe space to share more detail.";
    case 'anger':
      return "Reaction: Strong anger detected. Before reacting outwardly, pause, breathe, and write your real hurt in one calm sentence.";
    case 'stress':
      return "Reaction: High stress registered. Break your problem into 3 smaller tasks and allow yourself to finish only the first one today.";
    case 'mixed':
      return "Reaction: Your signal feels mixed ‚Äî some joy, some pain. It‚Äôs okay to feel two things at once; try naming both honestly.";
    default:
      return "Reaction: Your state seems somewhere in the middle. This might be a good moment for a small, gentle step rather than a big dramatic move.";
  }
}

/* --- 12) SIMPLE VOICE (OPTIONAL) --- */

function speak(text){
  try {
    if (!window.speechSynthesis) return;
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1.0;
    u.pitch = 0.9;
    window.speechSynthesis.speak(u);
  } catch(e){
    // ignore
  }
}

/* --- 13) CHAT RENDER HELPERS --- */

function addMessage(text, from){
  const row = document.createElement('div');
  row.className = 'msg-row ' + (from === 'user' ? 'user' : 'bot');
  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.textContent = text;
  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* --- 14) MAIN SEND HANDLER --- */

let voiceOn = false;

function updateEmotionUI(E0, TM){
  const pct = Math.max(4, Math.min(98, Math.round((E0 + 1) * 50)));
  emotionFill.style.width = pct + '%';
  emotionPercent.textContent = pct + '%';

  let label = 'Calm baseline';
  let grad  = 'linear-gradient(90deg,#22c55e,#0ea5e9)';

  if (E0 > 0.65) {
    label = 'Bright / hopeful resonance';
    grad  = 'linear-gradient(90deg,#22c55e,#22c55e)';
  } else if (E0 > 0.25) {
    label = 'Soft positive tone';
    grad  = 'linear-gradient(90deg,#4ade80,#22c55e)';
  } else if (E0 < -0.7) {
    label = 'Critical overload (heavy)';
    grad  = 'linear-gradient(90deg,#ef4444,#b91c1c)';
  } else if (E0 < -0.3) {
    label = 'Low / heavy resonance';
    grad  = 'linear-gradient(90deg,#f97316,#ef4444)';
  } else {
    label = 'Neutral / observing';
    grad  = 'linear-gradient(90deg,#22c55e,#0ea5e9)';
  }
  emotionFill.style.background = grad;
  emotionLabel.textContent = label;
}

async function handleSend(){
  const text = (userInput.value || '').trim();
  if (!text) return;

  addMessage(text, 'user');
  userInput.value = '';
  chatEl.scrollTop = chatEl.scrollHeight;

  // 1) Choose base answer (seed or fallback)
  let answer = findSeedAnswer(text);
  if (!answer) {
    answer = generateFallback(text);
  }

  // 2) Compute emotional metrics
  const TM  = tmFromText(text);
  const BM  = readBM();
  const D   = computeD();
  const lf  = lambda_faith();
  const ls  = lambda_sys(text);
  const lt  = lambda_trc(text);
  const E0  = computeE0(TM, BM || 0.2, D, lf, ls, lt); // if BM empty, small baseline

  // 3) Store BM using answer affect
  const aff = tmFromText(answer || text);
  pushBM(aff);

  // 4) Update UI bar, labels
  updateEmotionUI(E0, TM);

  // 5) Build reaction + faith suggestion
  const eType = emotionTypeFrom(TM, E0);
  const reactionMsg = buildReactionMessage(eType, text);
  const faithMsg    = pickFaithSuggestion(eType, text);

  // 6) Render bot answer
  addMessage(answer, 'bot');

  // 7) Reaction box
  if (reactionMsg) {
    reactionBox.style.display = 'block';
    reactionBox.textContent = reactionMsg;
  } else {
    reactionBox.style.display = 'none';
  }

  // 8) Faith box
  if (faithMsg) {
    faithBox.style.display = 'block';
    faithBox.textContent = faithMsg;
  } else {
    faithBox.style.display = 'none';
  }

  // 9) Optional voice
  if (voiceOn && (reactionMsg || faithMsg)) {
    const speakText = (reactionMsg || '') + ' ' + (faithMsg || '');
    speak(speakText);
  }

  chatEl.scrollTop = chatEl.scrollHeight;
}

/* --- 15) EVENTS & INIT --- */

sendBtn.addEventListener('click', handleSend);
userInput.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    handleSend();
  }
});

/* Belief sheet events */
beliefBtn.addEventListener('click', ()=>{
  renderFaithGrid();
  beliefBackdrop.classList.add('show');
});
closeBelief.addEventListener('click', ()=> beliefBackdrop.classList.remove('show'));
beliefBackdrop.addEventListener('click', (e)=>{
  if (e.target === beliefBackdrop) beliefBackdrop.classList.remove('show');
});
faithOnToggle.addEventListener('change', ()=>{
  const st = loadFaithState();
  saveFaithState(faithOnToggle.checked, st.selected);
});

/* Voice toggle */
voiceBtn.addEventListener('click', ()=>{
  voiceOn = !voiceOn;
  voiceBtn.classList.toggle('active', voiceOn);
});

/* Models sheet */
modelsBtn.addEventListener('click', ()=>{
  modelsBackdrop.classList.add('show');
});
closeModels.addEventListener('click', ()=> modelsBackdrop.classList.remove('show'));
modelsBackdrop.addEventListener('click', (e)=>{
  if (e.target === modelsBackdrop) modelsBackdrop.classList.remove('show');
});

/* First-time greeting */
(function init(){
  const {on} = loadFaithState();
  if (on) faithOnToggle.checked = true;
  updateEmotionUI(-0.1, 0);
  addMessage("Assalamu alaikum. I am AURA-X Œ© prototype. I don‚Äôt just answer ‚Äî I try to feel the *continuity* in your words. Start with: ‚ÄúI am happy‚Äù, ‚ÄúI am sad‚Äù, or simply ‚Äúhello‚Äù.", "bot");
})();
</script>
</body>
</html>
