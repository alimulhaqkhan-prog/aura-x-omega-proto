<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Reactor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ===== Base Layout ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
    }
    body {
      background: radial-gradient(circle at top, #021b3d 0, #020617 55%, #000 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "SF Pro Text", "Segoe UI", sans-serif;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
    }
    #app {
      width: 100%;
      max-width: 480px;
      height: 100%;
      max-height: 860px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow:
        0 0 0 1px rgba(56, 189, 248, 0.25),
        0 30px 80px rgba(8, 47, 73, 0.9);
      padding: 16px 16px 12px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* ===== Header ===== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .reactor-pill,
    .continuity-pill {
      padding: 8px 14px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, #22c55e 0, #065f46 32%, #022c22 100%);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
      line-height: 1.15;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.7);
    }
    .reactor-pill {
      min-width: 180px;
    }
    .reactor-title-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 11px;
    }
    .reactor-dot {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #bbf7d0 0, #22c55e 30%, #14532d 100%);
      box-shadow:
        0 0 15px rgba(74, 222, 128, 0.9),
        0 0 30px rgba(22, 163, 74, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #022c22;
      font-weight: 700;
    }
    .reactor-subtitle {
      font-size: 10px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    .pill-label {
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      opacity: 0.8;
    }
    .pill-value {
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
    }
    .status-dot.offline {
      background: #f97316;
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.8);
    }

    /* ===== Chat Window ===== */
    .chat-window {
      flex: 1;
      border-radius: 20px;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.28), transparent 60%),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.3), transparent 55%),
        rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 12px;
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
      box-shadow:
        0 0 0 1px rgba(15, 118, 110, 0.7),
        inset 0 0 40px rgba(15, 23, 42, 0.9);
    }
    .chat-scroll {
      position: absolute;
      inset: 12px;
      padding-right: 6px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scroll-behavior: smooth;
    }
    .chat-bubble {
      max-width: 90%;
      padding: 9px 11px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.35;
      letter-spacing: 0.01em;
      box-shadow: 0 10px 35px rgba(15, 23, 42, 0.9);
    }
    .chat-bubble.bot {
      align-self: flex-start;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(129, 140, 248, 0.8);
    }
    .chat-bubble.user {
      align-self: flex-end;
      background: radial-gradient(circle at top left, #22c55e, #15803d);
      border: 1px solid rgba(74, 222, 128, 0.8);
      color: #022c22;
      font-weight: 500;
    }
    .chat-bubble.system {
      align-self: center;
      background: rgba(30, 64, 175, 0.8);
      border: 1px dashed rgba(129, 140, 248, 0.9);
      font-size: 12px;
      opacity: 0.95;
    }
    .chat-bubble.error {
      align-self: flex-start;
      border: 1px solid rgba(248, 113, 113, 0.9);
      background:
        radial-gradient(circle at top left, rgba(248, 113, 113, 0.5), rgba(24, 24, 27, 0.98));
      color: #fecaca;
    }
    .chat-meta {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
    }
    .chat-bubble .highlight {
      font-weight: 600;
      color: #f97316;
    }

    /* ===== Scalars ===== */
    .scalars {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }
    .scalar-card {
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(8, 47, 73, 0.95));
      border-radius: 14px;
      padding: 8px 9px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.9);
    }
    .scalar-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 11px;
      margin-bottom: 4px;
    }
    .scalar-label {
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 10px;
      opacity: 0.9;
    }
    .scalar-value {
      font-weight: 600;
      font-size: 12px;
    }
    .scalar-bar {
      position: relative;
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 1);
      overflow: hidden;
      margin-bottom: 4px;
    }
    .scalar-fill {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #38bdf8, #a855f7);
      transform-origin: left;
      transform: scaleX(0.6);
      transition: transform 300ms ease-out;
    }
    .scalar-caption {
      font-size: 10px;
      opacity: 0.8;
    }

    /* ===== Input & Controls ===== */
    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .input-row textarea {
      flex: 1;
      resize: none;
      min-height: 40px;
      max-height: 70px;
      border-radius: 999px;
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
      box-shadow: inset 0 0 25px rgba(15, 23, 42, 0.95);
    }
    .input-row textarea::placeholder {
      color: rgba(148, 163, 184, 0.9);
    }
    .icon-button,
    .send-button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      font-size: 14px;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    .icon-button {
      background: radial-gradient(circle at top, #1e293b, #020617);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
      min-width: 36px;
    }
    .send-button {
      padding: 0 20px;
      background: radial-gradient(circle at top left, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 600;
      font-size: 13px;
      box-shadow:
        0 0 15px rgba(74, 222, 128, 0.9),
        0 20px 40px rgba(22, 163, 74, 0.9);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .icon-button:active,
    .send-button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: none;
    }

    .helper-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .chip-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      font-size: 11px;
    }
    .chip {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      padding: 6px 12px;
      background: radial-gradient(circle at top, #020617, #020617);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.9);
      transition: background 120ms ease, transform 120ms ease, box-shadow 120ms ease;
    }
    .chip:hover {
      background: radial-gradient(circle at top, #0f172a, #020617);
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 1);
    }
    .chip-pill-label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 9px;
      opacity: 0.7;
    }
    .chip-pill-value {
      font-weight: 600;
      font-size: 11px;
    }
    .chip-pill {
      padding: 6px 12px;
    }
    .chip-pill.active {
      border-color: rgba(34, 197, 94, 0.9);
      box-shadow: 0 0 18px rgba(34, 197, 94, 0.8);
    }

    /* ===== Belief Modal ===== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(3, 7, 18, 0.98));
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }
    .modal-backdrop.open {
      display: flex;
    }
    .modal-panel {
      width: 100%;
      max-width: 480px;
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), #020617);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.6),
        0 30px 90px rgba(15, 23, 42, 1);
      padding: 16px 18px 14px;
      font-size: 13px;
      position: relative;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .modal-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      opacity: 0.9;
    }
    .modal-close {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 13px;
    }
    .modal-section {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      padding: 10px 11px;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .modal-section strong {
      color: #a5b4fc;
    }
    .belief-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .belief-chip {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      padding: 6px 10px;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.95);
      transition: background 120ms ease, border-color 120ms ease, box-shadow 120ms ease;
    }
    .belief-chip.active {
      border-color: rgba(59, 130, 246, 0.95);
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.9), rgba(15, 23, 42, 0.98));
      box-shadow: 0 0 18px rgba(59, 130, 246, 0.7);
    }
    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 11px;
      opacity: 0.85;
    }
    .modal-footer-actions {
      display: flex;
      gap: 8px;
    }
    .btn-secondary,
    .btn-primary {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 12px;
      padding: 6px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      border-color: rgba(59, 130, 246, 0.95);
      background: radial-gradient(circle at top left, #3b82f6, #1d4ed8);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.9);
      font-weight: 600;
    }

    .tiny-muted {
      font-size: 10px;
      opacity: 0.75;
      margin-top: 4px;
    }

    /* Scrollbar (mobile-safe) */
    .chat-scroll::-webkit-scrollbar {
      width: 4px;
    }
    .chat-scroll::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <div class="header">
      <div class="reactor-pill">
        <div class="reactor-title-row">
          <div class="reactor-dot">Œ©</div>
          <span>AURA-X Œ©</span>
        </div>
        <div class="reactor-subtitle">Emotional Continuity Reactor ¬∑ v1</div>
      </div>

      <div class="continuity-pill">
        <div class="pill-label">CONTINUITY MODE</div>
        <div class="pill-value">
          <span>ON</span>
          <span id="connection-indicator" class="status-dot offline"></span>
          <span id="connection-text">Backend connecting‚Ä¶</span>
        </div>
      </div>
    </div>

    <!-- Chat Window -->
    <div class="chat-window">
      <div id="chat-scroll" class="chat-scroll"></div>
    </div>

    <!-- Scalars -->
    <div class="scalars">
      <div class="scalar-card">
        <div class="scalar-header">
          <div class="scalar-label">TM ¬∑ TRUST MEMORY</div>
          <div id="tmValue" class="scalar-value">0.60</div>
        </div>
        <div class="scalar-bar">
          <div id="tmBar" class="scalar-fill"></div>
        </div>
        <div id="tmCaption" class="scalar-caption">
          Your memories feel stable and accessible.
        </div>
      </div>

      <div class="scalar-card">
        <div class="scalar-header">
          <div class="scalar-label">BM ¬∑ BASELINE MOOD</div>
          <div id="bmValue" class="scalar-value">0.60</div>
        </div>
        <div class="scalar-bar">
          <div id="bmBar" class="scalar-fill"></div>
        </div>
        <div id="bmCaption" class="scalar-caption">
          Mood is mixed but workable.
        </div>
      </div>

      <div class="scalar-card">
        <div class="scalar-header">
          <div class="scalar-label">D ¬∑ DISTURBANCE</div>
          <div id="dValue" class="scalar-value">0.18</div>
        </div>
        <div class="scalar-bar">
          <div id="dBar" class="scalar-fill"></div>
        </div>
        <div id="dCaption" class="scalar-caption">
          Mental noise is low ‚Äì thoughts can flow.
        </div>
      </div>

      <div class="scalar-card">
        <div class="scalar-header">
          <div class="scalar-label">Œ£ ¬∑ CONTINUITY</div>
          <div id="sValue" class="scalar-value">0.82</div>
        </div>
        <div class="scalar-bar">
          <div id="sBar" class="scalar-fill"></div>
        </div>
        <div id="sCaption" class="scalar-caption">
          Your story is moving along one main emotional line.
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="input-row">
      <textarea
        id="user-input"
        rows="2"
        placeholder="Ask anything‚Ä¶ For example: 'Today I feel tired but hopeful.'"
      ></textarea>
      <button id="mic-button" class="icon-button" title="(Demo only ‚Äì not wired yet)">
        üéôÔ∏è
      </button>
      <button id="stop-voice" class="icon-button" title="Stop voice playback">
        ‚èπ
      </button>
      <button id="send-button" class="send-button">SEND</button>
    </div>

    <div class="helper-row">
      <span>Press <strong>Enter</strong> to send. Every turn updates the emotional scalars.</span>
      <span id="mini-status"></span>
    </div>

    <!-- Chips -->
    <div class="chip-row">
      <div id="belief-chip" class="chip">
        <span>Belief &amp; Ethics</span>
      </div>

      <div id="voice-toggle" class="chip chip-pill">
        <div class="chip-pill-label">VOICE REPLIES</div>
        <div id="voice-label" class="chip-pill-value">OFF</div>
      </div>
    </div>
  </div>

  <!-- Belief Modal -->
  <div id="belief-modal" class="modal-backdrop">
    <div class="modal-panel">
      <div class="modal-header">
        <div class="modal-title">Belief Layer ¬∑ Ethical Mode</div>
        <button id="modal-close" class="modal-close">‚úï</button>
      </div>

      <div class="modal-section">
        <strong>Default mode:</strong> If you do not select any belief,
        AURA-X Œ© will follow only <strong>universal ethics</strong> ‚Äî
        respect, honesty, consent, harm-avoidance, justice, and
        psychological safety.
        <br /><br />
        You can optionally select one or more belief lenses below.
        Answers will try to stay respectful to those sensitivities without
        judging any group.
      </div>

      <div class="modal-section">
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: .16em; opacity:.85; margin-bottom:6px;">
          Select belief layers
        </div>

        <div class="belief-grid">
          <button class="belief-chip" data-belief="Islam">Islam</button>
          <button class="belief-chip" data-belief="Christianity">Christianity</button>
          <button class="belief-chip" data-belief="Hinduism">Hinduism</button>
          <button class="belief-chip" data-belief="Buddhism">Buddhism</button>
          <button class="belief-chip" data-belief="Atheist/Secular">Atheist / Secular</button>
          <button class="belief-chip" data-belief="All faiths">
            All faiths (multi-respect)
          </button>
        </div>

        <div class="tiny-muted">
          Note: The belief layer is only for your comfort. The system never
          judges you or anyone else ‚Äì it just tries to keep answers safe,
          kind, and emotionally grounded.
        </div>
      </div>

      <div class="modal-footer">
        <div id="belief-summary">Universal ethics only (no belief selected).</div>
        <div class="modal-footer-actions">
          <button id="clear-beliefs" class="btn-secondary">Clear all</button>
          <button id="apply-beliefs" class="btn-primary">
            Apply
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_URL = "https://aura-x-backend-jliz.onrender.com/api/chat";

    // ===== STATE =====
    let voiceEnabled = false;
    let selectedBeliefs = [];
    let state = {
      tm: 0.6,
      bm: 0.6,
      d: 0.18,
      s: 0.82,
      beliefs: [],
    };

    // ===== DOM =====
    const chatScroll = document.getElementById("chat-scroll");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");
    const micButton = document.getElementById("mic-button");
    const stopVoiceBtn = document.getElementById("stop-voice");
    const miniStatus = document.getElementById("mini-status");
    const connectionIndicator = document.getElementById("connection-indicator");
    const connectionText = document.getElementById("connection-text");

    const tmValue = document.getElementById("tmValue");
    const bmValue = document.getElementById("bmValue");
    const dValue = document.getElementById("dValue");
    const sValue = document.getElementById("sValue");
    const tmBar = document.getElementById("tmBar");
    const bmBar = document.getElementById("bmBar");
    const dBar = document.getElementById("dBar");
    const sBar = document.getElementById("sBar");
    const tmCaption = document.getElementById("tmCaption");
    const bmCaption = document.getElementById("bmCaption");
    const dCaption = document.getElementById("dCaption");
    const sCaption = document.getElementById("sCaption");

    const beliefChip = document.getElementById("belief-chip");
    const voiceToggle = document.getElementById("voice-toggle");
    const voiceLabel = document.getElementById("voice-label");

    const beliefModal = document.getElementById("belief-modal");
    const modalClose = document.getElementById("modal-close");
    const beliefSummary = document.getElementById("belief-summary");
    const clearBeliefsBtn = document.getElementById("clear-beliefs");
    const applyBeliefsBtn = document.getElementById("apply-beliefs");
    const beliefChips = Array.from(document.querySelectorAll(".belief-chip"));

    // ===== Helper: Chat bubbles =====
    function addMessage(text, role = "bot") {
      const bubble = document.createElement("div");
      bubble.classList.add("chat-bubble", role);
      bubble.innerHTML = text;
      chatScroll.appendChild(bubble);
      chatScroll.scrollTop = chatScroll.scrollHeight;
    }

    function setConnectionStatus(ok) {
      if (ok) {
        connectionIndicator.classList.remove("offline");
        connectionText.textContent = "Backend connected";
      } else {
        connectionIndicator.classList.add("offline");
        connectionText.textContent = "Connection issue";
      }
    }

    // ===== Helper: Scalars (simple demo logic) =====
    function clamp(v) {
      return Math.max(0, Math.min(1, v));
    }

    function updateScalars(newState) {
      if (!newState) return;

      // simple smoothing so values move gently
      const lerp = (a, b, t) => a + (b - a) * t;

      state.tm = clamp(lerp(state.tm, newState.tm ?? state.tm, 0.35));
      state.bm = clamp(lerp(state.bm, newState.bm ?? state.bm, 0.35));
      state.d = clamp(lerp(state.d, newState.d ?? state.d, 0.35));
      state.s = clamp(lerp(state.s, newState.s ?? state.s, 0.35));
      state.beliefs = selectedBeliefs.slice();

      tmValue.textContent = state.tm.toFixed(2);
      bmValue.textContent = state.bm.toFixed(2);
      dValue.textContent = state.d.toFixed(2);
      sValue.textContent = state.s.toFixed(2);

      tmBar.style.transform = `scaleX(${state.tm})`;
      bmBar.style.transform = `scaleX(${state.bm})`;
      dBar.style.transform = `scaleX(${state.d})`;
      sBar.style.transform = `scaleX(${state.s})`;

      // Captions (very simple interpretation)
      tmCaption.textContent =
        state.tm > 0.7
          ? "Your memories feel anchored and reliable."
          : state.tm > 0.4
          ? "Memories are accessible but slightly shaky."
          : "Memory feels scattered ‚Äì it might help to slow down.";

      bmCaption.textContent =
        state.bm > 0.7
          ? "Your baseline mood is mostly positive."
          : state.bm > 0.4
          ? "Your mood is mixed but functional."
          : "Mood is low ‚Äì we will keep the tone gentle.";

      dCaption.textContent =
        state.d < 0.3
          ? "Mental noise is low ‚Äì thoughts can flow clearly."
          : state.d < 0.6
          ? "There is some disturbance ‚Äì we will keep answers structured."
          : "High disturbance ‚Äì short and grounded replies may help.";

      sCaption.textContent =
        state.s > 0.7
          ? "Your story is following one main emotional line."
          : state.s > 0.4
          ? "Your emotional storyline is branching in a few directions."
          : "Continuity is low ‚Äì different feelings are pulling in many directions.";
    }

    // ===== Voice =====
    function updateVoiceChip() {
      if (voiceEnabled) {
        voiceLabel.textContent = "ON";
        voiceToggle.classList.add("active");
      } else {
        voiceLabel.textContent = "OFF";
        voiceToggle.classList.remove("active");
      }
    }

    function speakText(text) {
      if (!voiceEnabled) return;
      if (!("speechSynthesis" in window)) {
        addMessage(
          "‚ö†Ô∏è Voice playback is not supported in this browser. You can keep using text normally.",
          "system"
        );
        voiceEnabled = false;
        updateVoiceChip();
        return;
      }

      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "en-US";
      utter.rate = 1;
      utter.pitch = 1;
      window.speechSynthesis.speak(utter);
    }

    stopVoiceBtn.addEventListener("click", () => {
      if ("speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
    });

    voiceToggle.addEventListener("click", () => {
      voiceEnabled = !voiceEnabled;
      updateVoiceChip();
    });

    // ===== Belief modal logic =====
    function openBeliefModal() {
      beliefModal.classList.add("open");
    }
    function closeBeliefModal() {
      beliefModal.classList.remove("open");
    }

    beliefChip.addEventListener("click", openBeliefModal);
    modalClose.addEventListener("click", closeBeliefModal);

    beliefChips.forEach((chip) => {
      chip.addEventListener("click", () => {
        const value = chip.dataset.belief;
        if (selectedBeliefs.includes(value)) {
          selectedBeliefs = selectedBeliefs.filter((b) => b !== value);
          chip.classList.remove("active");
        } else {
          selectedBeliefs.push(value);
          chip.classList.add("active");
        }
      });
    });

    clearBeliefsBtn.addEventListener("click", () => {
      selectedBeliefs = [];
      beliefChips.forEach((c) => c.classList.remove("active"));
      beliefSummary.textContent = "Universal ethics only (no belief selected).";
    });

    applyBeliefsBtn.addEventListener("click", () => {
      if (selectedBeliefs.length === 0) {
        beliefSummary.textContent = "Universal ethics only (no belief selected).";
      } else {
        beliefSummary.textContent = `Universal ethics + ${selectedBeliefs.join(
          ", "
        )}.`;
      }
      closeBeliefModal();
    });

    // ===== Sending messages =====
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      userInput.value = "";
      addMessage(text, "user");
      miniStatus.textContent = "Thinking‚Ä¶";
      setConnectionStatus(true);

      try {
        const payload = {
          userText: text,
          state: {
            tm: state.tm,
            bm: state.bm,
            d: state.d,
            s: state.s,
            beliefs: selectedBeliefs,
          },
        };

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          setConnectionStatus(false);
          const msg = await res.text();
          addMessage(
            `<span class="highlight">HTTP ERROR</span> ¬∑ The backend returned ${res.status}.<div class="chat-meta">Message from server: ${msg}</div>`,
            "error"
          );
          miniStatus.textContent = "";
          return;
        }

        const data = await res.json();
        const replyText = data.replyText || data.message || JSON.stringify(data);
        addMessage(replyText, "bot");
        speakText(replyText);

        if (data.state) {
          updateScalars(data.state);
        } else {
          // slight neutral drift if backend does not send state
          updateScalars({
            tm: state.tm,
            bm: state.bm,
            d: clamp(state.d * 0.98),
            s: clamp(state.s * 1.01),
          });
        }

        miniStatus.textContent = "";
      } catch (err) {
        console.error(err);
        setConnectionStatus(false);
        addMessage(
          `<span class="highlight">Connection error.</span> Please check that the API_URL is correct and your Render instance is awake.`,
          "error"
        );
        miniStatus.textContent = "";
      }
    }

    sendButton.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    micButton.addEventListener("click", () => {
      addMessage(
        "üéôÔ∏è Voice input is not wired yet in this prototype. For now, please type your message.",
        "system"
      );
    });

    // ===== Initial welcome message =====
    function init() {
      addMessage(
        "Assalam o Alaikum, Alim ul Haq üëã<br><br>" +
          "I am <strong>AURA-X Œ©</strong>, your emotional-continuity reactor. " +
          "Talk to me the same way you would talk to a close friend. " +
          "With every message, I will update a small emotional line for you: " +
          "<strong>TM</strong> (Trust Memory), <strong>BM</strong> (Baseline Mood), " +
          "<strong>D</strong> (Disturbance), and <strong>Œ£</strong> (Continuity).<br><br>" +
          "<span class='chat-meta'>Œ© ¬∑ baseline resonance ready ¬∑ TM‚âà0.60 ¬∑ D‚âà0.18</span>",
        "bot"
      );

      addMessage(
        "<strong>Ethics mode:</strong> For now I am using only universal ethics ‚Äì " +
          "respect, honesty, consent, harm-avoidance, justice, and emotional safety. " +
          "If you wish, open the <strong>Belief &amp; Ethics</strong> panel below " +
          "and select one or more belief lenses.",
        "bot"
      );

      updateScalars(state);
      updateVoiceChip();
      setConnectionStatus(true);
    }

    init();
  </script>
</body>
</html>
