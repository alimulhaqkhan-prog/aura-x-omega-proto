<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äî Resonance-Based Synthetic Emotions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #e7f3ff;
      --card: #ffffff;
      --accent: #4f46e5;
      --accent-soft: #c7d2fe;
      --text-main:#111827;
      --text-soft:#4b5563;
      --chip:#f3f4ff;
      --danger:#ef4444;
      --good:#16a34a;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top,#fdfbff,#e7f3ff);
      color:var(--text-main);
      display:flex;
      justify-content:center;
      padding:12px;
    }
    .app{
      width:100%;
      max-width:480px;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .top-card{
      background:var(--card);
      border-radius:18px;
      padding:14px 16px;
      box-shadow:0 12px 30px rgba(15,23,42,0.08);
    }
    .logo-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .logo-dot{
      width:34px;
      height:34px;
      border-radius:12px;
      background:linear-gradient(135deg,#111827,#4b5563);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#f9fafb;
      font-weight:700;
      font-size:20px;
    }
    .title-main{
      font-weight:700;
      font-size:17px;
      letter-spacing:.04em;
    }
    .title-sub{
      font-size:11px;
      color:var(--text-soft);
    }
    .status-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      font-size:11px;
      color:var(--text-soft);
    }
    .pill{
      padding:2px 8px;
      border-radius:999px;
      background:#e5f5ff;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .pill-dot{
      width:8px;height:8px;border-radius:50%;background:#22c55e;
    }

    .emotion-card{
      background:var(--card);
      border-radius:18px;
      padding:10px 14px 12px;
      box-shadow:0 12px 30px rgba(15,23,42,0.06);
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .emotion-bar{
      position:relative;
      width:100%;
      height:14px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
    }
    .emotion-fill{
      height:100%;
      width:50%;
      background:linear-gradient(90deg,#22c55e,#facc15,#ef4444);
      transition:width .35s ease;
    }
    .emotion-label{
      font-size:11px;
      color:var(--text-soft);
      margin-top:2px;
    }
    .heart{
      font-size:32px;
      animation:pulse 1.6s infinite;
    }
    @keyframes pulse{
      0%{transform:scale(1);}
      40%{transform:scale(1.14);}
      100%{transform:scale(1);}
    }
    .time-row{
      font-size:11px;
      color:var(--text-soft);
    }

    .chat-card{
      flex:1;
      background:var(--card);
      border-radius:18px;
      padding:10px 10px 6px;
      box-shadow:0 12px 30px rgba(15,23,42,0.06);
      display:flex;
      flex-direction:column;
      min-height:260px;
    }
    #chat{
      flex:1;
      overflow-y:auto;
      padding:4px 2px 4px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .msg{
      max-width:82%;
      padding:8px 10px;
      border-radius:12px 12px 12px 4px;
      background:#eef2ff;
      font-size:14px;
      line-height:1.32;
      color:var(--text-main);
      white-space:pre-wrap;
    }
    .msg.user{
      margin-left:auto;
      border-radius:12px 12px 4px 12px;
      background:#dbf4ff;
    }
    .msg.faith{
      background:#fff7cc;
      font-size:13px;
      color:#854d0e;
      border-radius:10px;
    }
    .msg.faith::before{
      content:"FAITH SUGGESTION";
      display:block;
      font-size:10px;
      letter-spacing:.11em;
      text-transform:uppercase;
      color:#92400e;
      margin-bottom:2px;
    }
    .msg.react{
      background:#fee2e2;
      color:#7f1d1d;
      font-size:13px;
    }
    .msg.react::before{
      content:"EMOTION REACTION";
      display:block;
      font-size:10px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:#b91c1c;
      margin-bottom:2px;
    }
    .input-row{
      margin-top:4px;
      display:flex;
      gap:6px;
      padding:6px 2px 2px;
      border-top:1px solid #e5e7eb;
    }
    #inp{
      flex:1;
      border:none;
      border-radius:999px;
      padding:9px 14px;
      font-size:14px;
      background:#f3f4ff;
      outline:none;
    }
    #sendBtn{
      border:none;
      border-radius:999px;
      padding:0 16px;
      font-size:14px;
      font-weight:600;
      color:white;
      background:linear-gradient(135deg,#4f46e5,#ec4899);
      box-shadow:0 6px 16px rgba(99,102,241,0.45);
    }

    .bottom-row{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:var(--text-soft);
    }
    .toggles{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .chip-toggle{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:999px;
      background:var(--chip);
    }
    .chip-toggle input{
      accent-color:var(--accent);
    }
    .chip-btn{
      border:none;
      background:var(--chip);
      border-radius:999px;
      padding:5px 10px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--text-soft);
    }
    .chip-btn span{
      font-weight:500;
    }
    .chip-btn.on{
      background:#4f46e5;
      color:#eef2ff;
    }
    .chip-btn.on span{
      font-weight:600;
    }
    .e0{
      font-size:11px;
      color:var(--text-soft);
    }

    /* belief sheet */
    .sheet{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.28);
      backdrop-filter:blur(6px);
      display:flex;
      justify-content:center;
      align-items:flex-end;
      z-index:40;
    }
    .sheet.hidden{display:none;}
    .sheet-panel{
      width:100%;
      max-width:480px;
      background:var(--card);
      border-radius:18px 18px 0 0;
      padding:14px 16px 16px;
      box-shadow:0 -10px 30px rgba(15,23,42,0.25);
    }
    .sheet-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .sheet-title{
      font-weight:600;
      font-size:14px;
    }
    .sheet-close{
      border:none;
      background:#e5e7eb;
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
    }
    .sheet-note{
      font-size:11px;
      color:var(--text-soft);
      margin-top:4px;
      margin-bottom:6px;
    }
    .switch-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin:6px 0 8px;
      font-size:12px;
    }
    .switch-row input{
      accent-color:var(--accent);
      width:18px;height:18px;
    }
    .faith-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-top:4px;
    }
    .faith-btn{
      padding:6px 8px;
      border-radius:999px;
      border:none;
      font-size:12px;
      background:#f3f4ff;
      color:var(--text-soft);
    }
    .faith-btn.on{
      background:#4f46e5;
      color:#eef2ff;
      font-weight:500;
    }

    @media (max-width:480px){
      .app{padding-bottom:10px;}
      .chat-card{min-height:210px;}
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- TOP IDENTITY -->
    <div class="top-card">
      <div class="logo-row">
        <div class="logo-dot">Œ©</div>
        <div>
          <div class="title-main">AURA-X Œ©</div>
          <div class="title-sub">Resonance-Based Synthetic Emotions</div>
        </div>
      </div>
      <div class="status-row">
        <div>World‚Äôs first continuity-driven emotional reactor chat.</div>
        <div class="pill">
          <span class="pill-dot"></span>
          <span>Continuity engine live</span>
        </div>
      </div>
    </div>

    <!-- EMOTION BAR + TIME -->
    <div class="emotion-card">
      <div class="emotion-bar">
        <div id="emotionFill" class="emotion-fill"></div>
      </div>
      <div class="emotion-label">
        Emotional resonance: <span id="emotionPct">50%</span>
      </div>
      <div class="heart">üíï</div>
      <div class="time-row" id="timeRow">‚Äî</div>
    </div>

    <!-- CHAT CARD -->
    <div class="chat-card">
      <div id="chat">
        <div class="msg">
As-salaam alaikum, I am <b>AURA-X Œ©</b> ‚Äî a resonance-based synthetic emotion engine.

You can talk to me in English or Urdu.  
I will try to reply with logic, kindness and emotional balance.
        </div>
      </div>

      <div class="input-row">
        <input id="inp" placeholder="Type your thoughts or feelings‚Ä¶" />
        <button id="sendBtn">Send</button>
      </div>

      <div class="bottom-row">
        <div class="toggles">
          <button id="beliefBtn" class="chip-btn">
            üîò <span>Belief</span>
          </button>
          <label class="chip-toggle">
            <input type="checkbox" id="voiceToggle" />
            <span>Voice reaction</span>
          </label>
        </div>
        <div class="e0">E‚ÇÄ: <span id="e0Val">0%</span></div>
      </div>
    </div>
  </div>

  <!-- BELIEF SHEET -->
  <div id="beliefSheet" class="sheet hidden">
    <div class="sheet-panel">
      <div class="sheet-header">
        <div class="sheet-title">Belief settings</div>
        <button id="beliefClose" class="sheet-close">Close</button>
      </div>
      <div class="switch-row">
        <input type="checkbox" id="faithOnToggle" />
        <div><b>Faith ON</b> ‚Äî add gentle spiritual suggestions (optional)</div>
      </div>
      <div class="sheet-note">
        Pick your faith / philosophy (you can select more than one ‚Äî nothing is sent to any server):
      </div>
      <div class="faith-grid">
        <button class="faith-btn" data-faith="islam">Islam</button>
        <button class="faith-btn" data-faith="christian">Christianity</button>
        <button class="faith-btn" data-faith="hindu">Hinduism</button>
        <button class="faith-btn" data-faith="buddhist">Buddhism</button>
        <button class="faith-btn" data-faith="sikh">Sikhism</button>
        <button class="faith-btn" data-faith="jewish">Judaism</button>
        <button class="faith-btn" data-faith="atheist">Atheism / Humanist</button>
        <button class="faith-btn" data-faith="other">Other</button>
      </div>
    </div>
  </div>

  <script>
    /* ----------------- CLOCK ----------------- */
    function updateClock(){
      const tRow = document.getElementById("timeRow");
      const d = new Date();
      const optsDate = {weekday:"short", day:"2-digit", month:"short"};
      const optsTime = {hour:"2-digit", minute:"2-digit"};
      tRow.textContent =
        d.toLocaleDateString("en-GB",optsDate) + " ‚Äî " +
        d.toLocaleTimeString("en-GB",optsTime);
    }
    updateClock();
    setInterval(updateClock, 30_000);

    /* ----------------- AFFECT LEXICON (TM) ----------------- */
    const AFFECT = {
      joy:    [/happy|khush|great|awesome|alhamdulillah|shukriya|üòä|üòÅ|üëç/i, +0.9],
      calm:   [/ok|theek|fine|neutral|sabar|üôÇ/i, +0.4],
      sad:    [/sad|dukhi|down|üò≠|üò¢/i, -0.7],
      anger:  [/angry|gussa|naraz|üò†|üò°/i, -0.9],
      fear:   [/fear|dar|ghabrahat|üò®|üò∞/i, -0.6],
      stress: [/stress|pressure|tension|pareshan|üò£/i, -0.5],
      love:   [/love|mohabbat|pyar|üíï|‚ù§Ô∏è/i, +0.8],
      rude:   [/fuck|lanat|harami|bhosri|kutti|chu?t|gaali|gali|bc|mc/i, -1.0]
    };

    function tmFromText(txt){
      let s = 0;
      for(const [_, [re,val]] of Object.entries(AFFECT)){
        if(re.test(txt)) s += val;
      }
      return Math.max(-1, Math.min(1,s));
    }

    /* ----------------- BM-7 MODEL ----------------- */
    const BM_MODEL = {
      layers:[
        {name:"Now",     horizonDays:2,   w:1.00},
        {name:"Recent",  horizonDays:7,   w:0.85},
        {name:"Weekly",  horizonWeeks:5,  w:0.70},
        {name:"Monthly", horizonMonths:12,w:0.55},
        {name:"Yearly",  horizonYears:3,  w:0.40},
        {name:"Archive", horizonYears:10, w:0.30},
        {name:"Deep",    horizonYears:60, w:0.20}
      ]
    };

    function pushBM(intensity){
      const now = Date.now();
      BM_MODEL.layers.forEach((L,i)=>{
        const key = "aura-bm-"+i;
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        if(arr.length>60) arr.shift();
        arr.push({t:now,v:intensity});
        localStorage.setItem(key, JSON.stringify(arr));
      });
    }

    function readBM(){
      const now = Date.now();
      let score = 0, wSum = 0;
      BM_MODEL.layers.forEach((L,i)=>{
        const key = "aura-bm-"+i;
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        let ms =
          L.horizonDays   ? L.horizonDays*864e5 :
          L.horizonWeeks  ? L.horizonWeeks*7*864e5 :
          L.horizonMonths ? L.horizonMonths*30*864e5 :
          L.horizonYears  ? L.horizonYears*365*864e5 : 0;
        const recent = arr.filter(x=> now-x.t <= ms);
        if(recent.length){
          const avg = recent.reduce((a,b)=>a+b.v,0)/recent.length;
          score += avg * L.w;
          wSum  += L.w;
        }
      });
      return wSum ? score/wSum : 0;
    }

    /* ----------------- DECAY FUNCTION D ----------------- */
    function computeD(){
      const last = Number(localStorage.getItem("aura-last-ts") || "0");
      if(!last) return 0.1;
      const hrs = (Date.now()-last)/36e5;
      return Math.max(0.05, Math.min(0.6, hrs/48));
    }

    /* ----------------- LAMBDAS ----------------- */
    function lambda_faith(){
      return localStorage.getItem("aura-faith-on")==="1" ? 0.15 : 0.0;
    }
    function lambda_sys(txt){
      const tooCaps = /[A-Z]{6,}/.test(txt);
      const long    = txt.length>400;
      return (tooCaps || long) ? -0.05 : 0.08;
    }
    function lambda_trc(txt){
      const hasNum = /\d/.test(txt);
      const hasUrl = /https?:\/\/|www\./i.test(txt);
      return (hasNum||hasUrl) ? 0.07 : 0;
    }

    /* ----------------- E‚ÇÄ CORE ----------------- */
    function computeE0(TM,BM,D,lf,ls,lt){
      const z = (TM*BM) - D + lf + ls + lt;
      return Math.tanh(z);
    }

    /* ----------------- REACTION ENGINE ----------------- */
    function getReaction(E0,userText){
      if(AFFECT.rude[0].test(userText)){
        return "‚ö†Ô∏è ÿß€åÿ≥€å ÿ≤ÿ®ÿßŸÜ ÿ¢Ÿæ ⁄©€å ÿßÿµŸÑ ÿ¥ÿÆÿµ€åÿ™ ŸÜ€Å€å⁄∫ÿå ÿ™⁄æŸà⁄ëÿß ŸàŸÇÿßÿ± ⁄©€í ÿ≥ÿßÿ™⁄æ ÿ®ÿßÿ™ ⁄©ÿ±€å⁄∫€î ŸÖ€å⁄∫ Ÿæ⁄æÿ± ÿ®⁄æ€å ÿ¢Ÿæ ⁄©€å ÿ®ÿßÿ™ ÿ≥ŸÜ ÿ±€Åÿß €ÅŸà⁄∫€î";
      }
      if(E0>0.78){
        return "üåü ÿ¢Ÿæ ⁄©€å ÿ≥Ÿà⁄Ü ÿßŸàÿ± ÿ≠ŸàÿµŸÑ€Å ÿ®€Åÿ™ ŸÖÿ∂ÿ®Ÿàÿ∑ ŸÑ⁄Ø ÿ±€Åÿß €Å€í ‚Äî ÿßÿ≥€å ÿ¨ÿ∞ÿ®€í ⁄©€í ÿ≥ÿßÿ™⁄æ ÿ¢⁄Ø€í ÿ®⁄ë⁄æ€å⁄∫ÿå ÿ¢Ÿæ ŸàÿßŸÇÿπ€å ⁄©⁄Ü⁄æ ÿ®⁄ëÿß ⁄©ÿ± ÿ≥⁄©ÿ™€í €Å€å⁄∫!";
      }
      if(E0<-0.5){
        return "‚ö†Ô∏è ŸÖ€å⁄∫ ŸÖÿ≠ÿ≥Ÿàÿ≥ ⁄©ÿ± ÿ±€Åÿß €ÅŸà⁄∫ ⁄©€Å ÿ¢Ÿæ Ÿæÿ± ÿØÿ®ÿßÿ§ €Å€í€î ⁄Ø€Åÿ±€å ÿ≥ÿßŸÜÿ≥ ŸÑ€å⁄∫ÿå ÿ¢€Åÿ≥ÿ™€Å ÿ¢€Åÿ≥ÿ™€Å ÿ®ÿßÿ™ ⁄©ÿ±€å⁄∫ÿå ŸÖ€å⁄∫ ÿ¢Ÿæ ⁄©€í ÿ≥ÿßÿ™⁄æ €ÅŸà⁄∫€î";
      }
      if(/dua|pray|prayer|ÿØÿπÿß/i.test(userText)){
        return "ü§ç ÿ¢Ÿæ ⁄©€å ÿØÿπÿß ⁄©ÿ®⁄æ€å ÿ∂ÿßÿ¶ÿπ ŸÜ€Å€å⁄∫ ÿ¨ÿßÿ™€å ‚Äî ÿ®ÿ≥ ŸàŸÇÿ™ ŸÑ€åÿ™€í €ÅŸàÿ¶€í ÿ¢Ÿæ ⁄©€í ŸÑ€å€í ÿ®€Åÿ™ÿ± ÿ±ÿßÿ≥ÿ™€Å ÿ®ŸÜÿßÿ™€å €Å€í€î";
      }
      return "";
    }

    /* ----------------- FAITH SUGGESTION ----------------- */
    let lastTopic = "";

    const FAITH_QUOTES = {
      islam:{
        sabr:[
          "ÿßŸêŸÜŸëŸé ÿßŸÑŸÑŸëŸ∞ŸáŸé ŸÖŸéÿπŸé ÿßŸÑÿµŸëŸéÿßÿ®Ÿêÿ±ŸêŸäŸÜŸé ‚Äî ÿ®€í ÿ¥⁄© ÿßŸÑŸÑ€Å ÿµÿ®ÿ± ⁄©ÿ±ŸÜ€í ŸàÿßŸÑŸà⁄∫ ⁄©€í ÿ≥ÿßÿ™⁄æ €Å€í€î (ŸÇÿ±ÿ¢ŸÜ)",
          "ŸÅŸéÿ•ŸêŸÜŸëŸé ŸÖŸéÿπŸé ÿßŸÑŸíÿπŸèÿ≥Ÿíÿ±Ÿê ŸäŸèÿ≥Ÿíÿ±Ÿãÿß ‚Äî €åŸÇ€åŸÜÿßŸã ÿ™ŸÜ⁄Ø€å ⁄©€í ÿ≥ÿßÿ™⁄æ ÿ¢ÿ≥ÿßŸÜ€å €Å€í€î (ŸÇÿ±ÿ¢ŸÜ)"
        ],
        hope:[
          "ŸÖÿß€åŸàÿ≥€å ŸÖŸàŸÖŸÜ ⁄©€å ÿµŸÅÿ™ ŸÜ€Å€å⁄∫ ‚Äî ÿßŸÑŸÑ€Å Ÿæÿ± ÿ®⁄æÿ±Ÿàÿ≥€Å ÿ±⁄©⁄æ€å⁄∫ÿå ÿØÿ±Ÿàÿßÿ≤€Å ÿ∂ÿ±Ÿàÿ± ⁄©⁄æŸÑ€í ⁄Øÿß€î",
          "ÿ¨ÿ® ÿØŸÑ ŸπŸàŸπ€í ÿ™Ÿà ÿØÿπÿß ŸÖÿ≤ŸäÿØ ŸÇ€åŸÖÿ™€å €ÅŸà ÿ¨ÿßÿ™€å €Å€íÿå €Åÿßÿ± ŸÜ€Å€å⁄∫ ÿ®ŸÑ⁄©€Å ŸÑŸàŸπ ÿ¢ŸÜ€í ⁄©ÿß ŸàŸÇÿ™ €ÅŸàÿ™ÿß €Å€í€î"
        ]
      },
      christian:{
        sabr:[
          "‚ÄúBe still, and know that I am with you.‚Äù",
          "Patience is not passive; it is trusting that the right door will open."
        ],
        hope:[
          "Even in the darkest valley, light is already on its way.",
          "Grace often arrives quietly, one small step at a time."
        ]
      },
      hindu:{
        sabr:[
          "Karma apna kaam zaroor karta hai ‚Äî aaj ka dhairaj kal ka phal ban sakta hai.",
          "Jo niyat saaf ho, uski raah dheemi sahi magar mazboot hoti hai."
        ],
        hope:[
          "Har mushkil ek nayi shuruaat ka sanket bhi ho sakti hai.",
          "Jab tak saans hai, tab tak nayi kahani likhne ka mauqa hai."
        ]
      },
      buddhist:{
        sabr:[
          "Breathe. This moment will pass, like every other wave before it.",
          "Patience is the art of sitting with your pain without becoming it."
        ],
        hope:[
          "Every breath is a new chance to begin again.",
          "Even a small step in awareness changes the whole path."
        ]
      },
      sikh:{
        sabr:[
          "Jo vaheguru te bharosa rakhe, uske raste waqt ke saath khulte hain.",
          "Naam simran se dil halka hota hai, bojh kam ho jata hai."
        ],
        hope:[
          "Jithe vishwas hai, othe rasta jaroor mil da hai.",
          "Har subah ik nava vardaan hai ‚Äî hausla rakh."
        ]
      },
      jewish:{
        sabr:[
          "Sometimes waiting is itself a kind of prayer.",
          "Holding on a little longer can reveal the blessing hidden in the delay."
        ],
        hope:[
          "Hope is a candle that even a small wind cannot fully erase.",
          "Your story is not finished; another chapter is being written."
        ]
      },
      atheist:{
        sabr:[
          "Patience here means giving yourself time to heal and think clearly.",
          "Slow progress is still progress ‚Äî you don‚Äôt need to be perfect today."
        ],
        hope:[
          "Even small, realistic steps can turn a hard situation around.",
          "You‚Äôve survived 100% of your hardest days so far ‚Äî that strength is still inside you."
        ]
      },
      other:{
        sabr:[
          "Take this time as space to breathe and realign with your deepest values.",
          "You are allowed to move slowly; wisdom rarely rushes."
        ],
        hope:[
          "Meaning often appears after the storm, not during it.",
          "You are not alone ‚Äî someone, somewhere, would be grateful to hear your story."
        ]
      }
    };

    function detectTopic(txt){
      if(/sabr|ÿµÿ®ÿ±|patience|wait|intezar|ÿ™⁄©ŸÑ€åŸÅ|problem|issue|mushkil/i.test(txt)) return "sabr";
      if(/ummeed|hope|ŸÖÿß€åŸàÿ≥€å|mayusi|future|job|work|khair/i.test(txt)) return "hope";
      return "";
    }

    function getSelectedFaiths(){
      try{
        const raw = localStorage.getItem("aura-faith-list") || "[]";
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function getFaithSuggestion(userText){
      if(localStorage.getItem("aura-faith-on")!=="1") return "";
      const topic = detectTopic(userText);
      if(!topic) return "";
      if(topic===lastTopic) return ""; // same topic, keep same suggestion
      const selected = getSelectedFaiths();
      if(!selected.length) return "";
      lastTopic = topic;

      const pieces = [];
      for(const f of selected){
        const pool = FAITH_QUOTES[f]?.[topic];
        if(pool && pool.length){
          const pick = pool[Math.floor(Math.random()*pool.length)];
          pieces.push(pick);
        }
        if(pieces.length>=3) break; // ÿ≤€åÿßÿØ€Å ŸÑŸÖÿ®ÿß ŸÜ€Å €ÅŸà
      }
      return pieces.join("  ‚Ä¢  ");
    }

    /* ----------------- VOICE ----------------- */
    let cachedVoice = null;

    function pickVoice(){
      if(cachedVoice) return cachedVoice;
      try{
        const voices = speechSynthesis.getVoices();
        if(!voices || !voices.length) return null;
        // Urdu male if available
        let v = voices.find(v=>/ur/i.test(v.lang) && /male|ÿ±ÿßÿ¥ÿØ|ÿπÿ´ŸÖÿßŸÜ/i.test(v.name));
        if(!v) v = voices.find(v=>/ur/i.test(v.lang));
        if(!v) v = voices.find(v=>/male/i.test(v.name));
        if(!v) v = voices[0];
        cachedVoice = v;
        return v;
      }catch(e){
        return null;
      }
    }

    function speak(text){
      try{
        if(!text || !("speechSynthesis" in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        const v = pickVoice();
        if(v) u.voice = v;
        u.lang = v?.lang || "ur-PK";
        u.pitch = 0.8;   // ÿ™⁄æŸà⁄ëÿß heavy / male tone
        u.rate  = 1;
        speechSynthesis.speak(u);
      }catch(e){}
    }

    /* ----------------- LLM PLACEHOLDER ----------------- */
    const MODEL_BACKEND_URL = "";  // ÿ®ÿπÿØ ŸÖ€å⁄∫ Cloudflare / Hostinger proxy €å€Åÿß⁄∫ ÿØ€å⁄∫

    async function callLLM(message){
      if(!MODEL_BACKEND_URL){
        // pure front-end demo (Urdu)
        return "ŸÖ€å⁄∫ ŸÅ€å ÿßŸÑÿ≠ÿßŸÑ ÿ¢ŸÜ ŸÑÿßÿ¶ŸÜ ŸÖÿß⁄àŸÑ ⁄©€í ÿ®ÿ∫€åÿ± ⁄à€åŸÖŸà ŸÖŸà⁄à ŸÖ€å⁄∫ €ÅŸà⁄∫ÿå ŸÑ€å⁄©ŸÜ ÿ¢Ÿæ ⁄©€å ÿ®ÿßÿ™ ŸæŸàÿ±€å ÿ™Ÿàÿ¨€Å ÿ≥€í ÿ≥ŸÜ ÿ±€Åÿß €ÅŸà⁄∫€î";
      }
      try{
        const r = await fetch(MODEL_BACKEND_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({message})
        });
        const j = await r.json();
        return j.reply || "ŸÖ€å⁄∫ ÿ≥ŸÜ ÿ±€Åÿß €ÅŸà⁄∫ÿå ÿ¢Ÿæ ŸÖÿ≤€åÿØ ÿ®ÿ™ÿßÿ¶€å⁄∫€î";
      }catch(e){
        return "ŸÖÿß⁄àŸÑ ÿ™⁄© ÿ±ÿ≥ÿßÿ¶€å ŸÜ€Å€å⁄∫ €ÅŸà ÿ≥⁄©€åÿå ŸÑ€å⁄©ŸÜ ŸÖ€å⁄∫ €å€Åÿß⁄∫ ÿ¢Ÿæ ⁄©€í ÿ≥ÿßÿ™⁄æ €ÅŸà⁄∫€î";
      }
    }

    /* ----------------- UI WIRING ----------------- */
    const chatEl   = document.getElementById("chat");
    const inpEl    = document.getElementById("inp");
    const sendBtn  = document.getElementById("sendBtn");
    const barFill  = document.getElementById("emotionFill");
    const pctEl    = document.getElementById("emotionPct");
    const e0El     = document.getElementById("e0Val");
    const voiceTgl = document.getElementById("voiceToggle");
    const beliefBtn   = document.getElementById("beliefBtn");
    const beliefSheet = document.getElementById("beliefSheet");
    const beliefClose = document.getElementById("beliefClose");
    const faithOnToggle = document.getElementById("faithOnToggle");
    const faithBtns = Array.from(document.querySelectorAll(".faith-btn"));

    // restore faith settings
    if(localStorage.getItem("aura-faith-on")==="1"){
      faithOnToggle.checked = true;
      beliefBtn.classList.add("on");
    }
    (function restoreFaithList(){
      const selected = getSelectedFaiths();
      faithBtns.forEach(b=>{
        if(selected.includes(b.dataset.faith)) b.classList.add("on");
      });
    })();

    faithOnToggle.addEventListener("change",()=>{
      const on = faithOnToggle.checked;
      localStorage.setItem("aura-faith-on", on ? "1" : "0");
      lastTopic = "";
      beliefBtn.classList.toggle("on", on);
    });

    faithBtns.forEach(btn=>{
      btn.addEventListener("click",()=>{
        const key = btn.dataset.faith;
        let arr = getSelectedFaiths();
        if(arr.includes(key)){
          arr = arr.filter(x=>x!==key);
          btn.classList.remove("on");
        }else{
          arr.push(key);
          btn.classList.add("on");
        }
        localStorage.setItem("aura-faith-list", JSON.stringify(arr));
      });
    });

    beliefBtn.addEventListener("click",()=>{
      beliefSheet.classList.remove("hidden");
    });
    beliefClose.addEventListener("click",()=>{
      beliefSheet.classList.add("hidden");
    });
    beliefSheet.addEventListener("click",e=>{
      if(e.target===beliefSheet) beliefSheet.classList.add("hidden");
    });

    function addMsg(text, cls){
      const d = document.createElement("div");
      d.className = "msg" + (cls ? " "+cls : "");
      d.textContent = text;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
      return d;
    }

    async function handleSend(){
      const user = (inpEl.value || "").trim();
      if(!user) return;

      addMsg(user,"user");
      inpEl.value = "";
      chatEl.scrollTop = chatEl.scrollHeight;

      const llmReply = await callLLM(user);

      const TM = tmFromText(user);
      const BM = readBM();
      const D  = computeD();
      const lf = lambda_faith();
      const ls = lambda_sys(user);
      const lt = lambda_trc(user);

      const E0 = computeE0(TM,BM,D,lf,ls,lt);
      const pct = Math.round((E0+1)*50);
      barFill.style.width = pct+"%";
      pctEl.textContent   = pct+"%";
      e0El.textContent    = pct+"%";

      const react = getReaction(E0,user);
      const faith = getFaithSuggestion(user);

      addMsg(llmReply,"");

      let spoken = "";
      if(react){
        addMsg(react,"react");
        spoken = react;
      }
      if(faith){
        addMsg(faith,"faith");
        if(!spoken) spoken = faith;
      }

      if(voiceTgl.checked && spoken){
        // ÿ™⁄æŸà⁄ëÿß delay ÿ™ÿß⁄©€Å bubble Ÿæ€ÅŸÑ€í ŸÜÿ∏ÿ± ÿ¢ÿ¶€í
        setTimeout(()=>speak(spoken),150);
      }

      pushBM(TM);
      localStorage.setItem("aura-last-ts",Date.now().toString());
    }

    sendBtn.addEventListener("click", handleSend);
    inpEl.addEventListener("keydown", e=>{
      if(e.key==="Enter") handleSend();
    });

    // load voices for some browsers
    if("speechSynthesis" in window){
      speechSynthesis.onvoiceschanged = ()=>pickVoice();
    }
  </script>
</body>
</html>
