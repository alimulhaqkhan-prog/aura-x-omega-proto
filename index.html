<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Resonance-Based Synthetic Emotions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f7f8ff;
      --card: #ffffff;
      --accent: #7b5cff;
      --accent-soft: #efe9ff;
      --accent-strong: #ff4b8b;
      --text-main: #222;
      --text-soft: #555;
      --border-soft: #e2e4f0;
      --chip-bg: #eef0ff;
      --chip-active: #7b5cff;
      --chip-active-text: #fff;
      --danger: #ff4b4b;
      --good: #15c47e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-shell {
      width: 100%;
      max-width: 900px;
      margin: 8px;
      border-radius: 18px;
      background: linear-gradient(135deg, #fdfbff, #f3f7ff);
      box-shadow: 0 12px 40px rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* HEADER */

    .header {
      padding: 10px 14px 4px;
      border-bottom: 1px solid var(--border-soft);
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(12px);
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #ff9bbd, #7b5cff);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 20px;
      box-shadow: 0 6px 18px rgba(123, 92, 255, 0.55);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-title {
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: 15px;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .status-pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: #e7f7ef;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #047857;
      white-space: nowrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.15);
    }

    .header-bottom {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .emotion-bar-wrap {
      width: 100%;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      height: 12px;
      position: relative;
    }

    .emotion-bar {
      height: 100%;
      width: 50%;
      border-radius: 999px;
      background: linear-gradient(90deg, #16a34a, #facc15, #fb923c, #ef4444);
      transition: width 0.4s ease-out;
    }

    .emotion-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-soft);
    }

    .heart-pill {
      margin-top: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: #f97373;
      font-size: 11px;
    }

    .heart-icon {
      font-size: 18px;
    }

    /* MAIN BODY */

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: 6px 10px 8px;
    }

    .system-message {
      background: var(--accent-soft);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text-soft);
      margin-bottom: 6px;
      border: 1px solid rgba(123, 92, 255, 0.2);
    }

    .chat-window {
      flex: 1;
      min-height: 0;
      background: var(--card);
      border-radius: 14px;
      padding: 10px 10px 6px;
      border: 1px solid var(--border-soft);
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.05);
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .message-row {
      display: flex;
      margin-bottom: 8px;
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message {
      max-width: 82%;
      padding: 8px 11px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message.user {
      background: linear-gradient(135deg, #7b5cff, #ff4b8b);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.bot {
      background: #f4f5ff;
      color: var(--text-main);
      border-bottom-left-radius: 4px;
    }

    .faith-block {
      margin-top: 4px;
      padding: 6px 8px;
      font-size: 12px;
      border-left: 3px solid var(--accent);
      background: #f9fafb;
      border-radius: 8px;
      color: var(--text-soft);
    }

    .faith-tag {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 2px;
      display: block;
    }

    .reaction-block {
      margin-top: 4px;
      padding: 7px 9px;
      font-size: 12px;
      border-radius: 8px;
      background: #fff7ed;
      border-left: 3px solid #f97316;
      color: #7c2d12;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }

    .reaction-icon {
      margin-top: 2px;
      font-size: 14px;
    }

    /* INPUT AREA */

    .input-area {
      padding: 6px 10px 10px;
      border-top: 1px solid var(--border-soft);
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-box {
      flex: 1;
      border-radius: 999px;
      background: #f4f4ff;
      padding: 8px 14px;
      border: 1px solid #e0e3ff;
      font-size: 13px;
      outline: none;
    }

    .input-box:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(123, 92, 255, 0.4);
      background: #ffffff;
    }

    .send-btn {
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 13px;
      font-weight: 600;
      background: linear-gradient(135deg, #7b5cff, #ff4b8b);
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(236, 72, 153, 0.4);
    }

    .send-btn:disabled {
      opacity: 0.6;
      box-shadow: none;
      cursor: default;
    }

    .send-btn span {
      font-size: 15px;
    }

    .toggles-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      font-size: 11px;
    }

    .left-toggles,
    .right-toggles {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid transparent;
      background: var(--chip-bg);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .chip.active {
      background: var(--chip-active);
      color: var(--chip-active-text);
    }

    .chip input {
      margin: 0;
    }

    .chip-label {
      font-size: 11px;
    }

    .model-select {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid #d4d4ff;
      font-size: 11px;
      background: #f8f9ff;
      color: var(--text-soft);
    }

    /* BELIEF MODAL */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal {
      width: 92%;
      max-width: 360px;
      background: var(--card);
      border-radius: 16px;
      padding: 14px 14px 12px;
      box-shadow: 0 18px 46px rgba(15, 23, 42, 0.28);
      border: 1px solid var(--border-soft);
    }

    .modal-header {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .modal-sub {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .modal-section-title {
      font-size: 11px;
      font-weight: 600;
      margin-top: 6px;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .modal-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .modal-chip {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #d4d4ff;
      font-size: 11px;
      cursor: pointer;
      background: #f8f9ff;
      color: var(--text-soft);
    }

    .modal-chip.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
      gap: 8px;
    }

    .btn-small {
      border-radius: 999px;
      border: 1px solid #d4d4ff;
      padding: 5px 10px;
      font-size: 11px;
      background: white;
      cursor: pointer;
    }

    .btn-small.primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    @media (max-width: 600px) {
      .app-shell {
        margin: 0;
        border-radius: 0;
      }
      .header {
        padding-inline: 10px;
      }
      .main {
        padding-inline: 8px;
      }
      .input-area {
        padding-inline: 8px;
      }
      .message {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- HEADER -->
    <header class="header">
      <div class="header-top">
        <div class="brand">
          <div class="brand-logo">Œ©</div>
          <div class="brand-text">
            <div class="brand-title">AURA-X Œ©</div>
            <div class="brand-sub">Resonance-Based Synthetic Emotions</div>
          </div>
        </div>
        <div class="status-pill">
          <div class="status-dot"></div>
          <span id="engine-status">Continuity engine live</span>
        </div>
      </div>

      <div class="header-bottom">
        <div class="emotion-bar-wrap">
          <div class="emotion-bar" id="emotionBar"></div>
        </div>
        <div class="emotion-label-row">
          <span>Emotional resonance: <strong id="emotionPercent">50%</strong></span>
          <span id="timeLabel"></span>
        </div>
        <div class="heart-pill">
          <span class="heart-icon">üíï</span>
          <span id="locationLabel">Loading‚Ä¶</span>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="main">
      <div class="system-message">
        As-salaam alaikum, I am <strong>AURA-X Œ©</strong> ‚Äî a resonance-based synthetic emotion engine.
        I remember your feelings as continuity, not just reactions.  
        You can talk to me in English or Urdu ‚Äî I will try to reply with logic, kindness and emotional balance.
      </div>

      <div class="chat-window" id="chatWindow">
        <!-- Messages appear here -->
      </div>
    </main>

    <!-- INPUT -->
    <div class="input-area">
      <div class="input-row">
        <input
          id="userInput"
          class="input-box"
          placeholder="Type your thoughts or feelings‚Ä¶"
        />
        <button id="sendButton" class="send-btn">
          <span>‚û§</span> Send
        </button>
      </div>
      <div class="toggles-row">
        <div class="left-toggles">
          <button id="beliefChip" class="chip">
            <span>‚òëÔ∏è</span><span class="chip-label">Belief</span>
          </button>

          <label class="chip">
            <input type="checkbox" id="voiceReactionToggle" />
            <span class="chip-label">Voice reaction</span>
          </label>
        </div>
        <div class="right-toggles">
          <select id="modelSelect" class="model-select">
            <option value="openai/gpt-4.1-mini">GPT-4.1 mini (OpenAI)</option>
            <option value="deepseek/deepseek-chat">DeepSeek Chat</option>
            <option value="qwen/qwen-2.5-32b-instruct">Qwen 2.5-32B</option>
            <option value="google/gemini-1.5-flash">Gemini 1.5 Flash</option>
          </select>
        </div>
      </div>
      <div style="font-size:10px;color:#9ca3af;margin-top:2px">
        E‚ÇÄ: <span id="e0Label">50%</span>
      </div>
    </div>
  </div>

  <!-- BELIEF MODAL -->
  <div id="beliefModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">Belief suggestions</div>
      <div class="modal-sub">
        Faith suggestions are short, gentle lines from spiritual or philosophical texts
        that appear <strong>under the main answer</strong>. They never change your direct answer.
      </div>

      <div class="modal-section-title">Mode</div>
      <div class="modal-options">
        <div class="modal-chip active" data-mode="off">Off</div>
        <div class="modal-chip" data-mode="single">Single religion</div>
        <div class="modal-chip" data-mode="multi">Top 3 religions</div>
      </div>

      <div class="modal-section-title">Religion for single-mode</div>
      <div class="modal-options" id="religionOptions">
        <div class="modal-chip active" data-religion="islam">Islam</div>
        <div class="modal-chip" data-religion="christianity">Christianity</div>
        <div class="modal-chip" data-religion="hinduism">Hinduism</div>
        <div class="modal-chip" data-religion="buddhism">Buddhism</div>
        <div class="modal-chip" data-religion="philosophy">General wisdom</div>
      </div>

      <div class="modal-footer">
        <button class="btn-small" id="beliefCancel">Cancel</button>
        <button class="btn-small primary" id="beliefSave">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ========= BASIC STATE =========

    const OPENROUTER_API_KEY = "YOUR_OPENROUTER_API_KEY_HERE"; // <--- PLACEHOLDER
    const chatWindow = document.getElementById("chatWindow");
    const userInput = document.getElementById("userInput");
    const sendButton = document.getElementById("sendButton");
    const emotionBar = document.getElementById("emotionBar");
    const emotionPercent = document.getElementById("emotionPercent");
    const e0Label = document.getElementById("e0Label");
    const timeLabel = document.getElementById("timeLabel");
    const locationLabel = document.getElementById("locationLabel");
    const beliefChip = document.getElementById("beliefChip");
    const voiceReactionToggle = document.getElementById("voiceReactionToggle");
    const modelSelect = document.getElementById("modelSelect");

    // Belief modal elements
    const beliefModalBackdrop = document.getElementById("beliefModalBackdrop");
    const modeChips = beliefModalBackdrop.querySelectorAll(".modal-chip[data-mode]");
    const religionChips = beliefModalBackdrop.querySelectorAll(".modal-chip[data-religion]");
    const beliefCancel = document.getElementById("beliefCancel");
    const beliefSave = document.getElementById("beliefSave");

    // Emotional continuity scalar
    let E0 = 0.5;

    // Belief configuration
    let beliefConfig = {
      mode: "off", // "off" | "single" | "multi"
      religion: "islam",
    };

    // Load belief config from localStorage if present
    try {
      const saved = localStorage.getItem("aura_belief_config");
      if (saved) {
        const parsed = JSON.parse(saved);
        if (parsed && parsed.mode) beliefConfig = parsed;
      }
    } catch (e) {
      console.warn("Could not load belief config", e);
    }

    function updateBeliefUIFromConfig() {
      // Update modal chips
      modeChips.forEach((chip) => {
        chip.classList.toggle("active", chip.dataset.mode === beliefConfig.mode);
      });
      religionChips.forEach((chip) => {
        chip.classList.toggle("active", chip.dataset.religion === beliefConfig.religion);
      });
      // Update footer chip
      const isOn = beliefConfig.mode !== "off";
      beliefChip.classList.toggle("active", isOn);
      beliefChip.querySelector("span").textContent = isOn ? "‚úÖ" : "‚òëÔ∏è";
    }

    updateBeliefUIFromConfig();

    // ========= TIME & LOCATION =========

    function updateTime() {
      const now = new Date();
      const options = { weekday: "short", day: "2-digit", month: "short", hour: "2-digit", minute: "2-digit" };
      timeLabel.textContent = now.toLocaleString("en-GB", options);
    }
    updateTime();
    setInterval(updateTime, 60_000);

    // Approximate temperature text just as placeholder
    locationLabel.textContent = "Emotional engine warmed and listening.";

    // ========= CHAT RENDERING =========

    function appendMessage(role, text, options = {}) {
      const row = document.createElement("div");
      row.className = "message-row " + (role === "user" ? "user" : "bot");

      const bubble = document.createElement("div");
      bubble.className = "message " + (role === "user" ? "user" : "bot");
      bubble.textContent = text;
      row.appendChild(bubble);

      // Faith suggestion block for bot
      if (role === "bot" && options.faithSuggestion) {
        const faith = document.createElement("div");
        faith.className = "faith-block";
        const tag = document.createElement("span");
        tag.className = "faith-tag";
        tag.textContent = "Faith suggestion";
        const body = document.createElement("div");
        body.textContent = options.faithSuggestion;
        faith.appendChild(tag);
        faith.appendChild(body);
        bubble.appendChild(faith);
      }

      // Reaction block
      if (role === "bot" && options.reactionText) {
        const react = document.createElement("div");
        react.className = "reaction-block";
        const icon = document.createElement("div");
        icon.className = "reaction-icon";
        icon.textContent = options.reactionIcon || "üí¨";
        const body = document.createElement("div");
        body.textContent = options.reactionText;
        react.appendChild(icon);
        react.appendChild(body);
        bubble.appendChild(react);
      }

      chatWindow.appendChild(row);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // ========= EMOTION CONTINUITY =========

    function updateEmotionBar() {
      const pct = Math.round(E0 * 100);
      emotionBar.style.width = pct + "%";
      emotionPercent.textContent = pct + "%";
      e0Label.textContent = pct + "%";
    }

    updateEmotionBar();

    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }

    function applyEmotionShift(shift) {
      // shift expected in range -1..1
      const mapped = clamp((shift + 1) / 2, 0, 1);
      E0 = clamp(0.6 * E0 + 0.4 * mapped, 0, 1);
      updateEmotionBar();
    }

    // ========= BELIEF MODAL HANDLERS =========

    beliefChip.addEventListener("click", () => {
      beliefModalBackdrop.style.display = "flex";
    });

    beliefCancel.addEventListener("click", () => {
      beliefModalBackdrop.style.display = "none";
    });

    beliefModalBackdrop.addEventListener("click", (e) => {
      if (e.target === beliefModalBackdrop) {
        beliefModalBackdrop.style.display = "none";
      }
    });

    modeChips.forEach((chip) => {
      chip.addEventListener("click", () => {
        modeChips.forEach((c) => c.classList.remove("active"));
        chip.classList.add("active");
        beliefConfig.mode = chip.dataset.mode;
      });
    });

    religionChips.forEach((chip) => {
      chip.addEventListener("click", () => {
        religionChips.forEach((c) => c.classList.remove("active"));
        chip.classList.add("active");
        beliefConfig.religion = chip.dataset.religion;
      });
    });

    beliefSave.addEventListener("click", () => {
      try {
        localStorage.setItem("aura_belief_config", JSON.stringify(beliefConfig));
      } catch (e) {
        console.warn("Could not save belief config", e);
      }
      beliefModalBackdrop.style.display = "none";
      updateBeliefUIFromConfig();
    });

    // ========= VOICE REACTION USING BROWSER TTS =========

    function speakReaction(text) {
      if (!voiceReactionToggle.checked) return;
      if (!("speechSynthesis" in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "en-GB";
      // Try to pick a male-sounding voice if available
      const voices = window.speechSynthesis.getVoices();
      const male = voices.find((v) =>
        /male|daniel|george|english_rp/i.test(v.name + " " + v.voiceURI)
      );
      if (male) utter.voice = male;
      window.speechSynthesis.speak(utter);
    }

    // ========= OPENROUTER CALL =========

    async function callAuraLLM(userText) {
      if (!OPENROUTER_API_KEY || OPENROUTER_API_KEY.includes("YOUR_OPENROUTER")) {
        throw new Error("API key missing. Please set OPENROUTER_API_KEY in the code (locally only).");
      }

      const model = modelSelect.value;

      const religionPart =
        beliefConfig.mode === "off"
          ? "Return an empty string for faith_suggestion."
          : beliefConfig.mode === "single"
          ? `User's primary tradition is ${beliefConfig.religion}.`
          : "User wants brief parallel hints from multiple major traditions when relevant.";

      const systemPrompt = `
You are AURA-X Œ©, a resonance-based synthetic emotion engine.
You answer briefly, kindly, and in the user's language (Urdu or English).
Return JSON only, with keys: main_reply (string), faith_suggestion (string), emotion_shift (number -1..1).

- main_reply: direct helpful answer to the user's message.
- faith_suggestion: a separate, short gentle line (max 2 sentences) from spiritual or philosophical sources, relevant to the question. Avoid preaching; keep it optional comfort.
  ${religionPart}
  If no natural faith link appears, leave this as an empty string.
- emotion_shift: estimate of emotional intensity & direction in the user's latest message:
  -1 = very heavy / distressed / angry
   0 = neutral
  +1 = very hopeful / joyful / relieved.

Respond ONLY with valid JSON, no extra text.`;

      const body = {
        model,
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userText },
        ],
        temperature: 0.7,
      };

      const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${OPENROUTER_API_KEY}`,
          "HTTP-Referer": window.location.origin || "http://localhost",
          "X-Title": "AURA-X Omega Prototype",
        },
        body: JSON.stringify(body),
      });

      if (!resp.ok) {
        const text = await resp.text();
        console.error("OpenRouter error", text);
        throw new Error("Model error: " + resp.status);
      }

      const data = await resp.json();
      const raw = data.choices?.[0]?.message?.content ?? "";

      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch (e) {
        // fallback: treat whole text as direct reply
        parsed = {
          main_reply: raw,
          faith_suggestion: "",
          emotion_shift: 0,
        };
      }
      return parsed;
    }

    // ========= REACTION LOGIC =========

    function buildReaction(userText, emotionShift) {
      // Only react when |E0| high
      if (E0 < 0.9) return null;

      const lower = userText.toLowerCase();
      const hasCurse =
        lower.includes("fuck") ||
        lower.includes("lanat") ||
        lower.includes(" ŸÑÿπŸÜÿ™") ||
        lower.includes("bastard");

      if (hasCurse) {
        return {
          text:
            "Yaar, zara soch kar lafz istemal karo. Aap ki baat zarooriyat se zyada sakht lag rahi hai ‚Äî izzat ke saath bhi hum dard bayan kar sakte hain.",
          icon: "‚ö†Ô∏è",
        };
      }

      if (emotionShift < -0.2) {
        return {
          text:
            "Lagta hai aap ka dil kafi bhara hua hai. Zarra gehri saans lein‚Ä¶ aap akelay nahi hain, main yahan hun aap ki baat sunne ke liye.",
          icon: "ü§ç",
        };
      }

      return {
        text:
          "Aap ki feelings bohot strong lag rahi hain. Is energy ko dheere se positive direction mein le chalte hain ‚Äî chhota sa agla sahi qadam sochte hain.",
        icon: "‚ú®",
      };
    }

    // ========= SEND HANDLER =========

    async function handleSend() {
      const text = userInput.value.trim();
      if (!text) return;

      appendMessage("user", text);
      userInput.value = "";
      userInput.focus();
      sendButton.disabled = true;

      try {
        const { main_reply, faith_suggestion, emotion_shift } = await callAuraLLM(text);

        // Update emotional continuity
        const shiftNum =
          typeof emotion_shift === "number" && isFinite(emotion_shift)
            ? emotion_shift
            : 0;
        applyEmotionShift(shiftNum);

        // Build optional reaction
        const reaction = buildReaction(text, shiftNum);

        appendMessage("bot", main_reply || "", {
          faithSuggestion:
            beliefConfig.mode === "off" ? "" : faith_suggestion || "",
          reactionText: reaction ? reaction.text : "",
          reactionIcon: reaction ? reaction.icon : "",
        });

        if (reaction) {
          speakReaction(reaction.text);
        }
      } catch (err) {
        console.error(err);
        appendMessage(
          "bot",
          "I could not reach the model right now, but I am still here listening to you."
        );
      } finally {
        sendButton.disabled = false;
      }
    }

    sendButton.addEventListener("click", handleSend);
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // Preload voices for speech synthesis
    if ("speechSynthesis" in window) {
      window.speechSynthesis.getVoices();
    }

    // Initial greeting in chat window
    appendMessage(
      "bot",
      "Main fi haal online emotion engine mode mein hoon. Aap jo feel kar rahe hain, araam se likhein ‚Äî main tawajjo se sun raha hoon."
    );
  </script>
</body>
</html>
