<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äî Resonance-Based Synthetic Emotions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="AURA-X Œ© ‚Äî resonance-based synthetic emotion chat prototype." />

  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --panel-soft: #020617;
      --card: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.18);
      --accent-grad: linear-gradient(90deg, #22c55e, #3b82f6, #eab308);
      --chip-bg: rgba(15, 23, 42, 0.85);
      --chip-border: rgba(148, 163, 184, 0.4);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
      --warning: #eab308;
      --heart-pink: #fb5898;
      --heart-shadow: rgba(248, 113, 155, 0.5);
      --user-bubble: #22c55e;
      --system-bubble: #0f172a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", sans-serif;
      background: radial-gradient(circle at top, #0b1220 0, #020617 52%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 10px 10px 18px;
    }

    header {
      padding: 8px 10px 6px;
      border-radius: 22px;
      background: radial-gradient(circle at top left, #0b1120, #020617 60%);
      box-shadow: 0 18px 44px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .brand-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-icon {
      width: 38px;
      height: 38px;
      border-radius: 13px;
      background: radial-gradient(circle at 25% 0%, #e5e7eb 0, #9ca3af 22%, #020617 72%);
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #020617;
      font-weight: 800;
      font-size: 20px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-text h1 {
      font-size: 16px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .brand-text span {
      font-size: 11px;
      color: var(--text-soft);
    }

    .top-meta {
      text-align: right;
    }

    .top-meta .pill {
      font-size: 10px;
      border-radius: 999px;
      padding: 3px 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dot-live {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
    }

    .top-meta small {
      display: block;
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .bar-row {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .bar-shell {
      flex: 1;
      height: 16px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.5);
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      width: 58%;
      height: 100%;
      background-image: var(--accent-grad);
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.5);
      transition: width 0.4s ease-out;
    }

    .bar-label {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: #e5e7eb;
      text-shadow: 0 1px 4px rgba(15, 23, 42, 0.9);
      pointer-events: none;
    }

    .chips-right {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .chip {
      border-radius: 999px;
      padding: 6px 13px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }

    .chip-toggle-on {
      background: var(--accent-soft);
      border-color: #22c55e;
      color: #bbf7d0;
      box-shadow: 0 0 14px rgba(34, 197, 94, 0.55);
    }

    .heart-wrap {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .heart {
      font-size: 32px;
      filter: drop-shadow(0 0 10px var(--heart-shadow));
      animation: heartPulse 2.4s ease-in-out infinite;
    }

    @keyframes heartPulse {
      0%, 100% { transform: translateY(0) scale(1); opacity: 0.9; }
      40% { transform: translateY(-3px) scale(1.08); opacity: 1; }
      70% { transform: translateY(0) scale(0.96); opacity: 0.8; }
    }

    .time-row {
      margin-top: 4px;
      text-align: center;
      font-size: 11px;
      color: var(--text-soft);
    }

    .reaction-strip {
      margin-top: 6px;
      font-size: 11px;
      text-align: center;
      color: #fef9c3;
      min-height: 14px;
    }

    main {
      flex: 1;
      margin-top: 10px;
      padding: 10px 4px 6px;
      border-radius: 18px;
      background: radial-gradient(circle at top, #020617 0, #000 72%);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scroll-behavior: smooth;
    }

    .bubble-row {
      display: flex;
      width: 100%;
    }

    .bubble-row.user {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 86%;
      padding: 9px 11px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.45;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(15, 23, 42, 0.75);
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .bubble.system {
      background: #020617;
      border-color: rgba(148, 163, 184, 0.45);
    }

    .bubble.assistant {
      background: #020617;
      border-color: rgba(37, 99, 235, 0.5);
    }

    .bubble.user {
      background: var(--user-bubble);
      border-color: rgba(34, 197, 94, 0.85);
      color: #022c22;
      font-weight: 500;
    }

    .bubble.faith {
      background: rgba(250, 250, 180, 0.06);
      border-color: rgba(250, 250, 180, 0.38);
      color: #e5e7eb;
      font-size: 12px;
      position: relative;
      padding-top: 16px;
    }

    .bubble.faith::before {
      content: "Faith suggestion";
      position: absolute;
      top: 4px;
      left: 10px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #facc15;
      opacity: 0.9;
    }

    footer {
      margin-top: 8px;
      padding-top: 6px;
    }

    .composer {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-row {
      display: flex;
      align-items: stretch;
      gap: 6px;
    }

    .input-shell {
      flex: 1;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 6px 14px;
      display: flex;
      align-items: center;
    }

    #userInput {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-main);
      font-size: 13px;
    }

    #userInput::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    #sendBtn {
      width: 54px;
      border-radius: 999px;
      border: none;
      outline: none;
      cursor: pointer;
      background: radial-gradient(circle at 20% 0, #e0f2fe 0, #60a5fa 28%, #fb7185 86%);
      color: #0b1120;
      font-weight: 600;
      font-size: 13px;
      box-shadow: 0 12px 32px rgba(59, 130, 246, 0.7);
    }

    .below-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 2px;
    }

    .toggles {
      display: flex;
      gap: 6px;
    }

    .toggle-chip {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .toggle-chip.on {
      background: rgba(34, 197, 94, 0.18);
      color: #bbf7d0;
      border-color: #22c55e;
      box-shadow: 0 0 14px rgba(34, 197, 94, 0.7);
    }

    .model-pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.92);
      color: var(--text-soft);
    }

    .debug-pill {
      margin-top: 4px;
      font-size: 10px;
      text-align: center;
      color: rgba(148, 163, 184, 0.9);
    }

    /* Belief bottom sheet */

    .sheet {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 40;
    }

    .sheet.visible {
      display: flex;
    }

    .sheet-panel {
      width: 100%;
      max-width: 720px;
      background: #020617;
      border-radius: 18px 18px 0 0;
      padding: 12px 16px 16px;
      border-top: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: 0 -16px 40px rgba(0, 0, 0, 0.9);
    }

    .sheet-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .sheet-header h3 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
    }

    .sheet-header button {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      cursor: pointer;
    }

    .sheet-note {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .faith-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 4px;
    }

    .faith-chip {
      border-radius: 999px;
      padding: 5px 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      font-size: 11px;
      text-align: center;
      cursor: pointer;
      color: var(--text-soft);
    }

    .faith-chip.selected {
      background: rgba(34, 197, 94, 0.18);
      border-color: #22c55e;
      color: #bbf7d0;
      box-shadow: 0 0 9px rgba(34, 197, 94, 0.7);
    }

    .sheet-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      color: var(--text-soft);
    }

    .sheet-row label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .sheet-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      appearance: none;
      background: rgba(15, 23, 42, 0.9);
      position: relative;
    }

    .sheet-row input[type="checkbox"]:checked::after {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: inherit;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .sheet-row select {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 4px 10px;
      font-size: 11px;
    }

    @media (max-width: 480px) {
      .brand-text h1 {
        font-size: 14px;
      }
      .bar-row {
        flex-direction: column;
        align-items: stretch;
      }
      .chips-right {
        justify-content: flex-end;
      }
      .bubble {
        max-width: 92%;
      }
    }
  </style>
</head><body>
  <div class="app">

    <!-- ‚ñë‚ñë HEADER ‚ñë‚ñë -->
    <header>
      <div class="top-row">
        <div class="brand-left">
          <div class="brand-icon">Œ©</div>
          <div class="brand-text">
            <h1>AURA-X Œ©</h1>
            <span>Resonance-Based Synthetic Emotions</span>
          </div>
        </div>

        <div class="top-meta">
          <div class="pill">
            <div class="dot-live"></div>
            Continuity engine live
          </div>
          <small id="topTime">Time: --:--</small>
          <small id="topLang">Language: en-GB</small>
        </div>
      </div>

      <!-- Emotion bar -->
      <div class="bar-row">
        <div class="bar-shell">
          <div id="barFill" class="bar-fill"></div>
          <div id="barLabel" class="bar-label">0%</div>
        </div>
        <div class="chips-right">
          <button id="resetBtn" class="chip">Reset</button>
        </div>
      </div>
    </header>


    <!-- Heart + timestamp -->
    <div class="heart-wrap">
      <div class="heart">üíï</div>
    </div>

    <div class="time-row">
      <span id="dateBox">Thu, 00</span> ‚Ä¢ <span id="weatherBox">--¬∞C</span>
    </div>

    <div id="reactionBox" class="reaction-strip"></div>


    <!-- ‚ñë‚ñë MAIN CHAT ‚ñë‚ñë -->
    <main>
      <div id="chat" class="chat"></div>
    </main>


    <!-- ‚ñë‚ñë COMPOSER ‚ñë‚ñë -->
    <footer>
      <div class="composer">

        <div class="input-row">
          <div class="input-shell">
            <input id="userInput" type="text" placeholder="Type your thoughts or feelings‚Ä¶" />
          </div>
          <button id="sendBtn">Send</button>
        </div>

        <div class="below-row">
          <div class="toggles">

            <!-- Belief Button -->
            <button id="beliefBtn" class="toggle-chip">üîò Belief</button>

            <!-- Voice Reaction (on/off) -->
            <button id="voiceModeBtn" class="toggle-chip">Voice Reaction</button>

          </div>

          <!-- Model selector -->
          <select id="modelSelect" class="model-pill">
            <option value="qwen/qwen-2.5-7b-instruct:free">Qwen Mini</option>
            <option value="google/gemini-flash-1.5:free">Gemini Flash</option>
            <option value="microsoft/phi-3-medium-128k-instruct:free">Phi-3 Medium</option>
          </select>
        </div>

        <div id="debugBar" class="debug-pill">E‚Çí: 0%</div>
      </div>
    </footer>

  </div>


  <!-- ‚ñë‚ñë BELIEF SHEET ‚ñë‚ñë -->
  <div class="sheet" id="beliefSheet">
    <div class="sheet-panel">

      <div class="sheet-header">
        <h3>Belief Settings</h3>
        <button id="closeBelief">Close</button>
      </div>

      <p class="sheet-note">Select one or more beliefs / philosophies:</p>

      <div id="faithGrid" class="faith-grid"></div>

      <div class="sheet-row" style="margin-top:12px;">
        <label>
          <input type="checkbox" id="faithOn" />
          Faith ON (religious-tone answers)
        </label>
<script>
/* ---------------------------------------------------------
      AURA-X Œ© ‚Äî EMOTIONAL CONTINUITY ENGINE (JS CORE)
----------------------------------------------------------*/

/* ---------------------- 1) TM AFFECT ---------------------- */

const AFFECT = {
  joy:    [/happy|great|awesome|alhamdulillah|shukriya|üòä|üòÅ|üëç/i, +0.9],
  calm:   [/ok|fine|neutral|theek|üôÇ/i, +0.4],
  sad:    [/sad|dukhi|üò≠|üò¢/i, -0.7],
  anger:  [/angry|gussa|üò°|üò†/i, -0.9],
  fear:   [/fear|dar|üò®|üò∞/i, -0.6],
  stress: [/stress|pressure|tension|üò£/i, -0.5],
  love:   [/love|mohabbat|üíï|‚ù§Ô∏è/i, +0.8],
  rude:   [/fuck|lanat|harami|bhosri|kutti|choot|gali|gaali/i, -1.0]
};

function tmFromText(t){
  let s = 0;
  for (const [_, [re, v]] of Object.entries(AFFECT)){
    if (re.test(t)) s += v;
  }
  return Math.max(-1, Math.min(1, s));
}

/* ---------------------- 2) BM-7 MEMORY ---------------------- */

const BM_MODEL = {
  layers: [
    {name:'Now',       horizonDays: 2,   w: 1.00},
    {name:'Recent',    horizonDays: 7,   w: 0.85},
    {name:'Weekly',    horizonWeeks: 5,  w: 0.70},
    {name:'Monthly',   horizonMonths:12, w: 0.55},
    {name:'Yearly',    horizonYears: 3,  w: 0.40},
    {name:'Archive',   horizonYears:10,  w: 0.30},
    {name:'Deep',      horizonYears:60,  w: 0.20}
  ]
};

function pushBM(intensity){
  const now = Date.now();

  BM_MODEL.layers.forEach((L, i)=>{
    const key = `aura-bm-${i}`;
    const arr = JSON.parse(localStorage.getItem(key) || '[]');

    if (arr.length > 60) arr.shift();
    arr.push({t:now, v:intensity});

    localStorage.setItem(key, JSON.stringify(arr));
  });
}

function readBM(){
  const now = Date.now();
  let score = 0, weight = 0;

  BM_MODEL.layers.forEach((L, i)=>{
    const key = `aura-bm-${i}`;
    const mem = JSON.parse(localStorage.getItem(key) || '[]');

    let ms =
      L.horizonDays   ? L.horizonDays*864e5 :
      L.horizonWeeks  ? L.horizonWeeks*7*864e5 :
      L.horizonMonths ? L.horizonMonths*30*864e5 :
      L.horizonYears  ? L.horizonYears*365*864e5 : 0;

    const recent = mem.filter(m => now - m.t <= ms);
    if (recent.length){
      const avg = recent.reduce((a,b)=>a+b.v,0)/recent.length;
      score += avg * L.w;
      weight += L.w;
    }
  });

  return weight ? score/weight : 0;
}

/* ---------------------- 3) DECAY FUNCTION D ---------------------- */

function computeD(){
  const last = Number(localStorage.getItem('aura-last-ts') || '0');
  if (!last) return 0.1;

  const hrs = (Date.now() - last) / 36e5;
  return Math.max(0.05, Math.min(0.6, hrs / 48));
}

/* ---------------------- 4) LAMBDAS ---------------------- */

function lambda_faith(){
  return localStorage.getItem('aura-faith-on') === '1' ? 0.15 : 0.0;
}

function lambda_sys(txt){
  const caps = /[A-Z]{6,}/.test(txt);
  const long = txt.length > 400;
  return (caps||long) ? -0.05 : 0.08;
}

function lambda_trc(txt){
  const num = /\d/.test(txt);
  const url = /https?:\/\/|www\./i.test(txt);
  return (num||url) ? 0.07 : 0;
}

/* ---------------------- 5) E‚ÇÄ FORMULA ---------------------- */

function computeE0(TM, BM, D, lf, ls, lt){
  const z = (TM*BM) - D + lf + ls + lt;
  return Math.tanh(z); // [-1,1]
}

/* ---------------------- 6) REACTION ENGINE ---------------------- */

function getReaction(E0, userText){
  
  if (/fuck|lanat|harami|bhosri|chod/i.test(userText)){
    return "‚ö†Ô∏è €å€Å ÿßŸÑŸÅÿßÿ∏ ÿ¢Ÿæ ⁄©€å ÿ¥ÿÆÿµ€åÿ™ ⁄©€å ŸÜŸÖÿßÿ¶ŸÜÿØ⁄Ø€å ŸÜ€Å€å⁄∫ ⁄©ÿ±ÿ™€í€î ÿ™⁄æŸà⁄ëÿß ÿ≥⁄©ŸàŸÜ ÿ≥€í ÿ®ÿßÿ™ ⁄©ÿ±€å⁄∫€î";
  }

  if (E0 > 0.75){
    return "üåü ÿ¢Ÿæ ŸàÿßŸÇÿπ€å ŸÖÿ∂ÿ®Ÿàÿ∑ÿå ŸÖÿ´ÿ®ÿ™ ÿßŸàÿ± ÿ±Ÿàÿ¥ŸÜ ÿ≥Ÿà⁄Ü ŸàÿßŸÑ€í ÿ¥ÿÆÿµ €Å€å⁄∫€î €åŸà⁄∫ €Å€å ÿ¢⁄Ø€í ÿ®⁄ë⁄æÿ™€í ÿ±€Å€å⁄∫!";
  }

  if (E0 < -0.5){
    return "‚ö†Ô∏è ŸÖ€å⁄∫ ŸÖÿ≠ÿ≥Ÿàÿ≥ ⁄©ÿ± ÿ±€Åÿß €ÅŸà⁄∫ ⁄©€Å ÿ¢Ÿæ ÿ∞€ÅŸÜ€å ÿØÿ®ÿßÿ§ ŸÖ€å⁄∫ €Å€å⁄∫ ‚Äî ÿ¢Ÿæ ÿß⁄©€åŸÑ€í ŸÜ€Å€å⁄∫ÿå ŸÖ€å⁄∫ ÿ≥ŸÜ ÿ±€Åÿß €ÅŸà⁄∫€î";
  }

  if (/dua|pray|dawa|help/i.test(userText)){
    return "ü§ç ÿ¢Ÿæ ⁄©€í ŸÑ€å€í ŸÜ€å⁄© ÿÆŸàÿß€Åÿ¥ÿßÿ™€î ÿØÿπÿß €ÅŸÖ€åÿ¥€Å ÿ±ÿßÿ≥ÿ™€Å ⁄©⁄æŸàŸÑÿ™€å €Å€í€î";
  }

  return "";
}

/* ---------------------- 7) FAITH SUGGESTION ---------------------- */

let lastTopic = "";

const FAITH_QUOTES = {
  islam: {
    sabr:[
      "ÿßŸêŸÜŸëŸé ÿßŸÑŸÑŸëŸ∞€ÅŸé ŸÖŸéÿπŸé ÿßŸÑÿµŸëŸ∞ÿ®Ÿêÿ±Ÿê€åŸíŸÜ ‚Äî ÿ®€í ÿ¥⁄© ÿßŸÑŸÑ€Å ÿµÿ®ÿ± ⁄©ÿ±ŸÜ€í ŸàÿßŸÑŸà⁄∫ ⁄©€í ÿ≥ÿßÿ™⁄æ €Å€í€î (ŸÇÿ±ÿ¢ŸÜ)",
      "ŸÖÿ¥⁄©ŸÑ ⁄©€í ÿ®ÿπÿØ ÿ¢ÿ≥ÿßŸÜ€å €Å€í ‚Äî ŸÇÿ±ÿ¢ŸÜ"
    ],
    hope:[
      "ÿßŸÑŸÑ€Å ÿØŸÑŸà⁄∫ ⁄©€í ÿ≠ÿßŸÑ ÿ¨ÿßŸÜÿ™ÿß €Å€í ‚Äî ŸÇÿ±ÿ¢ŸÜ",
      "ŸÖÿß€åŸàÿ≥€å ⁄©ŸÅÿ± €Å€í ‚Äî ÿßÿ≥ŸÑÿßŸÖ"
    ]
  }
};

function getFaithSuggestion(userText, selectedFaith){

  if (localStorage.getItem("aura-faith-on") !== "1") return "";

  const topic =
    /sabr|patience|wait|help/.test(userText) ? "sabr" :
    /hope|loss|problem/.test(userText)       ? "hope" : "";

  if (!topic) return "";

  if (topic === lastTopic){
    return ""; 
  }

  lastTopic = topic;

  const pool = FAITH_QUOTES[selectedFaith]?.[topic];
  if (!pool) return "";

  return pool[Math.floor(Math.random()*pool.length)];
}

/* ---------------------- 8) VOICE OUTPUT ---------------------- */

function speak(text){
  try{
    const v = new SpeechSynthesisUtterance(text);
    v.lang = "ur-PK";
    v.pitch = 0.8;
    v.rate = 1;
    speechSynthesis.speak(v);
  }catch(e){}
}

/* ---------------------- 9) SEND HOOK + LLM ---------------------- */

document.addEventListener("DOMContentLoaded", ()=>{
  const send = document.getElementById("send");
  const inp  = document.getElementById("inp");
  const chat = document.getElementById("chat");
  const bar  = document.getElementById("emotionFill");

  async function callLLM(prompt){
    try{
      const r = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer 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"
        },
        body:JSON.stringify({
          model:"qwen/qwen-2.5-7b-instruct",
          messages:[{role:"user", content:prompt}]
        })
      });

      const j = await r.json();
      return j.choices?.[0]?.message?.content || "‚Ä¶";
    }catch(e){
      return "I'm here with you. Tell me more.";
    }
  }

  send.onclick = async ()=>{
    const user = inp.value.trim();
    if (!user) return;

    const udiv = document.createElement("div");
    udiv.className = "msg user";
    udiv.textContent = user;
    chat.appendChild(udiv);

    inp.value = "";
    chat.scrollTop = chat.scrollHeight;

    const llmReply = await callLLM(user);

    const TM = tmFromText(user);
    const BM = readBM();
    const D  = computeD();
    const lf = lambda_faith();
    const ls = lambda_sys(user);
    const lt = lambda_trc(user);

    const E0 = computeE0(TM,BM,D,lf,ls,lt);

    const pct = Math.round((E0+1)*50);
    bar.style.width = pct+"%";

    const react = getReaction(E0, user);

    const faith = getFaithSuggestion(user, "islam");

    const finalAns =
      llmReply +
      (react ? "\n\n"+react : "") +
      (faith ? "\n\n"+faith : "");

    const adiv = document.createElement("div");
    adiv.className = "msg";
    adiv.textContent = finalAns;
    chat.appendChild(adiv);

    chat.scrollTop = chat.scrollHeight;

    speak(react || faith || "");
    pushBM(TM);
    localStorage.setItem("aura-last-ts", Date.now());
  };
});
</script>
        <label>
          <input type="checkbox" id="localLang" checked />
          Local language auto-adjust
        </label>
      </div>

    </div>
  </div>
