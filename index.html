<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Resonance-Based Synthetic Emotions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7ff;
      --card: #ffffff;
      --card-soft: #f3f5ff;
      --primary: #7b5cff;
      --primary-soft: #ebe6ff;
      --accent: #ff4f8b;
      --accent-soft: #ffe7f1;
      --text-main: #1f2430;
      --text-soft: #60657a;
      --border-soft: #e1e4f2;
      --shadow-soft: 0 10px 25px rgba(44, 62, 80, 0.08);
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top left, #fdf2ff, #f5f7ff 40%, #eef7ff);
      color: var(--text-main);
    }

    /* --- APP LAYOUT (mobile first) --- */

    .app-root {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 8px;
    }

    .app-shell {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), #f5f7ff);
      border-radius: 24px;
      box-shadow: 0 18px 45px rgba(40, 60, 120, 0.12);
      width: 100%;
      max-width: 880px;
      display: flex;
      flex-direction: column;
      padding: 10px 10px 8px;
      overflow: hidden;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 14px 16px 10px;
        border-radius: 28px;
      }
    }

    /* --- HEADER --- */

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #ffffff, #c7d2ff);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
      font-size: 22px;
    }

    .brand-text-main {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .status-pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: #e3f9ee;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #1b7b4d;
      box-shadow: 0 6px 14px rgba(46, 204, 113, 0.25);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #2ecc71;
      box-shadow: 0 0 0 6px rgba(46, 204, 113, 0.2);
    }

    /* --- RESONANCE BAR + HEART --- */

    .resonance-card {
      margin-bottom: 8px;
      padding: 10px 10px 6px;
      border-radius: 20px;
      background: var(--card);
      box-shadow: var(--shadow-soft);
    }

    .resonance-bar-wrapper {
      height: 16px;
      border-radius: 999px;
      background: #edf0ff;
      overflow: hidden;
      position: relative;
      margin-bottom: 6px;
    }

    .resonance-bar {
      height: 100%;
      width: 50%;
      border-radius: inherit;
      background: linear-gradient(90deg, #5ad06d, #facc15, #f97316, #ef4444);
      transition: width 0.35s ease-out;
    }

    .resonance-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-soft);
    }

    .resonance-label-row strong {
      font-size: 12px;
      color: var(--text-main);
    }

    .heart-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
      margin-bottom: 2px;
    }

    .heart-icon {
      font-size: 26px;
      filter: drop-shadow(0 6px 10px rgba(248, 113, 113, 0.45));
    }

    .meta-row {
      font-size: 11px;
      color: var(--text-soft);
    }

    /* --- CHAT --- */

    .chat-wrapper {
      flex: 1;
      min-height: 0;
      margin-bottom: 8px;
      border-radius: 20px;
      background: var(--card-soft);
      padding: 8px 8px 4px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .chat-log {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .bubble {
      max-width: 82%;
      padding: 7px 10px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.4;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .bubble.system {
      align-self: stretch;
      background: #e3e7ff;
      color: #23274a;
      border-radius: 14px;
    }

    .bubble.bot {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid #dde2ff;
      border-radius: 14px 14px 14px 4px;
    }

    .bubble.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #7b5cff, #ff4f8b);
      color: #ffffff;
      border-radius: 14px 14px 4px 14px;
    }

    .faith-bubble {
      margin-top: -2px;
      align-self: flex-start;
      max-width: 75%;
      background: #fff7e6;
      border-radius: 12px;
      padding: 6px 9px;
      font-size: 12px;
      color: #8a5a13;
      border: 1px solid #ffe1a3;
      font-style: italic;
    }

    .reaction-bubble {
      margin-top: -1px;
      align-self: center;
      max-width: 90%;
      background: #eef9ff;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      color: #256083;
      border: 1px dashed #b0e0ff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .reaction-bubble strong {
      font-size: 11px;
    }

    /* --- INPUT + CONTROLS --- */

    .input-area-card {
      border-radius: 18px;
      background: var(--card);
      box-shadow: var(--shadow-soft);
      padding: 6px 8px 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .textarea-row {
      display: flex;
      align-items: flex-end;
      gap: 6px;
    }

    #userInput {
      flex: 1;
      min-height: 32px;
      max-height: 90px;
      resize: none;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 6px 9px;
      font-size: 13px;
      outline: none;
      background: #fdfdff;
    }

    #userInput:focus {
      border-color: #b5bfff;
      box-shadow: 0 0 0 2px rgba(123, 92, 255, 0.18);
    }

    #sendButton {
      border: none;
      border-radius: 16px;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: #ffffff;
      cursor: pointer;
      background: linear-gradient(135deg, #7b5cff, #ff4f8b);
      box-shadow: 0 8px 16px rgba(123, 92, 255, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #sendButton:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: wrap;
      padding-top: 2px;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .pill-toggle {
      border-radius: var(--radius-pill);
      border: 1px solid #c7cffc;
      background: #eef0ff;
      padding: 4px 9px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .pill-toggle.on {
      background: #d8ddff;
      border-color: #8b9bff;
    }

    .pill-toggle span.icon {
      font-size: 13px;
    }

    .checkbox-pill {
      font-size: 11px;
      color: var(--text-soft);
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: #f5f6ff;
      border: 1px solid #dde1ff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .model-select {
      font-size: 11px;
      border-radius: var(--radius-pill);
      border: 1px solid #d0d4ff;
      padding: 4px 7px 4px 9px;
      background: #f4f5ff;
      color: var(--text-soft);
    }

    /* --- BELIEF MODAL --- */

    .belief-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.26);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .belief-modal-backdrop.show {
      display: flex;
    }

    .belief-modal {
      width: 100%;
      max-width: 330px;
      background: #ffffff;
      border-radius: 18px;
      padding: 10px 12px 10px;
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.35);
    }

    .belief-modal h3 {
      margin: 0 0 6px;
      font-size: 14px;
    }

    .belief-modal p {
      margin: 0 0 8px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .belief-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .belief-option {
      padding: 5px 9px;
      border-radius: var(--radius-pill);
      background: #f4f4ff;
      border: 1px solid #d1d5ff;
      font-size: 11px;
      cursor: pointer;
    }

    .belief-option.active {
      background: #7b5cff;
      color: #ffffff;
      border-color: #7b5cff;
    }

    .belief-footer {
      text-align: right;
      margin-top: 4px;
    }

    .belief-footer button {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: none;
      cursor: pointer;
      background: #e5e7ff;
      color: #333;
    }

    .belief-footer button.primary {
      background: #7b5cff;
      color: #fff;
      margin-left: 6px;
    }

    /* --- SCROLLBARS (mobile friendly subtle) --- */

    .chat-wrapper::-webkit-scrollbar {
      width: 4px;
    }
    .chat-wrapper::-webkit-scrollbar-track {
      background: transparent;
    }
    .chat-wrapper::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 255, 0.7);
      border-radius: 999px;
    }
  </style>
</head>
<body>
  <div class="app-root">
    <div class="app-shell">
      <!-- HEADER -->
      <div class="header-row">
        <div class="brand-block">
          <div class="brand-icon">Œ©</div>
          <div>
            <div class="brand-text-main">AURA-X Œ©</div>
            <div class="brand-text-sub">
              Resonance-Based Synthetic Emotions
            </div>
          </div>
        </div>
        <div class="status-pill">
          <div class="status-dot"></div>
          <span>Continuity engine live</span>
        </div>
      </div>

      <!-- RESONANCE -->
      <div class="resonance-card">
        <div class="resonance-bar-wrapper">
          <div id="resonanceBar" class="resonance-bar"></div>
        </div>
        <div class="resonance-label-row">
          <span>Emotional resonance: <strong id="resonanceLabel">50%</strong></span>
          <span id="resonanceHint">Balanced</span>
        </div>
        <div class="heart-row">
          <div class="heart-icon">üíû</div>
          <div class="meta-row" id="metaLine">Thu, 00 ‚Äî --¬∞C</div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="chat-wrapper" id="chatWrapper">
        <div class="chat-log" id="chatLog"></div>
      </div>

      <!-- INPUT + CONTROLS -->
      <div class="input-area-card">
        <div class="textarea-row">
          <textarea id="userInput" placeholder="Type your thoughts or feelings‚Ä¶"></textarea>
          <button id="sendButton">
            <span>Send</span>
          </button>
        </div>
        <div class="controls-row">
          <div class="toggle-group">
            <button id="beliefToggle" class="pill-toggle on">
              <span class="icon">üïäÔ∏è</span>
              <span id="beliefLabel">Belief: Auto (Islam)</span>
            </button>

            <label class="checkbox-pill">
              <input type="checkbox" id="voiceToggle" checked />
              <span>Voice reaction</span>
            </label>
          </div>

          <div>
            <select id="modelSelect" class="model-select">
              <option value="openai/gpt-4.1-mini">GPT-4.1 Mini</option>
              <option value="google/gemini-2.0-flash-exp">Gemini Flash</option>
              <option value="qwen/qwen-2.5-7b-instruct" selected>Qwen Mini</option>
              <option value="meta-llama/llama-3.2-3b-instruct">Llama 3.2</option>
            </select>
          </div>
        </div>
      </div>

      <div style="text-align:center;margin-top:4px;font-size:10px;color:#9ca3af;">
        E‚ÇÄ: <span id="resonanceValue">0%</span>
      </div>
    </div>
  </div>

  <!-- BELIEF MODAL -->
  <div id="beliefModalBackdrop" class="belief-modal-backdrop">
    <div class="belief-modal">
      <h3>Belief suggestions</h3>
      <p>
        Optional short extra line based on spiritual / ethical literature.
        You can change the source or turn it off.
      </p>
      <div class="belief-options">
        <button class="belief-option" data-mode="off">Off</button>
        <button class="belief-option active" data-mode="auto-islam">
          Auto ‚Äì Islam (Urdu + Arabic)
        </button>
        <button class="belief-option" data-mode="auto-all">
          Auto ‚Äì All faiths
        </button>
        <button class="belief-option" data-mode="christianity">
          Christianity
        </button>
        <button class="belief-option" data-mode="buddhism">
          Buddhism
        </button>
        <button class="belief-option" data-mode="stoic">
          Stoic / Philosophy
        </button>
      </div>
      <div class="belief-footer">
        <button id="beliefCancel">Cancel</button>
        <button id="beliefSave" class="primary">Apply</button>
      </div>
    </div>
  </div>

  <!-- OPTIONAL LOCAL CONFIG (ONLY ON YOUR OWN DEVICE, NOT GITHUB) -->
  <!-- In your laptop/mobile, make config.js with:
       window.OPENROUTER_API_KEY = "sk-or-...";
       and DO NOT upload it to GitHub. -->
  <script src="config.js"></script>

  <script>
    // ===== GLOBAL STATE =====

    const chatLogEl = document.getElementById("chatLog");
    const chatWrapperEl = document.getElementById("chatWrapper");
    const userInputEl = document.getElementById("userInput");
    const sendButtonEl = document.getElementById("sendButton");
    const resonanceBarEl = document.getElementById("resonanceBar");
    const resonanceLabelEl = document.getElementById("resonanceLabel");
    const resonanceHintEl = document.getElementById("resonanceHint");
    const resonanceValueEl = document.getElementById("resonanceValue");
    const metaLineEl = document.getElementById("metaLine");
    const beliefToggleEl = document.getElementById("beliefToggle");
    const beliefLabelEl = document.getElementById("beliefLabel");
    const voiceToggleEl = document.getElementById("voiceToggle");
    const modelSelectEl = document.getElementById("modelSelect");
    const beliefModalBackdrop = document.getElementById("beliefModalBackdrop");
    const beliefOptionButtons =
      beliefModalBackdrop.querySelectorAll(".belief-option");
    const beliefCancelBtn = document.getElementById("beliefCancel");
    const beliefSaveBtn = document.getElementById("beliefSave");

    // Emotional continuity (0‚Äì1)
    let resonance = 0.5;

    // Belief config
    const beliefConfig = {
      mode: "auto-islam", // "off", "auto-islam", "auto-all", "christianity", "buddhism", "stoic"
    };

    // Current LLM model (OpenRouter id)
    let currentModel = modelSelectEl.value;

    // Local only ‚Äì OpenRouter key injected from config.js (never in GitHub)
    const OPENROUTER_API_KEY = window.OPENROUTER_API_KEY || "";

    // ===== UTILS =====

    function formatNowMeta() {
      const now = new Date();
      const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      const day = dayNames[now.getDay()];
      const hour = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");
      return `${day}, ${hour}:${min} ‚Äî --¬∞C`;
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        chatWrapperEl.scrollTop = chatWrapperEl.scrollHeight;
      });
    }

    function appendBubble(role, text) {
      const div = document.createElement("div");
      div.className = `bubble ${role}`;
      div.textContent = text;
      chatLogEl.appendChild(div);
      scrollToBottom();
      return div;
    }

    function appendFaithBubble(text) {
      if (!text) return;
      const div = document.createElement("div");
      div.className = "faith-bubble";
      div.textContent = text;
      chatLogEl.appendChild(div);
      scrollToBottom();
    }

    function appendReactionBubble(reaction) {
      if (!reaction || !reaction.text) return;
      const div = document.createElement("div");
      div.className = "reaction-bubble";
      div.innerHTML = `<strong>${reaction.icon || "‚ú®"}</strong><span>${
        reaction.text
      }</span>`;
      chatLogEl.appendChild(div);
      scrollToBottom();
    }

    function updateResonanceUi() {
      const pct = Math.round(resonance * 100);
      resonanceBarEl.style.width = `${pct}%`;
      resonanceLabelEl.textContent = `${pct}%`;
      resonanceValueEl.textContent = `${pct}%`;

      let hint = "Balanced";
      if (pct < 25) hint = "Low energy";
      else if (pct < 50) hint = "Gentle";
      else if (pct < 75) hint = "Warm";
      else hint = "Very intense";

      resonanceHintEl.textContent = hint;
    }

    function clamp01(x) {
      return Math.max(0, Math.min(1, x));
    }

    // Simple Urdu/English bad-words & dua detection
    const negativeWords = [
      "gali",
      "lanat",
      "badtameez",
      "chup",
      "hate",
      "stupid",
      "idiot",
    ];
    const duaWords = ["ÿ¨ÿ≤ÿß⁄© ÿßŸÑŸÑ€Å", "ÿ¨ÿ≤ÿßŸÉ ÿßŸÑŸÑŸá", "thank you", "shukriya"];

    function containsAny(text, list) {
      const lower = text.toLowerCase();
      return list.some((w) => lower.includes(w.toLowerCase()));
    }

    // Rough emotional shift from text length + punctuation
    function estimateEmotionShift(text) {
      const len = text.length;
      let shift = 0;
      if (/[!?]/.test(text)) shift += 0.05;
      if (len > 120) shift += 0.05;
      if (containsAny(text, negativeWords)) shift -= 0.12;
      if (containsAny(text, duaWords)) shift += 0.08;
      return Math.max(-0.18, Math.min(0.18, shift));
    }

    function buildReaction(userText, shift) {
      const pct = Math.round(resonance * 100);

      // Abusive / harsh
      if (containsAny(userText, negativeWords)) {
        return {
          icon: "‚ö†Ô∏è",
          text: "Thori si narmi achhi lagti hai. Aao baat ko izzat ke sath rakhein, taake dono ki izzat baqi rahe.",
          tone: "gentle-warning",
        };
      }

      // Dua / shukr
      if (containsAny(userText, duaWords)) {
        return {
          icon: "ü§≤",
          text: "Aap ka shukriya aur dua mehsoos hui. Allah aap ko bhi khushi, sehat aur sakoon de.",
          tone: "gratitude",
        };
      }

      // Very intense feelings (E > 90%)
      if (pct >= 90) {
        return {
          icon: "üíì",
          text: "Aap ki feelings bohot strong lag rahi hain. Aap akelay nahi hain, ahista ahista saans lein aur jo dil mein hai woh sharik karein.",
          tone: "high-intensity",
        };
      }

      // Very low energy
      if (pct <= 10) {
        return {
          icon: "üåô",
          text: "Lagta hai energy bohot kam hai. Agar thakawat ya udaasi hai to thora aaram, pani aur halka sa walk bhi madad kar sakti hai.",
          tone: "low-energy",
        };
      }

      // Medium but big shift
      if (Math.abs(shift) > 0.12) {
        if (shift > 0) {
          return {
            icon: "üåà",
            text: "Aap ki baat se lagta hai thori roshni aa rahi hai. Isi tarah dheere dheere behtari ki taraf qadam barhate rahen.",
            tone: "uplift",
          };
        } else {
          return {
            icon: "ü§ç",
            text: "Jo aap mehsoos kar rahe hain woh aham hai. Aap ka dukh ya gussa bhi qeemti signal hai ‚Äì usay mehsoos karna ghalat nahi.",
            tone: "soft-support",
          };
        }
      }

      return null;
    }

    function speakReaction(reaction) {
      if (!("speechSynthesis" in window)) return;
      if (!reaction || !reaction.text) return;
      if (!voiceToggleEl.checked) return;

      const utter = new SpeechSynthesisUtterance(reaction.text);
      // Try to pick a male-ish Urdu/English voice
      const voices = window.speechSynthesis.getVoices();
      const preferred = voices.find((v) =>
        /ur|urdu/i.test(v.lang)
      ) || voices.find((v) => /en-GB|en-US/i.test(v.lang));
      if (preferred) utter.voice = preferred;
      utter.rate = 1.0;
      utter.pitch = 0.9;
      window.speechSynthesis.speak(utter);
    }

    // ===== BELIEF MODAL HANDLING =====

    let pendingBeliefMode = beliefConfig.mode;

    function refreshBeliefUi() {
      let label = "Off";
      if (beliefConfig.mode === "auto-islam") label = "Auto (Islam)";
      else if (beliefConfig.mode === "auto-all") label = "Auto (All)";
      else if (beliefConfig.mode === "christianity") label = "Christianity";
      else if (beliefConfig.mode === "buddhism") label = "Buddhism";
      else if (beliefConfig.mode === "stoic") label = "Stoic";

      beliefLabelEl.textContent =
        beliefConfig.mode === "off" ? "Belief: Off" : `Belief: ${label}`;
      beliefToggleEl.classList.toggle(
        "on",
        beliefConfig.mode !== "off"
      );
    }

    function openBeliefModal() {
      pendingBeliefMode = beliefConfig.mode;
      beliefOptionButtons.forEach((btn) => {
        const mode = btn.dataset.mode;
        btn.classList.toggle("active", mode === pendingBeliefMode);
      });
      beliefModalBackdrop.classList.add("show");
    }

    function closeBeliefModal() {
      beliefModalBackdrop.classList.remove("show");
    }

    beliefToggleEl.addEventListener("click", openBeliefModal);

    beliefOptionButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        pendingBeliefMode = btn.dataset.mode;
        beliefOptionButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });

    beliefCancelBtn.addEventListener("click", closeBeliefModal);
    beliefSaveBtn.addEventListener("click", () => {
      beliefConfig.mode = pendingBeliefMode;
      refreshBeliefUi();
      closeBeliefModal();
    });

    beliefModalBackdrop.addEventListener("click", (e) => {
      if (e.target === beliefModalBackdrop) closeBeliefModal();
    });

    // ===== LLM CALL =====

    const SYSTEM_PROMPT = `
You are AURA-X Œ©, a resonance-based synthetic emotion engine.
You reply in the same language the user uses (Urdu or English), short and clear.

Return JSON only, with this exact shape:
{
  "main_reply": "string ‚Äì main answer to the user",
  "faith_suggestion": "string or empty",
  "emotion_shift": number between -0.18 and 0.18
}

Rules for belief / faith_suggestion:

- If belief mode = "off": faith_suggestion MUST be empty.
- If belief mode = "auto-islam":
  * User is likely from Pakistan and Muslim.
  * Give 1 short line in Urdu with optional Quran / Hadith Arabic phrase.
  * Example style: "ÿßŸÜ ÿ¥ÿßÿ° ÿßŸÑŸÑ€Å ÿ®€Åÿ™ÿ± €ÅŸà⁄Øÿß ‚Äî 'ÿ•ŸêŸÜŸëŸé ÿßŸÑŸÑŸëŸ∞ŸáŸé ŸÖŸéÿπŸé ÿßŸÑÿµŸëŸéÿßÿ®Ÿêÿ±ŸêŸäŸÜŸé' (ÿ®€åÿ¥⁄© ÿßŸÑŸÑ€Å ÿµÿ®ÿ± ⁄©ÿ±ŸÜ€í ŸàÿßŸÑŸà⁄∫ ⁄©€í ÿ≥ÿßÿ™⁄æ €Å€í)."
- If belief mode = "auto-all":
  * Use whichever tradition gently matches the topic (Islam, Christianity, Buddhism, Stoic etc).
  * Keep it one line, soft and non-judgmental.
- If belief mode is a specific religion: use a suitable quote / reference from that tradition only.

Faith suggestion must be OPTIONAL and respectful, never forcing belief.
If the user directly asks about religion, answer normally in main_reply, not faith_suggestion.
    `.trim();

    async function callModel(userText) {
      if (!OPENROUTER_API_KEY) {
        // Demo offline mode
        return {
          main_reply:
            "Filhaal demo mode mein hoon is liye asal model se connect nahi ho pa raha, lekin main aap ki baat samajh raha hoon.",
          faith_suggestion:
            beliefConfig.mode === "auto-islam"
              ? "ÿßŸÜ ÿ¥ÿßÿ° ÿßŸÑŸÑ€Å ÿ®€Åÿ™ÿ± €ÅŸà⁄Øÿß ‚Äî 'ÿ•ŸêŸÜŸëŸé ÿßŸÑŸÑŸëŸ∞ŸáŸé ŸÖŸéÿπŸé ÿßŸÑÿµŸëŸéÿßÿ®Ÿêÿ±ŸêŸäŸÜŸé' (ÿ®€åÿ¥⁄© ÿßŸÑŸÑ€Å ÿµÿ®ÿ± ⁄©ÿ±ŸÜ€í ŸàÿßŸÑŸà⁄∫ ⁄©€í ÿ≥ÿßÿ™⁄æ €Å€í)."
              : "",
          emotion_shift: estimateEmotionShift(userText),
        };
      }

      const body = {
        model: currentModel,
        temperature: 0.6,
        max_tokens: 400,
        response_format: { type: "json_object" },
        messages: [
          { role: "system", content: SYSTEM_PROMPT },
          {
            role: "user",
            content: JSON.stringify({
              user_text: userText,
              belief_mode: beliefConfig.mode,
              current_resonance: resonance,
            }),
          },
        ],
      };

      const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${OPENROUTER_API_KEY}`,
        },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        throw new Error("API error " + res.status);
      }

      const data = await res.json();
      const raw = data.choices?.[0]?.message?.content || "{}";
      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch {
        parsed = {
          main_reply: raw,
          faith_suggestion: "",
          emotion_shift: estimateEmotionShift(userText),
        };
      }
      if (typeof parsed.emotion_shift !== "number") {
        parsed.emotion_shift = estimateEmotionShift(userText);
      }
      return parsed;
    }

    // ===== SEND HANDLER =====

    async function handleSend() {
      const text = userInputEl.value.trim();
      if (!text) return;

      appendBubble("user", text);
      userInputEl.value = "";
      userInputEl.focus();
      sendButtonEl.disabled = true;

      try {
        const reply = await callModel(text);

        // Update emotional resonance
        const shiftNum =
          typeof reply.emotion_shift === "number"
            ? reply.emotion_shift
            : estimateEmotionShift(text);
        resonance = clamp01(resonance + shiftNum);
        updateResonanceUi();

        // Build local reaction (independent of model)
        const reaction = buildReaction(text, shiftNum);

        // Append main reply
        appendBubble("bot", reply.main_reply || "");

        // Faith suggestion line
        if (beliefConfig.mode !== "off") {
          appendFaithBubble(reply.faith_suggestion || "");
        }

        // Reaction bubble + voice
        if (reaction) {
          appendReactionBubble(reaction);
          speakReaction(reaction);
        }
      } catch (err) {
        console.error(err);
        appendBubble(
          "bot",
          "Mujhe model tak pahunchne mein masla aa gaya. Thori dair baad dobara koshish karein."
        );
      } finally {
        sendButtonEl.disabled = false;
      }
    }

    sendButtonEl.addEventListener("click", handleSend);

    userInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    modelSelectEl.addEventListener("change", () => {
      currentModel = modelSelectEl.value;
    });

    // ===== INITIALISE =====

    function init() {
      metaLineEl.textContent = formatNowMeta();
      updateResonanceUi();
      refreshBeliefUi();

      appendBubble(
        "system",
        "As-salaam alaikum, I am AURA-X Œ© ‚Äî a resonance-based synthetic emotion engine.\n\nYou can talk to me in English or Urdu. I will try to reply with logic, kindness and emotional balance."
      );
    }

    init();
  </script>
</body>
</html>
