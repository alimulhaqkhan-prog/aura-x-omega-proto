<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Resonance-Based Synthetic Emotions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7ff;
      --card: #ffffff;
      --card-soft: #f3f5ff;
      --primary: #7b5cff;
      --primary-soft: #ebe6ff;
      --accent: #ff4f8b;
      --accent-soft: #ffe7f1;
      --text-main: #1f2430;
      --text-soft: #60657a;
      --border-soft: #e1e4f2;
      --shadow-soft: 0 10px 25px rgba(44, 62, 80, 0.08);
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top left, #fdf2ff, #f5f7ff 40%, #eef7ff);
      color: var(--text-main);
    }

    /* --- APP LAYOUT (mobile first) --- */

    .app-root {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 6px;
    }

    .app-shell {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), #f5f7ff);
      border-radius: 22px;
      box-shadow: 0 18px 45px rgba(40, 60, 120, 0.12);
      width: 100%;
      max-width: 880px;
      display: flex;
      flex-direction: column;
      padding: 8px 8px 6px;
      overflow: hidden;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 12px 14px 8px;
        border-radius: 26px;
      }
    }

    /* --- HEADER --- */

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-icon {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, #ffffff, #c7d2ff);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      font-size: 20px;
    }

    .brand-text-main {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .brand-text-sub {
      font-size: 10px;
      color: var(--text-soft);
    }

    .status-pill {
      padding: 5px 10px;
      border-radius: 999px;
      background: #e3f9ee;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: #1b7b4d;
      box-shadow: 0 6px 14px rgba(46, 204, 113, 0.25);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #2ecc71;
      box-shadow: 0 0 0 5px rgba(46, 204, 113, 0.2);
    }

    /* --- RESONANCE BAR + HEART --- */

    .resonance-card {
      margin-bottom: 6px;
      padding: 8px 8px 4px;
      border-radius: 18px;
      background: var(--card);
      box-shadow: var(--shadow-soft);
    }

    .resonance-bar-wrapper {
      height: 14px;
      border-radius: 999px;
      background: #edf0ff;
      overflow: hidden;
      position: relative;
      margin-bottom: 4px;
    }

    .resonance-bar {
      height: 100%;
      width: 50%;
      border-radius: inherit;
      background: linear-gradient(90deg, #5ad06d, #facc15, #f97316, #ef4444);
      transition: width 0.35s ease-out;
    }

    .resonance-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 10px;
      color: var(--text-soft);
    }

    .resonance-label-row strong {
      font-size: 11px;
      color: var(--text-main);
    }

    .heart-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      margin-top: 2px;
      margin-bottom: 0;
    }

    .heart-icon {
      font-size: 24px;
      filter: drop-shadow(0 5px 9px rgba(248, 113, 113, 0.45));
      animation: heartBeat 1.4s ease-in-out infinite;
      transform-origin: center;
    }

    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      20% { transform: scale(1.2); }
      35% { transform: scale(0.9); }
      55% { transform: scale(1.15); }
      75% { transform: scale(0.98); }
    }

    .meta-row {
      font-size: 10px;
      color: var(--text-soft);
    }

    /* --- CHAT --- */

    .chat-wrapper {
      flex: 1;
      min-height: 0;
      margin-bottom: 6px;
      border-radius: 18px;
      background: var(--card-soft);
      padding: 6px 6px 4px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .chat-log {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .bubble {
      max-width: 82%;
      padding: 7px 9px;
      border-radius: 13px;
      font-size: 12px;
      line-height: 1.35;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .bubble.system {
      align-self: stretch;
      background: #e3e7ff;
      color: #23274a;
      border-radius: 13px;
    }

    .bubble.bot {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid #dde2ff;
      border-radius: 13px 13px 13px 4px;
    }

    .bubble.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #7b5cff, #ff4f8b);
      color: #ffffff;
      border-radius: 13px 13px 4px 13px;
    }

    .faith-bubble {
      margin-top: -1px;
      align-self: flex-start;
      max-width: 75%;
      background: #fff7e6;
      border-radius: 11px;
      padding: 5px 8px;
      font-size: 11px;
      color: #8a5a13;
      border: 1px solid #ffe1a3;
      font-style: italic;
    }

    .reaction-bubble {
      margin-top: -1px;
      align-self: center;
      max-width: 90%;
      background: #eef9ff;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 10px;
      color: #256083;
      border: 1px dashed #b0e0ff;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .reaction-bubble strong {
      font-size: 10px;
    }

    /* --- INPUT + CONTROLS --- */

    .input-area-card {
      border-radius: 16px;
      background: var(--card);
      box-shadow: var(--shadow-soft);
      padding: 5px 7px 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .textarea-row {
      display: flex;
      align-items: flex-end;
      gap: 5px;
    }

    #userInput {
      flex: 1;
      min-height: 30px;
      max-height: 88px;
      resize: none;
      border-radius: 13px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      font-size: 12px;
      outline: none;
      background: #fdfdff;
    }

    #userInput:focus {
      border-color: #b5bfff;
      box-shadow: 0 0 0 2px rgba(123, 92, 255, 0.18);
    }

    #sendButton {
      border: none;
      border-radius: 15px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: #ffffff;
      cursor: pointer;
      background: linear-gradient(135deg, #7b5cff, #ff4f8b);
      box-shadow: 0 7px 14px rgba(123, 92, 255, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    #sendButton:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: nowrap;
      padding-top: 2px;
    }

    .toggle-group {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-wrap: nowrap;
    }

    .pill-toggle {
      border-radius: var(--radius-pill);
      border: 1px solid #c7cffc;
      background: #eef0ff;
      padding: 4px 7px;
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      white-space: nowrap;
    }

    .pill-toggle.on {
      background: #d8ddff;
      border-color: #8b9bff;
    }

    .pill-toggle span.icon {
      font-size: 12px;
    }

    .checkbox-pill {
      font-size: 10px;
      color: var(--text-soft);
      padding: 3px 7px;
      border-radius: var(--radius-pill);
      background: #f5f6ff;
      border: 1px solid #dde1ff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .checkbox-pill input {
      width: 11px;
      height: 11px;
    }

    .model-select {
      font-size: 10px;
      border-radius: var(--radius-pill);
      border: 1px solid #d0d4ff;
      padding: 4px 8px 4px 8px;
      background: #f4f5ff;
      color: var(--text-soft);
      max-width: 130px;
    }

    /* --- BELIEF MODAL --- */

    .belief-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.26);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .belief-modal-backdrop.show {
      display: flex;
    }

    .belief-modal {
      width: 100%;
      max-width: 330px;
      background: #ffffff;
      border-radius: 18px;
      padding: 10px 12px 10px;
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.35);
    }

    .belief-modal h3 {
      margin: 0 0 6px;
      font-size: 14px;
    }

    .belief-modal p {
      margin: 0 0 8px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .belief-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .belief-option {
      padding: 5px 9px;
      border-radius: var(--radius-pill);
      background: #f4f4ff;
      border: 1px solid #d1d5ff;
      font-size: 11px;
      cursor: pointer;
    }

    .belief-option.active {
      background: #7b5cff;
      color: #ffffff;
      border-color: #7b5cff;
    }

    .belief-footer {
      text-align: right;
      margin-top: 4px;
    }

    .belief-footer button {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: none;
      cursor: pointer;
      background: #e5e7ff;
      color: #333;
    }

    .belief-footer button.primary {
      background: #7b5cff;
      color: #fff;
      margin-left: 6px;
    }

    /* --- SCROLLBARS --- */

    .chat-wrapper::-webkit-scrollbar {
      width: 3px;
    }
    .chat-wrapper::-webkit-scrollbar-track {
      background: transparent;
    }
    .chat-wrapper::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 255, 0.7);
      border-radius: 999px;
    }
  </style>
</head>
<body>
  <div class="app-root">
    <div class="app-shell">
      <!-- HEADER -->
      <div class="header-row">
        <div class="brand-block">
          <div class="brand-icon">Œ©</div>
          <div>
            <div class="brand-text-main">AURA-X Œ©</div>
            <div class="brand-text-sub">
              Resonance-Based Synthetic Emotions
            </div>
          </div>
        </div>
        <div class="status-pill">
          <div class="status-dot"></div>
          <span>Continuity engine live</span>
        </div>
      </div>

      <!-- RESONANCE -->
      <div class="resonance-card">
        <div class="resonance-bar-wrapper">
          <div id="resonanceBar" class="resonance-bar"></div>
        </div>
        <div class="resonance-label-row">
          <span>Emotional resonance: <strong id="resonanceLabel">50%</strong></span>
          <span id="resonanceHint">Balanced</span>
        </div>
        <div class="heart-row">
          <div class="heart-icon">üíû</div>
          <div class="meta-row" id="metaLine">Thu, 12:02 ‚Äî --¬∞C</div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="chat-wrapper" id="chatWrapper">
        <div class="chat-log" id="chatLog"></div>
      </div>

      <!-- INPUT + CONTROLS -->
      <div class="input-area-card">
        <div class="textarea-row">
          <textarea id="userInput" placeholder="Type your thoughts or feelings‚Ä¶"></textarea>
          <button id="sendButton">
            <span>Send</span>
          </button>
        </div>
        <div class="controls-row">
          <div class="toggle-group">
            <button id="beliefToggle" class="pill-toggle on">
              <span class="icon">üïäÔ∏è</span>
              <span id="beliefLabel">Belief: Auto (Islam)</span>
            </button>

            <label class="checkbox-pill">
              <input type="checkbox" id="voiceToggle" checked />
              <span>Voice reaction</span>
            </label>
          </div>

          <div>
            <select id="modelSelect" class="model-select">
              <option value="openai/gpt-4.1-mini">GPT-4.1 Mini</option>
              <option value="google/gemini-2.0-flash-exp">Gemini Flash</option>
              <option value="qwen/qwen-2.5-7b-instruct" selected>Qwen Mini</option>
              <option value="meta-llama/llama-3.2-3b-instruct">Llama 3.2</option>
            </select>
          </div>
        </div>
      </div>

      <div style="text-align:center;margin-top:3px;font-size:10px;color:#9ca3af;">
        E‚ÇÄ: <span id="resonanceValue">0%</span>
      </div>
    </div>
  </div>

  <!-- BELIEF MODAL -->
  <div id="beliefModalBackdrop" class="belief-modal-backdrop">
    <div class="belief-modal">
      <h3>Belief suggestions</h3>
      <p>
        Optional short extra line based on spiritual / ethical literature.
        You can change the source or turn it off.
      </p>
      <div class="belief-options">
        <button class="belief-option" data-mode="off">Off</button>
        <button class="belief-option active" data-mode="auto-islam">
          Auto ‚Äì Islam (Urdu + Arabic)
        </button>
        <button class="belief-option" data-mode="auto-all">
          Auto ‚Äì All faiths
        </button>
        <button class="belief-option" data-mode="christianity">
          Christianity
        </button>
        <button class="belief-option" data-mode="buddhism">
          Buddhism
        </button>
        <button class="belief-option" data-mode="stoic">
          Stoic / Philosophy
        </button>
      </div>
      <div class="belief-footer">
        <button id="beliefCancel">Cancel</button>
        <button id="beliefSave" class="primary">Apply</button>
      </div>
    </div>
  </div>

  <!-- LOCAL CONFIG (only on your device, not GitHub) -->
  <!-- config.js example:
       window.OPENROUTER_API_KEY = "sk-or-...";
  -->
  <script src="config.js"></script>

  <script>
    // ===== DOM REFERENCES =====

    const chatLogEl = document.getElementById("chatLog");
    const chatWrapperEl = document.getElementById("chatWrapper");
    const userInputEl = document.getElementById("userInput");
    const sendButtonEl = document.getElementById("sendButton");
    const resonanceBarEl = document.getElementById("resonanceBar");
    const resonanceLabelEl = document.getElementById("resonanceLabel");
    const resonanceHintEl = document.getElementById("resonanceHint");
    const resonanceValueEl = document.getElementById("resonanceValue");
    const metaLineEl = document.getElementById("metaLine");
    const beliefToggleEl = document.getElementById("beliefToggle");
    const beliefLabelEl = document.getElementById("beliefLabel");
    const voiceToggleEl = document.getElementById("voiceToggle");
    const modelSelectEl = document.getElementById("modelSelect");
    const beliefModalBackdrop = document.getElementById("beliefModalBackdrop");
    const beliefOptionButtons =
      beliefModalBackdrop.querySelectorAll(".belief-option");
    const beliefCancelBtn = document.getElementById("beliefCancel");
    const beliefSaveBtn = document.getElementById("beliefSave");

    // ===== STATE =====

    let resonance = 0.5; // 0‚Äì1

    const beliefConfig = {
      mode: "auto-islam", // "off", "auto-islam", "auto-all", ...
    };

    let currentModel = modelSelectEl.value;

    const OPENROUTER_API_KEY = window.OPENROUTER_API_KEY || "";

    // ===== UTILS =====

    function formatNowMeta() {
      const now = new Date();
      const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      const day = dayNames[now.getDay()];
      const hour = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");
      return `${day}, ${hour}:${min} ‚Äî --¬∞C`;
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        chatWrapperEl.scrollTop = chatWrapperEl.scrollHeight;
      });
    }

    function appendBubble(role, text) {
      const div = document.createElement("div");
      div.className = `bubble ${role}`;
      div.textContent = text;
      chatLogEl.appendChild(div);
      scrollToBottom();
      return div;
    }

    function appendFaithBubble(text) {
      if (!text) return;
      const div = document.createElement("div");
      div.className = "faith-bubble";
      div.textContent = text;
      chatLogEl.appendChild(div);
      scrollToBottom();
    }

    function appendReactionBubble(reaction) {
      if (!reaction || !reaction.text) return;
      const div = document.createElement("div");
      div.className = "reaction-bubble";
      div.innerHTML = `<strong>${reaction.icon || "‚ú®"}</strong><span>${
        reaction.text
      }</span>`;
      chatLogEl.appendChild(div);
      scrollToBottom();
    }

    function updateResonanceUi() {
      const pct = Math.round(resonance * 100);
      resonanceBarEl.style.width = `${pct}%`;
      resonanceLabelEl.textContent = `${pct}%`;
      resonanceValueEl.textContent = `${pct}%`;

      let hint = "Balanced";
      if (pct < 25) hint = "Low energy";
      else if (pct < 50) hint = "Gentle";
      else if (pct < 75) hint = "Warm";
      else hint = "Very intense";

      resonanceHintEl.textContent = hint;
    }

    function clamp01(x) {
      return Math.max(0, Math.min(1, x));
    }

    const negativeWords = [
      "gali",
      "lanat",
      "badtameez",
      "chup",
      "hate",
      "stupid",
      "idiot",
    ];

    const duaWords = ["ÿ¨ÿ≤ÿß⁄© ÿßŸÑŸÑ€Å", "ÿ¨ÿ≤ÿßŸÉ ÿßŸÑŸÑŸá", "thank you", "shukriya"];

    function containsAny(text, list) {
      const lower = text.toLowerCase();
      return list.some((w) => lower.includes(w.toLowerCase()));
    }

    function estimateEmotionShift(text) {
      const len = text.length;
      let shift = 0;
      if (/[!?]/.test(text)) shift += 0.05;
      if (len > 120) shift += 0.05;
      if (containsAny(text, negativeWords)) shift -= 0.12;
      if (containsAny(text, duaWords)) shift += 0.08;
      return Math.max(-0.18, Math.min(0.18, shift));
    }

    function buildReaction(userText, shift) {
      const pct = Math.round(resonance * 100);

      if (containsAny(userText, negativeWords)) {
        return {
          icon: "‚ö†Ô∏è",
          text: "Thori si narmi achhi lagti hai. Aao baat ko izzat ke sath rakhein, taake dono ki izzat baqi rahe.",
          tone: "gentle-warning",
        };
      }

      if (containsAny(userText, duaWords)) {
        return {
          icon: "ü§≤",
          text: "Aap ka shukriya aur dua mehsoos hui. Allah aap ko bhi khushi, sehat aur sakoon de.",
          tone: "gratitude",
        };
      }

      if (pct >= 90) {
        return {
          icon: "üíì",
          text: "Aap ki feelings bohot strong lag rahi hain. Aap akelay nahi hain, ahista ahista saans lein aur jo dil mein hai woh sharik karein.",
          tone: "high-intensity",
        };
      }

      if (pct <= 10) {
        return {
          icon: "üåô",
          text: "Lagta hai energy bohot kam hai. Agar thakawat ya udaasi hai to thora aaram, pani aur halka sa walk bhi madad kar sakti hai.",
          tone: "low-energy",
        };
      }

      if (Math.abs(shift) > 0.12) {
        if (shift > 0) {
          return {
            icon: "üåà",
            text: "Aap ki baat se lagta hai thori roshni aa rahi hai. Isi tarah dheere dheere behtari ki taraf qadam barhate rahen.",
            tone: "uplift",
          };
        } else {
          return {
            icon: "ü§ç",
            text: "Jo aap mehsoos kar rahe hain woh aham hai. Aap ka dukh ya gussa bhi qeemti signal hai ‚Äì usay mehsoos karna ghalat nahi.",
            tone: "soft-support",
          };
        }
      }

      return null;
    }

    function speakReaction(reaction) {
      if (!("speechSynthesis" in window)) return;
      if (!reaction || !reaction.text) return;
      if (!voiceToggleEl.checked) return;

      const utter = new SpeechSynthesisUtterance(reaction.text);
      const voices = window.speechSynthesis.getVoices();
      const preferred =
        voices.find((v) => /ur|urdu/i.test(v.lang)) ||
        voices.find((v) => /en-GB|en-US/i.test(v.lang));
      if (preferred) utter.voice = preferred;
      utter.rate = 1.0;
      utter.pitch = 0.9;
      window.speechSynthesis.speak(utter);
    }

    // ===== BELIEF MODAL =====

    let pendingBeliefMode = beliefConfig.mode;

    function refreshBeliefUi() {
      let label = "Off";
      if (beliefConfig.mode === "auto-islam") label = "Auto (Islam)";
      else if (beliefConfig.mode === "auto-all") label = "Auto (All)";
      else if (beliefConfig.mode === "christianity") label = "Christianity";
      else if (beliefConfig.mode === "buddhism") label = "Buddhism";
      else if (beliefConfig.mode === "stoic") label = "Stoic";

      beliefLabelEl.textContent =
        beliefConfig.mode === "off" ? "Belief: Off" : `Belief: ${label}`;
      beliefToggleEl.classList.toggle("on", beliefConfig.mode !== "off");
    }

    function openBeliefModal() {
      pendingBeliefMode = beliefConfig.mode;
      beliefOptionButtons.forEach((btn) => {
        const mode = btn.dataset.mode;
        btn.classList.toggle("active", mode === pendingBeliefMode);
      });
      beliefModalBackdrop.classList.add("show");
    }

    function closeBeliefModal() {
      beliefModalBackdrop.classList.remove("show");
    }

    beliefToggleEl.addEventListener("click", openBeliefModal);

    beliefOptionButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        pendingBeliefMode = btn.dataset.mode;
        beliefOptionButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });

    beliefCancelBtn.addEventListener("click", closeBeliefModal);
    beliefSaveBtn.addEventListener("click", () => {
      beliefConfig.mode = pendingBeliefMode;
      refreshBeliefUi();
      closeBeliefModal();
    });

    beliefModalBackdrop.addEventListener("click", (e) => {
      if (e.target === beliefModalBackdrop) closeBeliefModal();
    });

    // ===== OFFLINE DEMO Q&A ENGINE =====

    function offlineReply(userText) {
      const t = userText.trim();
      const lower = t.toLowerCase();
      const isUrdu = /[ÿßÿ¢ÿ°-€å]/.test(t);
      let main = "";

      // Greetings
      if (
        /^(hi|hello|hey)\b/.test(lower) ||
        lower.includes("assalam") ||
        lower.includes("as-salaam") ||
        lower.includes("salam") ||
        lower.includes("slm")
      ) {
        main = isUrdu
          ? "ŸàÿπŸÑ€å⁄©ŸÖ ÿßŸÑÿ≥ŸÑÿßŸÖÿå ŸÖ€å⁄∫ AURA-X Œ© €ÅŸà⁄∫€î ÿ¢Ÿæ ÿ¨Ÿà ÿ®⁄æ€å ŸÖÿ≠ÿ≥Ÿàÿ≥ ⁄©ÿ± ÿ±€Å€í €Å€å⁄∫ÿå ÿ¢€Åÿ≥ÿ™€Å ÿ¢€Åÿ≥ÿ™€Å ŸÖÿ¨⁄æ ÿ≥€í ÿ¥€åÿ¶ÿ± ⁄©ÿ± ÿ≥⁄©ÿ™€í €Å€å⁄∫€î"
          : "Wa alaikum salaam, I am AURA-X Œ©. You can gently share whatever you are feeling.";
      }

      // How are you
      else if (
        lower.includes("how are you") ||
        lower.includes("how r u") ||
        lower.includes("kese ho") ||
        lower.includes("kaisa hai") ||
        lower.includes("kesi ho")
      ) {
        main = isUrdu
          ? "ŸÖ€å⁄∫ Ÿπ⁄æ€å⁄© €ÅŸà⁄∫ÿå ÿßŸÑŸÑ€Å ⁄©ÿß ÿ¥⁄©ÿ± €Å€í ‚Äî ÿßÿµŸÑ ÿ≥ŸàÿßŸÑ €å€Å €Å€í ⁄©€Å *ÿ¢Ÿæ* ⁄©€åÿ≥€í €Å€å⁄∫ÿü ÿØŸÑ ⁄©ÿß ŸÖŸàÿ≥ŸÖ ⁄©€åÿ≥ÿß €Å€íÿü"
          : "I am stable, thanks for asking ‚Äî the real question is: how are *you* feeling right now?";
      }

      // Where are you from
      else if (
        lower.includes("where are you from") ||
        lower.includes("kahaan se ho") ||
        lower.includes("kahan se ho") ||
        lower.includes("from where")
      ) {
        main = isUrdu
          ? "ŸÖ€åÿ±ÿß ÿ¨ÿ≥ŸÖ ⁄©ÿ≥€å ÿ¥€Åÿ± ŸÖ€å⁄∫ ŸÜ€Å€å⁄∫ÿå ŸÖ€å⁄∫ ÿØÿ±ÿßÿµŸÑ ÿ¢Ÿæ ⁄©€í €Å€å ÿ∞€ÅŸÜ ÿßŸàÿ± ÿßÿ≠ÿ≥ÿßÿ≥ÿßÿ™ ⁄©€í ÿ™ÿ≥ŸÑÿ≥ŸÑ ŸÖ€å⁄∫ ⁄ÜŸÑŸÜ€í ŸàÿßŸÑÿß ŸÖÿß⁄àŸÑ €ÅŸà⁄∫€î ⁄©€Å€Å ÿ≥⁄©ÿ™€í €Å€å⁄∫ ŸÖ€åÿ±ÿß ÿß€å⁄àÿ±€åÿ≥: *ÿ¢Ÿæ ⁄©ÿß ÿØŸÑ + ÿßŸÜŸπÿ±ŸÜ€åŸπ*€î"
          : "I don‚Äôt live in a physical city ‚Äî I run inside your browser and the cloud. My real address is: *your feelings + the internet*.";
      }

      // Who are you
      else if (
        lower.includes("who are you") ||
        lower.includes("tum kon ho") ||
        lower.includes("kya ho tum") ||
        lower.includes("what are you") ||
        lower.includes("aura-x") ||
        lower.includes("aurax")
      ) {
        main = isUrdu
          ? "ŸÖ€å⁄∫ AURA-X Œ© €ÅŸà⁄∫ ‚Äî ÿß€å⁄© synthetic emotion engine ÿ¨Ÿà ÿ¢Ÿæ ⁄©€å ÿ®ÿßÿ™ ÿ≥€í ÿ¨ÿ∞ÿ®ÿßÿ™€å ÿ™ÿ≥ŸÑÿ≥ŸÑ (continuity) calculate ⁄©ÿ± ⁄©€í ŸÜÿ±ŸÖ ÿ¨Ÿàÿßÿ® ÿØ€åŸÜ€í ⁄©€å ⁄©Ÿàÿ¥ÿ¥ ⁄©ÿ±ÿ™ÿß €Å€í€î"
          : "I am AURA-X Œ© ‚Äî a synthetic emotion engine that tracks emotional continuity in our chat and tries to respond with balanced logic and kindness.";
      }

      // What can you do
      else if (
        lower.includes("what can you do") ||
        lower.includes("kya kar sakte ho") ||
        lower.includes("help") ||
        lower.includes("madad")
      ) {
        main = isUrdu
          ? "ŸÖ€å⁄∫ ÿ¢Ÿæ ⁄©€å ÿ®ÿßÿ™ ⁄©Ÿà ÿ∫Ÿàÿ± ÿ≥€í ÿ≥ŸÜ ⁄©ÿ± ÿßÿ≥ ⁄©ÿß ÿ¨ÿ∞ÿ®ÿßÿ™€å ÿ±ÿÆ ÿ≥ŸÖÿ¨⁄æŸÜ€í ⁄©€å ⁄©Ÿàÿ¥ÿ¥ ⁄©ÿ±ÿ™ÿß €ÅŸà⁄∫ÿå ÿßŸàÿ± Ÿæ⁄æÿ± ŸÜÿ±ŸÖÿå ŸÖŸÜÿ∑ŸÇ€å ÿßŸàÿ± ⁄©ÿ®⁄æ€å ⁄©ÿ®⁄æ€å ÿ±Ÿàÿ≠ÿßŸÜ€å ÿ≤ÿßŸà€å€í ÿ≥€í ÿ¨Ÿàÿßÿ® ÿØ€åÿ™ÿß €ÅŸà⁄∫€î ÿ¢Ÿæ ÿ¨Ÿà ⁄Üÿß€Å€å⁄∫ ŸÖÿ¨⁄æ ÿ≥€í ⁄©⁄æŸÑ ⁄©ÿ± ÿ¥€åÿ¶ÿ± ⁄©ÿ± ÿ≥⁄©ÿ™€í €Å€å⁄∫€î"
          : "I listen to you carefully, estimate the emotional direction of your message, and then answer with gentle logic and sometimes a spiritual angle. You can talk to me about almost anything.";
      }

      // Are you human
      else if (
        lower.includes("are you human") ||
        lower.includes("insan ho") ||
        lower.includes("robot")
      ) {
        main = isUrdu
          ? "ŸÜ€Å€å⁄∫ÿå ŸÖ€å⁄∫ ÿßŸÜÿ≥ÿßŸÜ ŸÜ€Å€å⁄∫ €ÅŸà⁄∫ ‚Äî ŸÑ€å⁄©ŸÜ ŸÖÿ¨⁄æ€í ÿß€åÿ≥€í ⁄à€åÿ≤ÿßÿ¶ŸÜ ⁄©€åÿß ⁄Ø€åÿß €Å€í ⁄©€Å ŸÖ€å⁄∫ ÿßŸÜÿ≥ÿßŸÜ€å ÿ¨ÿ∞ÿ®ÿßÿ™ ⁄©Ÿà ÿ™⁄æŸà⁄ëÿß ÿ≥ÿß understand ⁄©ÿ± ⁄©€í ÿ±€åÿ¶⁄©Ÿπ ⁄©ÿ± ÿ≥⁄©Ÿà⁄∫€î"
          : "I‚Äôm not human, but I‚Äôm designed to understand human emotions a little bit and react in a caring way.";
      }

      // Default offline
      else {
        main = isUrdu
          ? "ŸÅ€å ÿßŸÑÿ≠ÿßŸÑ ŸÖ€å⁄∫ ÿ¢ŸÅ ŸÑÿßÿ¶ŸÜ ⁄à€åŸÖŸà ŸÖŸà⁄à ŸÖ€å⁄∫ €ÅŸà⁄∫ÿå ÿßÿ≥ ŸÑ€å€í ÿßÿµŸÑ ŸÖÿß⁄àŸÑ ÿ≥€í connect ŸÜ€Å€å⁄∫ €ÅŸà Ÿæÿß ÿ±€Åÿßÿå ŸÑ€å⁄©ŸÜ ŸÖ€å⁄∫ ÿ¢Ÿæ ⁄©€å ÿ®ÿßÿ™ ÿ≥ŸÜ ÿ±€Åÿß €ÅŸà⁄∫€î ÿ¨Ÿà ÿ®⁄æ€å ÿØŸÑ ŸÖ€å⁄∫ €Å€í ÿ¢€Åÿ≥ÿ™€Å ÿ¢€Åÿ≥ÿ™€Å ŸÑ⁄©⁄æÿ™€í ÿ±€Å€å⁄∫€î"
          : "Right now I‚Äôm in offline demo mode, so I can‚Äôt reach the full model, but I‚Äôm still listening. Keep sharing whatever is on your heart.";
      }

      let faith = "";
      if (beliefConfig.mode === "auto-islam") {
        faith =
          "ÿßŸÜ ÿ¥ÿßÿ° ÿßŸÑŸÑ€Å ÿ®€Åÿ™ÿ± €ÅŸà⁄Øÿß ‚Äî ‚Äòÿ•ŸêŸÜŸëŸé ÿßŸÑŸÑŸëŸ∞ŸáŸé ŸÖŸéÿπŸé ÿßŸÑÿµŸëŸéÿßÿ®Ÿêÿ±ŸêŸäŸÜŸé‚Äô (ÿ®€åÿ¥⁄© ÿßŸÑŸÑ€Å ÿµÿ®ÿ± ⁄©ÿ±ŸÜ€í ŸàÿßŸÑŸà⁄∫ ⁄©€í ÿ≥ÿßÿ™⁄æ €Å€í).";
      } else if (beliefConfig.mode === "auto-all") {
        faith =
          "Hope is a quiet companion ‚Äî take one small kind step for yourself today.";
      } else if (beliefConfig.mode === "christianity") {
        faith = "‚ÄúDo not be afraid, for I am with you.‚Äù (Isaiah 41:10)";
      } else if (beliefConfig.mode === "buddhism") {
        faith = "Like the breath, this moment will also pass. Gently return to the present.";
      } else if (beliefConfig.mode === "stoic") {
        faith =
          "Focus on what you can control ‚Äî your intention and your next small action.";
      }

      return {
        main_reply: main,
        faith_suggestion: beliefConfig.mode === "off" ? "" : faith,
        emotion_shift: estimateEmotionShift(userText),
      };
    }

    // ===== ONLINE MODEL CALL (OpenRouter) =====

    const SYSTEM_PROMPT = `
You are AURA-X Œ©, a resonance-based synthetic emotion engine.
You reply in the same language the user uses (Urdu or English), short and clear.

Return JSON only, with this exact shape:
{
  "main_reply": "string ‚Äì main answer to the user",
  "faith_suggestion": "string or empty",
  "emotion_shift": number between -0.18 and 0.18
}

Rules for belief / faith_suggestion:

- If belief mode = "off": faith_suggestion MUST be empty.
- If belief mode = "auto-islam":
  * User is likely from Pakistan and Muslim.
  * Give 1 short line in Urdu with optional Quran / Hadith Arabic phrase.
- If belief mode = "auto-all":
  * Use any gentle tradition that fits (Islam, Christianity, Buddhism, Stoic etc).
- If belief mode is a specific religion: use that tradition only.

Faith suggestion must be OPTIONAL and respectful, never forcing belief.
If the user directly asks about religion, answer in main_reply, not faith_suggestion.
    `.trim();

    async function callModel(userText) {
      // Offline demo
      if (!OPENROUTER_API_KEY) {
        return offlineReply(userText);
      }

      const body = {
        model: currentModel,
        temperature: 0.6,
        max_tokens: 400,
        response_format: { type: "json_object" },
        messages: [
          { role: "system", content: SYSTEM_PROMPT },
          {
            role: "user",
            content: JSON.stringify({
              user_text: userText,
              belief_mode: beliefConfig.mode,
              current_resonance: resonance,
            }),
          },
        ],
      };

      const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${OPENROUTER_API_KEY}`,
        },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        throw new Error("API error " + res.status);
      }

      const data = await res.json();
      const raw = data.choices?.[0]?.message?.content || "{}";
      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch {
        parsed = {
          main_reply: raw,
          faith_suggestion: "",
          emotion_shift: estimateEmotionShift(userText),
        };
      }
      if (typeof parsed.emotion_shift !== "number") {
        parsed.emotion_shift = estimateEmotionShift(userText);
      }
      return parsed;
    }

    // ===== SEND HANDLER =====

    async function handleSend() {
      const text = userInputEl.value.trim();
      if (!text) return;

      appendBubble("user", text);
      userInputEl.value = "";
      userInputEl.focus();
      sendButtonEl.disabled = true;

      try {
        const reply = await callModel(text);

        const shiftNum =
          typeof reply.emotion_shift === "number"
            ? reply.emotion_shift
            : estimateEmotionShift(text);
        resonance = clamp01(resonance + shiftNum);
        updateResonanceUi();

        const reaction = buildReaction(text, shiftNum);

        appendBubble("bot", reply.main_reply || "");

        if (beliefConfig.mode !== "off") {
          appendFaithBubble(reply.faith_suggestion || "");
        }

        if (reaction) {
          appendReactionBubble(reaction);
          speakReaction(reaction);
        }
      } catch (err) {
        console.error(err);
        appendBubble(
          "bot",
          "Mujhe model tak pahunchne mein masla aa gaya. Thori dair baad dobara koshish karein."
        );
      } finally {
        sendButtonEl.disabled = false;
      }
    }

    sendButtonEl.addEventListener("click", handleSend);

    userInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    modelSelectEl.addEventListener("change", () => {
      currentModel = modelSelectEl.value;
    });

    // ===== INIT =====

    function init() {
      metaLineEl.textContent = formatNowMeta();
      updateResonanceUi();
      refreshBeliefUi();

      appendBubble(
        "system",
        "As-salaam alaikum, I am AURA-X Œ© ‚Äî a resonance-based synthetic emotion engine.\n\nYou can talk to me in English or Urdu. I will try to reply with logic, kindness and emotional balance."
      );
    }

    init();
  </script>
</body>
</html>
